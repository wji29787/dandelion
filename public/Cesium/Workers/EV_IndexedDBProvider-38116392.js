define(["exports","./when-b43ff45e"],function(e,h){"use strict";function o(e){this._windowIDB=h.defaultValue(e,void 0),this._iDB=void 0}Object.defineProperties(o.prototype,{iDB:{get:function(){return this._iDB}}}),o.prototype.createIDB=function(e,o,i,r){var n,t;h.defined(this._windowIDB)&&((t=(n=this)._windowIDB.open(e,o)).onupgradeneeded=function(e){for(var o,n=e.target.result,t=0;t<i.length;t++){n.objectStoreNames.contains(i[t])||(o=n.createObjectStore(i[t],{keyPath:"key",autoIncrement:!0}),"model"===i[t]?o.createIndex("name","name",{unique:!1}):o.createIndex("name","name",{unique:!0}))}h.defined(r)&&r("upgradeneeded")},t.onsuccess=function(e){var o=e.target.result;n._iDB=o,h.defined(r)&&r("success")},t.onerror=function(e){h.defined(r)&&r("error"),alert("Why didn't you allow my web app to use IndexedDB?!")})},o.closeIDB=function(e,o){h.defined(this._iDB)&&this._iDB.name===e&&this._iDB.version===o&&this._iDB.close()};var f=67108864;o.prototype.saveModelArrayBuffer=function(e,o,n,t,i){if(h.defined(this._iDB)&&this._iDB.name===e&&this._iDB.version===o)if(this._iDB.objectStoreNames.contains(n))for(var r=this._iDB.transaction([n],"readwrite").objectStore(n),a=0,s=0,c=Math.ceil(i.byteLength/f),l=0;l<c;l++){s+=f;var u={name:t,chunkId:l,data:i.slice(a,s)},d=r.put(u),a=s;d.onsuccess=function(e){console.log("arraybuffer writed success")},d.onerror=function(e){console.log("arraybuffer writed error")}}else console.log(n+":该表不存在!");else console.log(e+":保存数据有问题!")},o.prototype.downloadModelArrayBuffer=function(e,o,n,t,i,s,c){var r,l,u,d,f,a;h.defined(this._iDB)&&this._iDB.name===e&&this._iDB.version===o?this._iDB.objectStoreNames.contains(n)?(r=this._iDB.transaction([n],"readonly").objectStore(n),l=i,u=t,d=new Array,f=0,(a=r.index("name").openCursor(IDBKeyRange.only(t))).onsuccess=function(e){var o=e.target.result;if(o){console.log(o.key);var n,t=o.value;t.name===u&&(n=new Uint8Array(t.data),d.push(n),f+=n.byteLength),o.continue()}else{for(var i=0,r=new Uint8Array(f),a=0;a<d.length;a++)r.set(d[a],i),i+=d[a].length;0<d.length?c(l,r):s(l)}},a.onerror=function(e){console.log("索引查询失败!")}):s(i):console.log(e+":下载数据有问题!")},o.prototype.saveTerrainData=function(e,o,n,t){var i,r,a;h.defined(this._iDB)&&this._iDB.name===e&&this._iDB.version===o?this._iDB.objectStoreNames.contains(n)?(i=this._iDB.transaction([n],"readwrite").objectStore(n),r={name:t.keyName,level:t.level,x:t.x,y:t.y,data:t.data,upsample:h.defaultValue(t.upsample,!1)},(a=i.put(r)).onsuccess=function(e){},a.onerror=function(e){}):console.log(n+":该表不存在!"):console.log(e+":保存数据有问题!")},o.prototype.downloadTerrainData=function(e,o,n,t,i,r){var a,s,c;h.defined(this._iDB)&&this._iDB.name===e&&this._iDB.version===o?this._iDB.objectStoreNames.contains(n)?(a=this._iDB.transaction([n],"readonly").objectStore(n),s=t,(c=a.index("name").openCursor(IDBKeyRange.only(s.keyName))).onsuccess=function(e){var o=e.target.result;o?(t.level=o.value.level,t.x=o.value.x,t.y=o.value.y,t.upsample=o.value.upsample,r(t,o.value.data)):i(t)},c.onerror=function(e){console.log("索引查询失败!")}):i(t):console.log(e+":下载数据有问题!")},o.prototype.save3DTileArrayBuffer=function(e,o,n,t){var i,r,a;h.defined(this._iDB)&&this._iDB.name===e&&this._iDB.version===o?this._iDB.objectStoreNames.contains(n)?(i=this._iDB.transaction([n],"readwrite").objectStore(n),r={name:t.keyName,meshPrimitives:t.meshPrimitives,data:t.data},(a=i.put(r)).onsuccess=function(e){},a.onerror=function(e){}):console.log(n+":该表不存在!"):console.log(e+":保存数据有问题!")},o.prototype.download3DTileArrayBuffer=function(e,o,n,t,i,r){var a,s,c,l;h.defined(this._iDB)&&this._iDB.name===e&&this._iDB.version===o?this._iDB.objectStoreNames.contains(n)?(a=this._iDB.transaction([n],"readonly").objectStore(n),c=(s=t).keyName,(l=a.index("name").openCursor(IDBKeyRange.only(c))).onsuccess=function(e){var o=e.target.result;o?(s.meshPrimitives=o.value.meshPrimitives,r(s,o.value.data)):i(s)},l.onerror=function(e){console.log("索引查询失败!")}):console.log(n+":数据库中不存在该表名!"):console.log(e+":下载数据有问题!")},e.EV_IndexedDBProvider=o});
