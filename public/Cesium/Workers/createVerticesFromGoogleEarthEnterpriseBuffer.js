define(["./when-b43ff45e","./Check-d404a0fe","./Math-336da716","./Cartesian3-2b5b9afe","./Cartesian2-577f67dc","./Transforms-18f02e2b","./RuntimeError-bf10f3d5","./WebGLConstants-56de22c0","./ComponentDatatype-8956ad9a","./JulianDate-53cdb307","./RequestType-beb1291d","./AttributeCompression-c335d1ea","./IntersectionTests-8ff35218","./Plane-5b30f0ff","./WebMercatorProjection-8f9f9d73","./createTaskProcessorWorker","./EllipsoidTangentPlane-51ba1d6b","./OrientedBoundingBox-c229c76c","./TerrainEncoding-3a09cff0"],function(We,e,Fe,Oe,Ye,ke,Ue,t,i,a,n,r,o,s,Ve,u,He,Le,De){"use strict";var Ge=Uint16Array.BYTES_PER_ELEMENT,je=Int32Array.BYTES_PER_ELEMENT,ze=Uint32Array.BYTES_PER_ELEMENT,qe=Float32Array.BYTES_PER_ELEMENT,Je=Float64Array.BYTES_PER_ELEMENT;function Ke(e,t,i){i=We.defaultValue(i,Fe.CesiumMath);for(var a=e.length,n=0;n<a;++n)if(i.equalsEpsilon(e[n],t,Fe.CesiumMath.EPSILON12))return n;return-1}var Qe=new Ye.Cartographic,Xe=new Oe.Cartesian3,Ze=new Oe.Cartesian3,$e=new Oe.Cartesian3,et=new ke.Matrix4;function tt(e,t,i,a,n,r,o,s,u,h){for(var c=o.length,d=0;d<c;++d){var l=o[d],g=l.cartographic,m=l.index,p=e.length,f=g.longitude,I=g.latitude,I=Fe.CesiumMath.clamp(I,-Fe.CesiumMath.PI_OVER_TWO,Fe.CesiumMath.PI_OVER_TWO),v=g.height-r.skirtHeight;r.hMin=Math.min(r.hMin,v),Ye.Cartographic.fromRadians(f,I,v,Qe),u&&(Qe.longitude+=s),u?d===c-1?Qe.latitude+=h:0===d&&(Qe.latitude-=h):Qe.latitude+=s;var E=r.ellipsoid.cartographicToCartesian(Qe);e.push(E),t.push(v),i.push(Ye.Cartesian2.clone(i[m])),0<a.length&&a.push(a[m]),ke.Matrix4.multiplyByPoint(r.toENU,E,Xe);var T=r.minimum,C=r.maximum;Oe.Cartesian3.minimumByComponent(Xe,T,T),Oe.Cartesian3.maximumByComponent(Xe,C,C);var M,N=r.lastBorderPoint;We.defined(N)&&(M=N.index,n.push(M,p-1,p,p,m,M)),r.lastBorderPoint=l}}return u(function(e,t){e.ellipsoid=Ye.Ellipsoid.clone(e.ellipsoid),e.rectangle=Ye.Rectangle.clone(e.rectangle);var i=function(e,t,i,a,n,r,o,s,u,h){var c,d,l,g,m,p;p=We.defined(a)?(c=a.west,d=a.south,l=a.east,g=a.north,m=a.width,a.height):(c=Fe.CesiumMath.toRadians(n.west),d=Fe.CesiumMath.toRadians(n.south),l=Fe.CesiumMath.toRadians(n.east),g=Fe.CesiumMath.toRadians(n.north),m=Fe.CesiumMath.toRadians(a.width),Fe.CesiumMath.toRadians(a.height));var f,I,v=[d,g],E=[c,l],T=ke.Transforms.eastNorthUpToFixedFrame(t,i),C=ke.Matrix4.inverseTransformation(T,et);s&&(f=Ve.WebMercatorProjection.geodeticLatitudeToMercatorAngle(d),I=1/(Ve.WebMercatorProjection.geodeticLatitudeToMercatorAngle(g)-f));var M=new DataView(e),N=Number.POSITIVE_INFINITY,x=Number.NEGATIVE_INFINITY,b=Ze;b.x=Number.POSITIVE_INFINITY,b.y=Number.POSITIVE_INFINITY,b.z=Number.POSITIVE_INFINITY;var S=$e;S.x=Number.NEGATIVE_INFINITY,S.y=Number.NEGATIVE_INFINITY,S.z=Number.NEGATIVE_INFINITY;var w,P,B=0,y=0,R=0;for(P=0;P<4;++P){var A=B;w=M.getUint32(A,!0),A+=ze;var _=Fe.CesiumMath.toRadians(180*M.getFloat64(A,!0));A+=Je,-1===Ke(E,_)&&E.push(_);var W=Fe.CesiumMath.toRadians(180*M.getFloat64(A,!0));A+=Je,-1===Ke(v,W)&&v.push(W),A+=2*Je;var F=M.getInt32(A,!0);A+=je,y+=F,F=M.getInt32(A,!0),R+=3*F,B+=w+ze}var O=[],Y=[],k=new Array(y),U=new Array(y),V=new Array(y),H=s?new Array(y):[],L=new Array(R),D=[],G=[],j=[],z=[],q=0,J=0;for(P=B=0;P<4;++P){w=M.getUint32(B,!0);var K=B+=ze,Q=Fe.CesiumMath.toRadians(180*M.getFloat64(B,!0));B+=Je;var X=Fe.CesiumMath.toRadians(180*M.getFloat64(B,!0));B+=Je;var Z=Fe.CesiumMath.toRadians(180*M.getFloat64(B,!0)),$=.5*Z;B+=Je;var ee=Fe.CesiumMath.toRadians(180*M.getFloat64(B,!0)),te=.5*ee;B+=Je;var ie=M.getInt32(B,!0);B+=je;var ae=M.getInt32(B,!0);B+=je,B+=je;for(var ne=new Array(ie),re=0;re<ie;++re){var oe=Q+M.getUint8(B++)*Z;Qe.longitude=oe;var se=X+M.getUint8(B++)*ee;Qe.latitude=se;var ue=M.getFloat32(B,!0);if(B+=qe,0!==ue&&ue<h&&(ue*=-Math.pow(2,u)),ue*=6371010*r,Qe.height=ue,-1!==Ke(E,oe)||-1!==Ke(v,se)){var he=Ke(O,Qe,Ye.Cartographic);if(-1!==he){ne[re]=Y[he];continue}O.push(Ye.Cartographic.clone(Qe)),Y.push(q)}ne[re]=q,Math.abs(oe-c)<$?D.push({index:q,cartographic:Ye.Cartographic.clone(Qe)}):Math.abs(oe-l)<$?j.push({index:q,cartographic:Ye.Cartographic.clone(Qe)}):Math.abs(se-d)<te?G.push({index:q,cartographic:Ye.Cartographic.clone(Qe)}):Math.abs(se-g)<te&&z.push({index:q,cartographic:Ye.Cartographic.clone(Qe)}),N=Math.min(ue,N),x=Math.max(ue,x),V[q]=ue;var ce=i.cartographicToCartesian(Qe);k[q]=ce,s&&(H[q]=(Ve.WebMercatorProjection.geodeticLatitudeToMercatorAngle(se)-f)*I),ke.Matrix4.multiplyByPoint(C,ce,Xe),Oe.Cartesian3.minimumByComponent(Xe,b,b),Oe.Cartesian3.maximumByComponent(Xe,S,S);var de=(oe-c)/(l-c);de=Fe.CesiumMath.clamp(de,0,1);var le=(se-d)/(g-d);le=Fe.CesiumMath.clamp(le,0,1),U[q]=new Ye.Cartesian2(de,le),++q}for(var ge=3*ae,me=0;me<ge;++me,++J)L[J]=ne[M.getUint16(B,!0)],B+=Ge;if(w!==B-K)throw new Ue.RuntimeError("Invalid terrain tile.")}k.length=q,U.length=q,V.length=q,s&&(H.length=q);var pe=q,fe=J,Ie={hMin:N,lastBorderPoint:void 0,skirtHeight:o,toENU:C,ellipsoid:i,minimum:b,maximum:S};D.sort(function(e,t){return t.cartographic.latitude-e.cartographic.latitude}),G.sort(function(e,t){return e.cartographic.longitude-t.cartographic.longitude}),j.sort(function(e,t){return e.cartographic.latitude-t.cartographic.latitude}),z.sort(function(e,t){return t.cartographic.longitude-e.cartographic.longitude});var ve=1e-5;{var Ee,Te,Ce;tt(k,V,U,H,L,Ie,D,-ve*m,!0,-ve*p),tt(k,V,U,H,L,Ie,G,-ve*p,!1),tt(k,V,U,H,L,Ie,j,ve*m,!0,ve*p),tt(k,V,U,H,L,Ie,z,ve*p,!1),0<D.length&&0<z.length&&(Ee=D[0].index,Te=z[z.length-1].index,Ce=k.length-1,L.push(Te,Ce,pe,pe,Ee,Te))}y=k.length;var Me,Ne=ke.BoundingSphere.fromPoints(k);We.defined(a)&&(Me=Le.OrientedBoundingBox.fromRectangle(a,N,x,i));for(var xe=new De.EllipsoidalOccluder(i).computeHorizonCullingPointPossiblyUnderEllipsoid(t,k,N),be=new He.AxisAlignedBoundingBox(b,S,t),Se=new De.TerrainEncoding(be,Ie.hMin,x,T,!1,s),we=new Float32Array(y*Se.getStride()),Pe=0,Be=0;Be<y;++Be)Pe=Se.encode(we,Pe,k[Be],U[Be],V[Be],void 0,H[Be]);var ye=D.map(function(e){return e.index}).reverse(),Re=G.map(function(e){return e.index}).reverse(),Ae=j.map(function(e){return e.index}).reverse(),_e=z.map(function(e){return e.index}).reverse();return Re.unshift(Ae[Ae.length-1]),Re.push(ye[0]),_e.unshift(ye[ye.length-1]),_e.push(Ae[0]),{vertices:we,indices:new Uint16Array(L),maximumHeight:x,minimumHeight:N,encoding:Se,boundingSphere3D:Ne,orientedBoundingBox:Me,occludeePointInScaledSpace:xe,vertexCountWithoutSkirts:pe,indexCountWithoutSkirts:fe,westIndicesSouthToNorth:ye,southIndicesEastToWest:Re,eastIndicesNorthToSouth:Ae,northIndicesWestToEast:_e}}(e.buffer,e.relativeToCenter,e.ellipsoid,e.rectangle,e.nativeRectangle,e.exaggeration,e.skirtHeight,e.includeWebMercatorT,e.negativeAltitudeExponentBias,e.negativeElevationThreshold),a=i.vertices;t.push(a.buffer);var n=i.indices;return t.push(n.buffer),{vertices:a.buffer,indices:n.buffer,numberOfAttributes:i.encoding.getStride(),minimumHeight:i.minimumHeight,maximumHeight:i.maximumHeight,boundingSphere3D:i.boundingSphere3D,orientedBoundingBox:i.orientedBoundingBox,occludeePointInScaledSpace:i.occludeePointInScaledSpace,encoding:i.encoding,vertexCountWithoutSkirts:i.vertexCountWithoutSkirts,indexCountWithoutSkirts:i.indexCountWithoutSkirts,westIndicesSouthToNorth:i.westIndicesSouthToNorth,southIndicesEastToWest:i.southIndicesEastToWest,eastIndicesNorthToSouth:i.eastIndicesNorthToSouth,northIndicesWestToEast:i.northIndicesWestToEast}})});
