define(["exports","./when-b43ff45e","./Math-336da716","./Cartesian3-2b5b9afe","./Cartesian2-577f67dc","./Transforms-18f02e2b","./PolylineVolumeGeometryLibrary-8765c50e","./EllipsoidGeodesic-47c65dee","./PolylinePipeline-76ef9442"],function(a,U,V,_,I,p,Q,H,j){"use strict";var q=Object.freeze({NONE:0,CLAMP_TO_GROUND:1,RELATIVE_TO_GROUND:2}),e={},W=new _.Cartesian3,d=new _.Cartesian3,h=new _.Cartesian3,m=new _.Cartesian3,k=[new _.Cartesian3,new _.Cartesian3],F=new _.Cartesian3,J=new _.Cartesian3,K=new _.Cartesian3,X=new _.Cartesian3,Y=new _.Cartesian3,Z=new _.Cartesian3,$=new _.Cartesian3,aa=new _.Cartesian3,ea=new _.Cartesian3,ra=new _.Cartesian3,y=new p.Quaternion,g=new p.Matrix3;function ta(a,e,r,t,n){var i,s=_.Cartesian3.angleBetween(_.Cartesian3.subtract(e,a,W),_.Cartesian3.subtract(r,a,d)),o=t===Q.CornerType.BEVELED?1:Math.ceil(s/V.CesiumMath.toRadians(5))+1,l=3*o,C=new Array(l);C[l-3]=r.x,C[l-2]=r.y,C[l-1]=r.z,i=n?p.Matrix3.fromQuaternion(p.Quaternion.fromAxisAngle(_.Cartesian3.negate(a,W),s/o,y),g):p.Matrix3.fromQuaternion(p.Quaternion.fromAxisAngle(a,s/o,y),g);var u=0;e=_.Cartesian3.clone(e,W);for(var c=0;c<o;c++)e=p.Matrix3.multiplyByVector(i,e,e),C[u++]=e.x,C[u++]=e.y,C[u++]=e.z;return C}function na(a,e,r,t){var n=W;return[(n=(t||(e=_.Cartesian3.negate(e,e)),_.Cartesian3.add(a,e,n))).x,n.y,n.z,r.x,r.y,r.z]}function ia(a,e,r,t){for(var n=new Array(a.length),i=new Array(a.length),s=_.Cartesian3.multiplyByScalar(e,r,W),o=_.Cartesian3.negate(s,d),l=0,C=a.length-1,u=0;u<a.length;u+=3){var c=_.Cartesian3.fromArray(a,u,h),p=_.Cartesian3.add(c,o,m);n[l++]=p.x,n[l++]=p.y,n[l++]=p.z;var y=_.Cartesian3.add(c,s,m);i[C--]=y.z,i[C--]=y.y,i[C--]=y.x}return t.push(n,i),t}function sa(a,e){for(var r=a[0],t=a[1],n=a[2],i=new _.Cartesian3,s=new _.Cartesian3,o=new _.Cartesian3,l=1/(e+1),C=0,u=new Array(e),c=0;c<e;c++){var p=(1-(C=(c+1)*l))*(1-C),y=2*C*(1-C),d=C*C;_.Cartesian3.multiplyByScalar(r,p,i),_.Cartesian3.multiplyByScalar(t,y,s),_.Cartesian3.multiplyByScalar(n,d,o),_.Cartesian3.add(i,s,s),u[c]=_.Cartesian3.add(s,o,new _.Cartesian3)}return u}e.addAttribute=function(a,e,r,t){var n=e.x,i=e.y,s=e.z;U.defined(r)&&(a[r]=n,a[r+1]=i,a[r+2]=s),U.defined(t)&&(a[t]=s,a[t-1]=i,a[t-2]=n)};var oa=new _.Cartesian3,la=new _.Cartesian3;e.computePositions=function(a){var e,r=a.granularity,t=a.positions,n=a.ellipsoid,i=a.width/2,s=a.cornerType,o=a.saveAttributes,l=F,C=J,u=K,c=X,p=Y,y=Z,d=$,h=aa,m=ea,g=ra,f=[],w=o?[]:void 0,v=o?[]:void 0,z=t[0],E=t[1],C=_.Cartesian3.normalize(_.Cartesian3.subtract(E,z,C),C),l=n.geodeticSurfaceNormal(z,l),c=_.Cartesian3.normalize(_.Cartesian3.cross(l,C,c),c);o&&(w.push(c.x,c.y,c.z),v.push(l.x,l.y,l.z)),d=_.Cartesian3.clone(z,d),z=E,u=_.Cartesian3.negate(C,u);for(var S,b,B,P,x,N,A,T,D=[],O=t.length,M=1;M<O-1;M++){l=n.geodeticSurfaceNormal(z,l),E=t[M+1],C=_.Cartesian3.normalize(_.Cartesian3.subtract(E,z,C),C),p=_.Cartesian3.normalize(_.Cartesian3.add(C,u,p),p);var R=_.Cartesian3.multiplyByScalar(l,_.Cartesian3.dot(C,l),oa);_.Cartesian3.subtract(C,R,R),_.Cartesian3.normalize(R,R);var L,G,U=_.Cartesian3.multiplyByScalar(l,_.Cartesian3.dot(u,l),la);_.Cartesian3.subtract(u,U,U),_.Cartesian3.normalize(U,U),V.CesiumMath.equalsEpsilon(Math.abs(_.Cartesian3.dot(R,U)),1,V.CesiumMath.EPSILON7)||(L=i/_.Cartesian3.magnitude(_.Cartesian3.cross(p,u,W)),p=_.Cartesian3.multiplyByScalar(p,L,p),(G=Q.PolylineVolumeGeometryLibrary.angleIsGreaterThanPi(C,u,z,n))?(h=_.Cartesian3.add(z,p,h),_.Cartesian3.add(h,_.Cartesian3.multiplyByScalar(c,i,g),g),m=_.Cartesian3.add(h,_.Cartesian3.multiplyByScalar(c,2*i,m),m),k[0]=_.Cartesian3.clone(d,k[0]),k[1]=_.Cartesian3.clone(g,k[1]),f=ia(j.PolylinePipeline.generateArc({positions:k,granularity:r,ellipsoid:n}),c,i,f),o&&(w.push(c.x,c.y,c.z),v.push(l.x,l.y,l.z)),y=_.Cartesian3.clone(m,y),c=_.Cartesian3.normalize(_.Cartesian3.cross(l,C,c),c),m=_.Cartesian3.add(h,_.Cartesian3.multiplyByScalar(c,2*i,m),m),d=_.Cartesian3.add(h,_.Cartesian3.multiplyByScalar(c,i,d),d),s===Q.CornerType.ROUNDED||s===Q.CornerType.BEVELED?D.push({leftPositions:ta(h,y,m,s,G)}):D.push({leftPositions:na(z,_.Cartesian3.negate(p,p),m,G)})):(m=_.Cartesian3.add(z,p,m),g=_.Cartesian3.add(m,_.Cartesian3.negate(_.Cartesian3.multiplyByScalar(c,i,g),g),g),h=_.Cartesian3.add(m,_.Cartesian3.negate(_.Cartesian3.multiplyByScalar(c,2*i,h),h),h),k[0]=_.Cartesian3.clone(d,k[0]),k[1]=_.Cartesian3.clone(g,k[1]),f=ia(j.PolylinePipeline.generateArc({positions:k,granularity:r,ellipsoid:n}),c,i,f),o&&(w.push(c.x,c.y,c.z),v.push(l.x,l.y,l.z)),y=_.Cartesian3.clone(h,y),c=_.Cartesian3.normalize(_.Cartesian3.cross(l,C,c),c),h=_.Cartesian3.add(m,_.Cartesian3.negate(_.Cartesian3.multiplyByScalar(c,2*i,h),h),h),d=_.Cartesian3.add(m,_.Cartesian3.negate(_.Cartesian3.multiplyByScalar(c,i,d),d),d),s===Q.CornerType.ROUNDED||s===Q.CornerType.BEVELED?D.push({rightPositions:ta(m,y,h,s,G)}):D.push({rightPositions:na(z,p,h,G)})),u=_.Cartesian3.negate(C,u)),z=E}return l=n.geodeticSurfaceNormal(z,l),k[0]=_.Cartesian3.clone(d,k[0]),k[1]=_.Cartesian3.clone(z,k[1]),f=ia(j.PolylinePipeline.generateArc({positions:k,granularity:r,ellipsoid:n}),c,i,f),o&&(w.push(c.x,c.y,c.z),v.push(l.x,l.y,l.z)),s===Q.CornerType.ROUNDED&&(b=F,B=J,P=K,x=(S=f)[1],B=_.Cartesian3.fromArray(S[1],x.length-3,B),P=_.Cartesian3.fromArray(S[0],0,P),N=ta(b=_.Cartesian3.midpoint(B,P,b),B,P,Q.CornerType.ROUNDED,!1),A=S.length-1,T=S[A-1],x=S[A],B=_.Cartesian3.fromArray(T,T.length-3,B),P=_.Cartesian3.fromArray(x,0,P),e=[N,ta(b=_.Cartesian3.midpoint(B,P,b),B,P,Q.CornerType.ROUNDED,!1)]),{positions:f,corners:D,lefts:w,normals:v,endPositions:e}},e.computeInterpolationPositions=function(a){var e=a.positions,r=a.width/2,t=a.globe,o=t.ellipsoid,l=a.granularity,n=a.cornerLength,i=a.height,s=U.defaultValue(a.heightReference,q.NONE),C=Math.PI;if(!(e.length<2)){for(var u=F,c=J,p=K,y=X,d=Y,h=Z,m=new I.Cartographic,g=V.CesiumMath.toRadians(170),f=new H.EllipsoidGeodesic(null,null,o),w=e[0],v=e[1],z=null,E=[L(e[0])],u=_.Cartesian3.normalize(_.Cartesian3.subtract(v,w,u),u),c=_.Cartesian3.negate(u,c),S=e.length-1,b=1;b<S;b++){z=e[b+1],u=_.Cartesian3.normalize(_.Cartesian3.subtract(z,v,u),u),p=o.geodeticSurfaceNormal(v,p);var B=_.Cartesian3.multiplyByScalar(p,_.Cartesian3.dot(u,p),oa);_.Cartesian3.subtract(u,B,B),_.Cartesian3.normalize(B,B);var P=_.Cartesian3.multiplyByScalar(p,_.Cartesian3.dot(c,p),la);_.Cartesian3.subtract(c,P,P),_.Cartesian3.normalize(P,P);var x=Math.acos(_.Cartesian3.dot(B,P));if(x<g){var N=(n/(C-x)+r)*Math.tan((C-x)/2),A=_.Cartesian3.distance(v,z),T=_.Cartesian3.distance(v,w),N=Math.min(N,A,T),d=_.Cartesian3.add(v,_.Cartesian3.multiplyByScalar(c,N,d),d),h=_.Cartesian3.add(v,_.Cartesian3.multiplyByScalar(u,N,h),h);R(w,d);for(var D=Math.max(2*n/l,100),O=sa([d,v,h],D),M=0;M<D;M++)E.push(L(O[M],O[M]));E.push(L(h)),w=_.Cartesian3.clone(h,y)}else R(w,v),w=v;v=z,c=_.Cartesian3.negate(u,c)}return R(w,v),E}function R(a,e){var r=o.cartesianToCartographic(a),t=o.cartesianToCartographic(e),n=t.height-r.height;f.setEndPoints(r,t);for(var i=l,s=f.surfaceDistance;i<s;)f.interpolateUsingSurfaceDistance(i,m),m.height=r.height+i/s*n,G(m),E.push(o.cartographicToCartesian(m)),i+=l;E.push(L(e))}function L(a,e){return U.defined(i)||s!==q.NONE?(o.cartesianToCartographic(a,m),G(m),o.cartographicToCartesian(m,e)):e||_.Cartesian3.clone(a)}function G(a){var e;s===q.CLAMP_TO_GROUND?(e=t.getHeight(a))&&(a.height=e):"number"==typeof i&&(s===q.NONE?a.height=i:s===q.RELATIVE_TO_GROUND&&((e=t.getHeight(a))?a.height=e+i:console.error("获取地形高程失败！")))}},e.ev_computePositions=function(a){for(var e=a.positions,r=a.width/2,t=U.defaultValue(a.ellipsoid,I.Ellipsoid.WGS84),n=F,i=J,s=K,o=[],l=[],C=[],u=[],c=e[0],p=null,y=1,d=e.length;y<d;y++)p=e[y],n=t.geodeticSurfaceNormal(c,n),i=_.Cartesian3.subtract(p,c,i),s=_.Cartesian3.normalize(_.Cartesian3.cross(n,i,s),s),s=_.Cartesian3.multiplyByScalar(s,r,s),o.push(_.Cartesian3.add(c,s)),l.push(_.Cartesian3.subtract(c,s)),C.push(n),u.push(n),c=p;for(o.push(_.Cartesian3.add(c,s)),l.push(_.Cartesian3.subtract(c,s)),C.push(n),u.push(n);0<o.length;)l.push(o.pop()),u.push(C.pop());return{positions:l,normals:u}},a.CorridorGeometryLibrary=e});
