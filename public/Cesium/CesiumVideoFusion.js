!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).CesiumVideoFusion={})}(this,function(e){"use strict";function i(e){this._leftClip=Cesium.defaultValue(0,0),this._rightClip=Cesium.defaultValue(1,1),this._topClipLine1=new Cesium.Cartesian4(0,1,1,1),this._topClipLine2=new Cesium.Cartesian4(0,1,1,1),this._topClipLine3=new Cesium.Cartesian4(0,1,1,1),this._topClipLine4=new Cesium.Cartesian4(0,1,1,1),this._bottomClipLine1=new Cesium.Cartesian4(0,0,1,0),this._bottomClipLine2=new Cesium.Cartesian4(0,0,1,0),this._bottomClipLine3=new Cesium.Cartesian4(0,0,1,0),this._bottomClipLine4=new Cesium.Cartesian4(0,0,1,0),this._pointsList=[],this._initialPointsList=[],this._indicesList=[],this._centerPostion=new Cesium.Cartesian3;for(var t=0;t<e.length;t++)try{var i=e[t];if(t===e.length-1)for(var n=0;n<i.length;n++)this._indicesList.push(i[n]);else if(this._centerPostion.x=this._centerPostion.x+i[0],this._centerPostion.y=this._centerPostion.y+i[1],this._centerPostion.z=this._centerPostion.z+i[2],this._pointsList.push(new Cesium.Cartesian3(i[0],i[1],i[2])),0<=i[3])for(var r=this._initialPointsList.length,o=0;o<e.length-1;o++)if(e[o][3]===r){this._initialPointsList.push(new Cesium.Cartesian3(e[o][0],e[o][1],e[o][2]));break}}catch(e){console.error(e.message)}this._centerPostion.x=this._centerPostion.x/(e.length-1),this._centerPostion.y=this._centerPostion.y/(e.length-1),this._centerPostion.z=this._centerPostion.z/(e.length-1)}function n(e){this._planes=[];for(var t=0;t<e.length;t++)try{this._planes.push(new i(e[t]))}catch(e){console.error(e.message)}}function M(e){return null!=e}function o(e){var t;this.name="DeveloperError",this.message=e;try{throw new Error}catch(e){t=e.stack}this.stack=t}M(Object.create)&&((o.prototype=Object.create(Error.prototype)).constructor=o),o.prototype.toString=function(){var e=this.name+": "+this.message;return M(this.stack)&&(e+="\n"+this.stack.toString()),e},o.throwInstantiationError=function(){throw new o("This function defines an interface and should not be called directly.")};var r={};function s(e,t,i){return"Expected "+i+" to be typeof "+t+", actual typeof was "+e}function C(e,t){return null!=e?e:t}function t(e){null==e&&(e=(new Date).getTime()),this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.mt=new Array(this.N),this.mti=this.N+1,this.init_genrand(e)}r.typeOf={},r.defined=function(e,t){if(!M(t))throw new o(e+" is required, actual value was undefined")},r.typeOf.func=function(e,t){if("function"!=typeof t)throw new o(s(typeof t,"function",e))},r.typeOf.string=function(e,t){if("string"!=typeof t)throw new o(s(typeof t,"string",e))},r.typeOf.number=function(e,t){if("number"!=typeof t)throw new o(s(typeof t,"number",e))},r.typeOf.number.lessThan=function(e,t,i){if(r.typeOf.number(e,t),i<=t)throw new o("Expected "+e+" to be less than "+i+", actual value was "+t)},r.typeOf.number.lessThanOrEquals=function(e,t,i){if(r.typeOf.number(e,t),i<t)throw new o("Expected "+e+" to be less than or equal to "+i+", actual value was "+t)},r.typeOf.number.greaterThan=function(e,t,i){if(r.typeOf.number(e,t),t<=i)throw new o("Expected "+e+" to be greater than "+i+", actual value was "+t)},r.typeOf.number.greaterThanOrEquals=function(e,t,i){if(r.typeOf.number(e,t),t<i)throw new o("Expected "+e+" to be greater than or equal to"+i+", actual value was "+t)},r.typeOf.object=function(e,t){if("object"!=typeof t)throw new o(s(typeof t,"object",e))},r.typeOf.bool=function(e,t){if("boolean"!=typeof t)throw new o(s(typeof t,"boolean",e))},r.typeOf.number.equals=function(e,t,i,n){if(r.typeOf.number(e,i),r.typeOf.number(t,n),i!==n)throw new o(e+" must be equal to "+t+", the actual values are "+i+" and "+n)},C.EMPTY_OBJECT=Object.freeze({}),t.prototype.init_genrand=function(e){for(this.mt[0]=e>>>0,this.mti=1;this.mti<this.N;this.mti++){e=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30;this.mt[this.mti]=(1812433253*((4294901760&e)>>>16)<<16)+1812433253*(65535&e)+this.mti,this.mt[this.mti]>>>=0}},t.prototype.genrand_int32=function(){var e,t,i=new Array(0,this.MATRIX_A);if(this.mti>=this.N){for(this.mti==this.N+1&&this.init_genrand(5489),t=0;t<this.N-this.M;t++)e=this.mt[t]&this.UPPER_MASK|this.mt[t+1]&this.LOWER_MASK,this.mt[t]=this.mt[t+this.M]^e>>>1^i[1&e];for(;t<this.N-1;t++)e=this.mt[t]&this.UPPER_MASK|this.mt[t+1]&this.LOWER_MASK,this.mt[t]=this.mt[t+(this.M-this.N)]^e>>>1^i[1&e];e=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK,this.mt[this.N-1]=this.mt[this.M-1]^e>>>1^i[1&e],this.mti=0}return e=this.mt[this.mti++],e^=e>>>11,e^=e<<7&2636928640,e^=e<<15&4022730752,(e^=e>>>18)>>>0},t.prototype.random=function(){return this.genrand_int32()*(1/4294967296)};var X={EPSILON1:.1,EPSILON2:.01,EPSILON3:.001,EPSILON4:1e-4,EPSILON5:1e-5,EPSILON6:1e-6,EPSILON7:1e-7,EPSILON8:1e-8,EPSILON9:1e-9,EPSILON10:1e-10,EPSILON11:1e-11,EPSILON12:1e-12,EPSILON13:1e-13,EPSILON14:1e-14,EPSILON15:1e-15,EPSILON16:1e-16,EPSILON17:1e-17,EPSILON18:1e-18,EPSILON19:1e-19,EPSILON20:1e-20,EPSILON21:1e-21,GRAVITATIONALPARAMETER:3986004418e5,SOLAR_RADIUS:6955e5,LUNAR_RADIUS:1737400,SIXTY_FOUR_KILOBYTES:65536,FOUR_GIGABYTES:4294967296};X.sign=C(Math.sign,function(e){return 0===(e=+e)||e!=e?e:0<e?1:-1}),X.signNotZero=function(e){return e<0?-1:1},X.toSNorm=function(e,t){return t=C(t,255),Math.round((.5*X.clamp(e,-1,1)+.5)*t)},X.fromSNorm=function(e,t){return t=C(t,255),X.clamp(e,0,t)/t*2-1},X.normalize=function(e,t,i){return 0===(i=Math.max(i-t,0))?0:X.clamp((e-t)/i,0,1)},X.sinh=C(Math.sinh,function(e){return(Math.exp(e)-Math.exp(-e))/2}),X.cosh=C(Math.cosh,function(e){return(Math.exp(e)+Math.exp(-e))/2}),X.lerp=function(e,t,i){return(1-i)*e+i*t},X.PI=Math.PI,X.ONE_OVER_PI=1/Math.PI,X.PI_OVER_TWO=Math.PI/2,X.PI_OVER_THREE=Math.PI/3,X.PI_OVER_FOUR=Math.PI/4,X.PI_OVER_SIX=Math.PI/6,X.THREE_PI_OVER_TWO=3*Math.PI/2,X.TWO_PI=2*Math.PI,X.ONE_OVER_TWO_PI=1/(2*Math.PI),X.RADIANS_PER_DEGREE=Math.PI/180,X.DEGREES_PER_RADIAN=180/Math.PI,X.RADIANS_PER_ARCSECOND=X.RADIANS_PER_DEGREE/3600,X.toRadians=function(e){return e*X.RADIANS_PER_DEGREE},X.toDegrees=function(e){return e*X.DEGREES_PER_RADIAN},X.convertLongitudeRange=function(e){var t=X.TWO_PI,i=e-Math.floor(e/t)*t;return i<-Math.PI?i+t:i>=Math.PI?i-t:i},X.clampToLatitudeRange=function(e){return X.clamp(e,-1*X.PI_OVER_TWO,X.PI_OVER_TWO)},X.negativePiToPi=function(e){return X.zeroToTwoPi(e+X.PI)-X.PI},X.zeroToTwoPi=function(e){var t=X.mod(e,X.TWO_PI);return Math.abs(t)<X.EPSILON14&&Math.abs(e)>X.EPSILON14?X.TWO_PI:t},X.mod=function(e,t){return(e%t+t)%t},X.equalsEpsilon=function(e,t,i,n){n=C(n,i);var r=Math.abs(e-t);return r<=n||r<=i*Math.max(Math.abs(e),Math.abs(t))},X.lessThan=function(e,t,i){return e-t<-i},X.lessThanOrEquals=function(e,t,i){return e-t<i},X.greaterThan=function(e,t,i){return i<e-t},X.greaterThanOrEquals=function(e,t,i){return-i<e-t};var a=[1];X.factorial=function(e){var t=a.length;if(t<=e)for(var i=a[t-1],n=t;n<=e;n++){var r=i*n;a.push(r),i=r}return a[e]},X.incrementWrap=function(e,t,i){return i=C(i,0),t<++e&&(e=i),e},X.isPowerOfTwo=function(e){return 0!==e&&0==(e&e-1)},X.nextPowerOfTwo=function(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},X.clamp=function(e,t,i){return e<t?t:i<e?i:e};var u=new t;function _(e,t,i){this.x=C(e,0),this.y=C(t,0),this.z=C(i,0)}X.setRandomNumberSeed=function(e){u=new t(e)},X.nextRandomNumber=function(){return u.random()},X.randomBetween=function(e,t){return X.nextRandomNumber()*(t-e)+e},X.acosClamped=function(e){return Math.acos(X.clamp(e,-1,1))},X.asinClamped=function(e){return Math.asin(X.clamp(e,-1,1))},X.chordLength=function(e,t){return 2*t*Math.sin(.5*e)},X.logBase=function(e,t){return Math.log(e)/Math.log(t)},X.cbrt=C(Math.cbrt,function(e){var t=Math.pow(Math.abs(e),1/3);return e<0?-t:t}),X.log2=C(Math.log2,function(e){return Math.log(e)*Math.LOG2E}),X.fog=function(e,t){var i=e*t;return 1-Math.exp(-i*i)},X.fastApproximateAtan=function(e){return e*(-.1784*Math.abs(e)-.0663*e*e+1.0301)},X.fastApproximateAtan2=function(e,t){var i=Math.abs(e),n=Math.abs(t),r=Math.max(i,n),o=(n=Math.min(i,n))/r,i=X.fastApproximateAtan(o);return i=Math.abs(t)>Math.abs(e)?X.PI_OVER_TWO-i:i,i=e<0?X.PI-i:i,i=t<0?-i:i},_.fromSpherical=function(e,t){M(t)||(t=new _);var i=e.clock,n=e.cone,r=C(e.magnitude,1),o=r*Math.sin(n);return t.x=o*Math.cos(i),t.y=o*Math.sin(i),t.z=r*Math.cos(n),t},_.fromElements=function(e,t,i,n){return M(n)?(n.x=e,n.y=t,n.z=i,n):new _(e,t,i)},_.fromCartesian4=_.clone=function(e,t){if(M(e))return M(t)?(t.x=e.x,t.y=e.y,t.z=e.z,t):new _(e.x,e.y,e.z)},_.packedLength=3,_.pack=function(e,t,i){return i=C(i,0),t[i++]=e.x,t[i++]=e.y,t[i]=e.z,t},_.unpack=function(e,t,i){return t=C(t,0),M(i)||(i=new _),i.x=e[t++],i.y=e[t++],i.z=e[t],i},_.packArray=function(e,t){var i=e.length,n=3*i;if(M(t)){if(!Array.isArray(t)&&t.length!==n)throw new o("If result is a typed array, it must have exactly array.length * 3 elements");t.length!==n&&(t.length=n)}else t=new Array(n);for(var r=0;r<i;++r)_.pack(e[r],t,3*r);return t},_.unpackArray=function(e,t){var i=e.length;M(t)?t.length=i/3:t=new Array(i/3);for(var n=0;n<i;n+=3){var r=n/3;t[r]=_.unpack(e,n,t[r])}return t},_.fromArray=_.unpack,_.maximumComponent=function(e){return Math.max(e.x,e.y,e.z)},_.minimumComponent=function(e){return Math.min(e.x,e.y,e.z)},_.minimumByComponent=function(e,t,i){return i.x=Math.min(e.x,t.x),i.y=Math.min(e.y,t.y),i.z=Math.min(e.z,t.z),i},_.maximumByComponent=function(e,t,i){return i.x=Math.max(e.x,t.x),i.y=Math.max(e.y,t.y),i.z=Math.max(e.z,t.z),i},_.magnitudeSquared=function(e){return e.x*e.x+e.y*e.y+e.z*e.z},_.magnitude=function(e){return Math.sqrt(_.magnitudeSquared(e))};var l=new _;_.distance=function(e,t){return _.subtract(e,t,l),_.magnitude(l)},_.distanceSquared=function(e,t){return _.subtract(e,t,l),_.magnitudeSquared(l)},_.normalize=function(e,t){var i=_.magnitude(e);return M(t)||(t=new _),t.x=e.x/i,t.y=e.y/i,t.z=e.z/i,t},_.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},_.multiplyComponents=function(e,t,i){return i.x=e.x*t.x,i.y=e.y*t.y,i.z=e.z*t.z,i},_.divideComponents=function(e,t,i){return i.x=e.x/t.x,i.y=e.y/t.y,i.z=e.z/t.z,i},_.add=function(e,t,i){return M(i)||(i=new _),i.x=e.x+t.x,i.y=e.y+t.y,i.z=e.z+t.z,i},_.subtract=function(e,t,i){return M(i)||(i=new _),i.x=e.x-t.x,i.y=e.y-t.y,i.z=e.z-t.z,i},_.multiplyByScalar=function(e,t,i){return i.x=e.x*t,i.y=e.y*t,i.z=e.z*t,i},_.divideByScalar=function(e,t,i){return i.x=e.x/t,i.y=e.y/t,i.z=e.z/t,i},_.negate=function(e,t){return M(t)||(t=new _),t.x=-e.x,t.y=-e.y,t.z=-e.z,t},_.abs=function(e,t){return t.x=Math.abs(e.x),t.y=Math.abs(e.y),t.z=Math.abs(e.z),t};var d=new _;_.lerp=function(e,t,i,n){return _.multiplyByScalar(t,i,d),n=_.multiplyByScalar(e,1-i,n),_.add(d,n,n)};var h=new _,c=new _;_.angleBetween=function(e,t){_.normalize(e,h),_.normalize(t,c);var i=_.dot(h,c),n=_.magnitude(_.cross(h,c,h));return Math.atan2(n,i)};var m=new _;_.mostOrthogonalAxis=function(e,t){var i=_.normalize(e,m);return _.abs(i,i),t=i.x<=i.y?i.x<=i.z?_.clone(_.UNIT_X,t):_.clone(_.UNIT_Z,t):i.y<=i.z?_.clone(_.UNIT_Y,t):_.clone(_.UNIT_Z,t)},_.projectVector=function(e,t,i){var n=_.dot(e,t)/_.dot(t,t);return _.multiplyByScalar(t,n,i)},_.equals=function(e,t){return e===t||M(e)&&M(t)&&e.x===t.x&&e.y===t.y&&e.z===t.z},_.equalsArray=function(e,t,i){return e.x===t[i]&&e.y===t[i+1]&&e.z===t[i+2]},_.equalsEpsilon=function(e,t,i,n){return e===t||M(e)&&M(t)&&X.equalsEpsilon(e.x,t.x,i,n)&&X.equalsEpsilon(e.y,t.y,i,n)&&X.equalsEpsilon(e.z,t.z,i,n)},_.cross=function(e,t,i){var n=e.x,r=e.y,o=e.z,s=t.x,a=t.y,u=t.z,l=r*u-o*a,d=o*s-n*u,h=n*a-r*s;return i.x=l,i.y=d,i.z=h,i},_.midpoint=function(e,t,i){return i.x=.5*(e.x+t.x),i.y=.5*(e.y+t.y),i.z=.5*(e.z+t.z),i},_.fromDegrees=function(e,t,i,n,r){return e=X.toRadians(e),t=X.toRadians(t),_.fromRadians(e,t,i,n,r)};var p=new _,f=new _;function K(e,t,i,n){this.x=C(e,0),this.y=C(t,0),this.z=C(i,0),this.w=C(n,0)}_.wgs84RadiiSquared=new _(40680631590769,40680631590769,40408299984661.445),_.fromRadians=function(e,t,i,n,r){i=C(i,0);var o=M(n)?n.radiiSquared:this.wgs84RadiiSquared,s=Math.cos(t);p.x=s*Math.cos(e),p.y=s*Math.sin(e),p.z=Math.sin(t),p=_.normalize(p,p),_.multiplyComponents(o,p,f);var a=Math.sqrt(_.dot(p,f));return f=_.divideByScalar(f,a,f),p=_.multiplyByScalar(p,i,p),M(r)||(r=new _),_.add(f,p,r)},_.fromDegreesArray=function(e,t,i){var n=e.length;M(i)?i.length=n/2:i=new Array(n/2);for(var r=0;r<n;r+=2){var o=e[r],s=e[r+1],a=r/2;i[a]=_.fromDegrees(o,s,0,t,i[a])}return i},_.fromRadiansArray=function(e,t,i){var n=e.length;M(i)?i.length=n/2:i=new Array(n/2);for(var r=0;r<n;r+=2){var o=e[r],s=e[r+1],a=r/2;i[a]=_.fromRadians(o,s,0,t,i[a])}return i},_.fromDegreesArrayHeights=function(e,t,i){var n=e.length;M(i)?i.length=n/3:i=new Array(n/3);for(var r=0;r<n;r+=3){var o=e[r],s=e[r+1],a=e[r+2],u=r/3;i[u]=_.fromDegrees(o,s,a,t,i[u])}return i},_.fromRadiansArrayHeights=function(e,t,i){var n=e.length;M(i)?i.length=n/3:i=new Array(n/3);for(var r=0;r<n;r+=3){var o=e[r],s=e[r+1],a=e[r+2],u=r/3;i[u]=_.fromRadians(o,s,a,t,i[u])}return i},_.ZERO=Object.freeze(new _(0,0,0)),_.UNIT_X=Object.freeze(new _(1,0,0)),_.UNIT_Y=Object.freeze(new _(0,1,0)),_.UNIT_Z=Object.freeze(new _(0,0,1)),_.prototype.clone=function(e){return _.clone(this,e)},_.prototype.equals=function(e){return _.equals(this,e)},_.prototype.equalsEpsilon=function(e,t,i){return _.equalsEpsilon(this,e,t,i)},_.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+")"},K.fromElements=function(e,t,i,n,r){return M(r)?(r.x=e,r.y=t,r.z=i,r.w=n,r):new K(e,t,i,n)},K.fromColor=function(e,t){return M(t)?(t.x=e.red,t.y=e.green,t.z=e.blue,t.w=e.alpha,t):new K(e.red,e.green,e.blue,e.alpha)},K.clone=function(e,t){if(M(e))return M(t)?(t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t):new K(e.x,e.y,e.z,e.w)},K.packedLength=4,K.pack=function(e,t,i){return i=C(i,0),t[i++]=e.x,t[i++]=e.y,t[i++]=e.z,t[i]=e.w,t},K.unpack=function(e,t,i){return t=C(t,0),M(i)||(i=new K),i.x=e[t++],i.y=e[t++],i.z=e[t++],i.w=e[t],i},K.packArray=function(e,t){var i=e.length,n=4*i;if(M(t)){if(!Array.isArray(t)&&t.length!==n)throw new o("If result is a typed array, it must have exactly array.length * 4 elements");t.length!==n&&(t.length=n)}else t=new Array(n);for(var r=0;r<i;++r)K.pack(e[r],t,4*r);return t},K.unpackArray=function(e,t){var i=e.length;M(t)?t.length=i/4:t=new Array(i/4);for(var n=0;n<i;n+=4){var r=n/4;t[r]=K.unpack(e,n,t[r])}return t},K.fromArray=K.unpack,K.maximumComponent=function(e){return Math.max(e.x,e.y,e.z,e.w)},K.minimumComponent=function(e){return Math.min(e.x,e.y,e.z,e.w)},K.minimumByComponent=function(e,t,i){return i.x=Math.min(e.x,t.x),i.y=Math.min(e.y,t.y),i.z=Math.min(e.z,t.z),i.w=Math.min(e.w,t.w),i},K.maximumByComponent=function(e,t,i){return i.x=Math.max(e.x,t.x),i.y=Math.max(e.y,t.y),i.z=Math.max(e.z,t.z),i.w=Math.max(e.w,t.w),i},K.magnitudeSquared=function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w},K.magnitude=function(e){return Math.sqrt(K.magnitudeSquared(e))};var v=new K;K.distance=function(e,t){return K.subtract(e,t,v),K.magnitude(v)},K.distanceSquared=function(e,t){return K.subtract(e,t,v),K.magnitudeSquared(v)},K.normalize=function(e,t){var i=K.magnitude(e);return t.x=e.x/i,t.y=e.y/i,t.z=e.z/i,t.w=e.w/i,t},K.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},K.multiplyComponents=function(e,t,i){return i.x=e.x*t.x,i.y=e.y*t.y,i.z=e.z*t.z,i.w=e.w*t.w,i},K.divideComponents=function(e,t,i){return i.x=e.x/t.x,i.y=e.y/t.y,i.z=e.z/t.z,i.w=e.w/t.w,i},K.add=function(e,t,i){return i.x=e.x+t.x,i.y=e.y+t.y,i.z=e.z+t.z,i.w=e.w+t.w,i},K.subtract=function(e,t,i){return i.x=e.x-t.x,i.y=e.y-t.y,i.z=e.z-t.z,i.w=e.w-t.w,i},K.multiplyByScalar=function(e,t,i){return i.x=e.x*t,i.y=e.y*t,i.z=e.z*t,i.w=e.w*t,i},K.divideByScalar=function(e,t,i){return i.x=e.x/t,i.y=e.y/t,i.z=e.z/t,i.w=e.w/t,i},K.negate=function(e,t){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=-e.w,t},K.abs=function(e,t){return t.x=Math.abs(e.x),t.y=Math.abs(e.y),t.z=Math.abs(e.z),t.w=Math.abs(e.w),t};var g=new K;K.lerp=function(e,t,i,n){return K.multiplyByScalar(t,i,g),n=K.multiplyByScalar(e,1-i,n),K.add(g,n,n)};var y=new K;K.mostOrthogonalAxis=function(e,t){var i=K.normalize(e,y);return K.abs(i,i),t=i.x<=i.y?i.x<=i.z?i.x<=i.w?K.clone(K.UNIT_X,t):K.clone(K.UNIT_W,t):i.z<=i.w?K.clone(K.UNIT_Z,t):K.clone(K.UNIT_W,t):i.y<=i.z?i.y<=i.w?K.clone(K.UNIT_Y,t):K.clone(K.UNIT_W,t):i.z<=i.w?K.clone(K.UNIT_Z,t):K.clone(K.UNIT_W,t)},K.equals=function(e,t){return e===t||M(e)&&M(t)&&e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},K.equalsArray=function(e,t,i){return e.x===t[i]&&e.y===t[i+1]&&e.z===t[i+2]&&e.w===t[i+3]},K.equalsEpsilon=function(e,t,i,n){return e===t||M(e)&&M(t)&&X.equalsEpsilon(e.x,t.x,i,n)&&X.equalsEpsilon(e.y,t.y,i,n)&&X.equalsEpsilon(e.z,t.z,i,n)&&X.equalsEpsilon(e.w,t.w,i,n)},K.ZERO=Object.freeze(new K(0,0,0,0)),K.UNIT_X=Object.freeze(new K(1,0,0,0)),K.UNIT_Y=Object.freeze(new K(0,1,0,0)),K.UNIT_Z=Object.freeze(new K(0,0,1,0)),K.UNIT_W=Object.freeze(new K(0,0,0,1)),K.prototype.clone=function(e){return K.clone(this,e)},K.prototype.equals=function(e){return K.equals(this,e)},K.prototype.equalsEpsilon=function(e,t,i){return K.equalsEpsilon(this,e,t,i)},K.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+", "+this.w+")"};var w=new Float32Array(1),b=256;function U(e,t,i,n,r,o,s,a,u){this[0]=C(e,0),this[1]=C(n,0),this[2]=C(s,0),this[3]=C(t,0),this[4]=C(r,0),this[5]=C(a,0),this[6]=C(i,0),this[7]=C(o,0),this[8]=C(u,0)}K.packFloat=function(e,t){if(M(t)||(t=new K),w[0]=e,0===(e=w[0]))return K.clone(K.ZERO,t);var i,n=e<0?1:0;isFinite(e)?(e=Math.abs(e),i=Math.floor(X.logBase(e,10))+1,e/=Math.pow(10,i)):(e=.1,i=38);var r=e*b;return t.x=Math.floor(r),r=(r-t.x)*b,t.y=Math.floor(r),r=(r-t.y)*b,t.z=Math.floor(r),t.w=2*(i+38)+n,t},K.unpackFloat=function(e){var t=e.w/2,i=Math.floor(t),n=-(n=2*(n=2*(t-i))-1);if(38<=(i-=38))return n<0?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY;var r=n*e.x*.00390625;return r+=n*e.y*(1/65536),(r+=n*e.z*(1/16777216))*Math.pow(10,i)},U.packedLength=9,U.pack=function(e,t,i){return i=C(i,0),t[i++]=e[0],t[i++]=e[1],t[i++]=e[2],t[i++]=e[3],t[i++]=e[4],t[i++]=e[5],t[i++]=e[6],t[i++]=e[7],t[i++]=e[8],t},U.unpack=function(e,t,i){return t=C(t,0),M(i)||(i=new U),i[0]=e[t++],i[1]=e[t++],i[2]=e[t++],i[3]=e[t++],i[4]=e[t++],i[5]=e[t++],i[6]=e[t++],i[7]=e[t++],i[8]=e[t++],i},U.clone=function(e,t){if(M(e))return M(t)?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t):new U(e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8])},U.fromArray=function(e,t,i){return t=C(t,0),M(i)||(i=new U),i[0]=e[t],i[1]=e[t+1],i[2]=e[t+2],i[3]=e[t+3],i[4]=e[t+4],i[5]=e[t+5],i[6]=e[t+6],i[7]=e[t+7],i[8]=e[t+8],i},U.fromColumnMajorArray=function(e,t){return U.clone(e,t)},U.fromRowMajorArray=function(e,t){return M(t)?(t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],t):new U(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])},U.fromQuaternion=function(e,t){var i=e.x*e.x,n=e.x*e.y,r=e.x*e.z,o=e.x*e.w,s=e.y*e.y,a=e.y*e.z,u=e.y*e.w,l=e.z*e.z,d=e.z*e.w,h=e.w*e.w,c=i-s-l+h,m=2*(n-d),p=2*(r+u),f=2*(n+d),C=s-i-l+h,v=2*(a-o),g=2*(r-u),y=2*(a+o),_=-i-s+l+h;return M(t)?(t[0]=c,t[1]=f,t[2]=g,t[3]=m,t[4]=C,t[5]=y,t[6]=p,t[7]=v,t[8]=_,t):new U(c,m,p,f,C,v,g,y,_)},U.fromHeadingPitchRoll=function(e,t){var i=Math.cos(-e.pitch),n=Math.cos(-e.heading),r=Math.cos(e.roll),o=Math.sin(-e.pitch),s=Math.sin(-e.heading),a=Math.sin(e.roll),u=i*n,l=-r*s+a*o*n,d=a*s+r*o*n,h=i*s,c=r*n+a*o*s,m=-a*n+r*o*s,p=-o,f=a*i,C=r*i;return M(t)?(t[0]=u,t[1]=h,t[2]=p,t[3]=l,t[4]=c,t[5]=f,t[6]=d,t[7]=m,t[8]=C,t):new U(u,l,d,h,c,m,p,f,C)},U.fromScale=function(e,t){return M(t)?(t[0]=e.x,t[1]=0,t[2]=0,t[3]=0,t[4]=e.y,t[5]=0,t[6]=0,t[7]=0,t[8]=e.z,t):new U(e.x,0,0,0,e.y,0,0,0,e.z)},U.fromUniformScale=function(e,t){return M(t)?(t[0]=e,t[1]=0,t[2]=0,t[3]=0,t[4]=e,t[5]=0,t[6]=0,t[7]=0,t[8]=e,t):new U(e,0,0,0,e,0,0,0,e)},U.fromCrossProduct=function(e,t){return M(t)?(t[0]=0,t[1]=e.z,t[2]=-e.y,t[3]=-e.z,t[4]=0,t[5]=e.x,t[6]=e.y,t[7]=-e.x,t[8]=0,t):new U(0,-e.z,e.y,e.z,0,-e.x,-e.y,e.x,0)},U.fromRotationX=function(e,t){var i=Math.cos(e),n=Math.sin(e);return M(t)?(t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=i,t[5]=n,t[6]=0,t[7]=-n,t[8]=i,t):new U(1,0,0,0,i,-n,0,n,i)},U.fromRotationY=function(e,t){var i=Math.cos(e),n=Math.sin(e);return M(t)?(t[0]=i,t[1]=0,t[2]=-n,t[3]=0,t[4]=1,t[5]=0,t[6]=n,t[7]=0,t[8]=i,t):new U(i,0,n,0,1,0,-n,0,i)},U.fromRotationZ=function(e,t){var i=Math.cos(e),n=Math.sin(e);return M(t)?(t[0]=i,t[1]=n,t[2]=0,t[3]=-n,t[4]=i,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t):new U(i,-n,0,n,i,0,0,0,1)},U.toArray=function(e,t){return M(t)?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t):[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8]]},U.getElementIndex=function(e,t){return 3*e+t},U.getColumn=function(e,t,i){var n=3*t,r=e[n],o=e[1+n],s=e[2+n];return i.x=r,i.y=o,i.z=s,i},U.setColumn=function(e,t,i,n){var r=3*t;return(n=U.clone(e,n))[r]=i.x,n[1+r]=i.y,n[2+r]=i.z,n},U.getRow=function(e,t,i){var n=e[t],r=e[t+3],o=e[t+6];return i.x=n,i.y=r,i.z=o,i},U.setRow=function(e,t,i,n){return(n=U.clone(e,n))[t]=i.x,n[t+3]=i.y,n[t+6]=i.z,n};var I=new _;U.getScale=function(e,t){return t.x=_.magnitude(_.fromElements(e[0],e[1],e[2],I)),t.y=_.magnitude(_.fromElements(e[3],e[4],e[5],I)),t.z=_.magnitude(_.fromElements(e[6],e[7],e[8],I)),t};var V=new _;U.getMaximumScale=function(e){return U.getScale(e,V),_.maximumComponent(V)},U.multiply=function(e,t,i){var n=e[0]*t[0]+e[3]*t[1]+e[6]*t[2],r=e[1]*t[0]+e[4]*t[1]+e[7]*t[2],o=e[2]*t[0]+e[5]*t[1]+e[8]*t[2],s=e[0]*t[3]+e[3]*t[4]+e[6]*t[5],a=e[1]*t[3]+e[4]*t[4]+e[7]*t[5],u=e[2]*t[3]+e[5]*t[4]+e[8]*t[5],l=e[0]*t[6]+e[3]*t[7]+e[6]*t[8],d=e[1]*t[6]+e[4]*t[7]+e[7]*t[8],h=e[2]*t[6]+e[5]*t[7]+e[8]*t[8];return i[0]=n,i[1]=r,i[2]=o,i[3]=s,i[4]=a,i[5]=u,i[6]=l,i[7]=d,i[8]=h,i},U.add=function(e,t,i){return i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i[4]=e[4]+t[4],i[5]=e[5]+t[5],i[6]=e[6]+t[6],i[7]=e[7]+t[7],i[8]=e[8]+t[8],i},U.subtract=function(e,t,i){return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i[3]=e[3]-t[3],i[4]=e[4]-t[4],i[5]=e[5]-t[5],i[6]=e[6]-t[6],i[7]=e[7]-t[7],i[8]=e[8]-t[8],i},U.multiplyByVector=function(e,t,i){var n=t.x,r=t.y,o=t.z,s=e[0]*n+e[3]*r+e[6]*o,a=e[1]*n+e[4]*r+e[7]*o,u=e[2]*n+e[5]*r+e[8]*o;return i.x=s,i.y=a,i.z=u,i},U.multiplyByScalar=function(e,t,i){return i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i[4]=e[4]*t,i[5]=e[5]*t,i[6]=e[6]*t,i[7]=e[7]*t,i[8]=e[8]*t,i},U.multiplyByScale=function(e,t,i){return i[0]=e[0]*t.x,i[1]=e[1]*t.x,i[2]=e[2]*t.x,i[3]=e[3]*t.y,i[4]=e[4]*t.y,i[5]=e[5]*t.y,i[6]=e[6]*t.z,i[7]=e[7]*t.z,i[8]=e[8]*t.z,i},U.negate=function(e,t){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=-e[7],t[8]=-e[8],t},U.transpose=function(e,t){var i=e[0],n=e[3],r=e[6],o=e[1],s=e[4],a=e[7],u=e[2],l=e[5],d=e[8];return t[0]=i,t[1]=n,t[2]=r,t[3]=o,t[4]=s,t[5]=a,t[6]=u,t[7]=l,t[8]=d,t};var x=new _(1,1,1);U.getRotation=function(e,t){var i=_.divideComponents(x,U.getScale(e,V),V);return t=U.multiplyByScale(e,i,t)};var A=[1,0,0],S=[2,2,1];function R(e){for(var t=0,i=0;i<3;++i){var n=e[U.getElementIndex(S[i],A[i])];t+=2*n*n}return Math.sqrt(t)}function Z(e,t){for(var i=X.EPSILON15,n=0,r=1,o=0;o<3;++o){var s=Math.abs(e[U.getElementIndex(S[o],A[o])]);n<s&&(r=o,n=s)}var a,u,l=1,d=0,h=A[r],c=S[r];return Math.abs(e[U.getElementIndex(c,h)])>i&&(d=(u=(a=(e[U.getElementIndex(c,c)]-e[U.getElementIndex(h,h)])/2/e[U.getElementIndex(c,h)])<0?-1/(-a+Math.sqrt(1+a*a)):1/(a+Math.sqrt(1+a*a)))*(l=1/Math.sqrt(1+u*u))),(t=U.clone(U.IDENTITY,t))[U.getElementIndex(h,h)]=t[U.getElementIndex(c,c)]=l,t[U.getElementIndex(c,h)]=d,t[U.getElementIndex(h,c)]=-d,t}var P=new U,T=new U;function Q(e){var t;this.name="RuntimeError",this.message=e;try{throw new Error}catch(e){t=e.stack}this.stack=t}function J(e,t,i,n,r,o,s,a,u,l,d,h,c,m,p,f){this[0]=C(e,0),this[1]=C(r,0),this[2]=C(u,0),this[3]=C(c,0),this[4]=C(t,0),this[5]=C(o,0),this[6]=C(l,0),this[7]=C(m,0),this[8]=C(i,0),this[9]=C(s,0),this[10]=C(d,0),this[11]=C(p,0),this[12]=C(n,0),this[13]=C(a,0),this[14]=C(h,0),this[15]=C(f,0)}function E(e){return 0<e?1:e<0?-1:0}U.computeEigenDecomposition=function(e,t){var i=X.EPSILON20,n=0,r=0;M(t)||(t={});for(var o=t.unitary=U.clone(U.IDENTITY,t.unitary),s=t.diagonal=U.clone(e,t.diagonal),a=i*function(e){for(var t=0,i=0;i<9;++i){var n=e[i];t+=n*n}return Math.sqrt(t)}(s);r<10&&R(s)>a;)Z(s,P),U.transpose(P,T),U.multiply(s,P,s),U.multiply(T,s,s),U.multiply(o,P,o),2<++n&&(++r,n=0);return t},U.abs=function(e,t){return t[0]=Math.abs(e[0]),t[1]=Math.abs(e[1]),t[2]=Math.abs(e[2]),t[3]=Math.abs(e[3]),t[4]=Math.abs(e[4]),t[5]=Math.abs(e[5]),t[6]=Math.abs(e[6]),t[7]=Math.abs(e[7]),t[8]=Math.abs(e[8]),t},U.determinant=function(e){var t=e[0],i=e[3],n=e[6],r=e[1],o=e[4],s=e[7],a=e[2],u=e[5],l=e[8];return t*(o*l-u*s)+r*(u*n-i*l)+a*(i*s-o*n)},U.inverse=function(e,t){var i=e[0],n=e[1],r=e[2],o=e[3],s=e[4],a=e[5],u=e[6],l=e[7],d=e[8],h=U.determinant(e);return t[0]=s*d-l*a,t[1]=l*r-n*d,t[2]=n*a-s*r,t[3]=u*a-o*d,t[4]=i*d-u*r,t[5]=o*r-i*a,t[6]=o*l-u*s,t[7]=u*n-i*l,t[8]=i*s-o*n,U.multiplyByScalar(t,1/h,t)},U.equals=function(e,t){return e===t||M(e)&&M(t)&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]},U.equalsEpsilon=function(e,t,i){return e===t||M(e)&&M(t)&&Math.abs(e[0]-t[0])<=i&&Math.abs(e[1]-t[1])<=i&&Math.abs(e[2]-t[2])<=i&&Math.abs(e[3]-t[3])<=i&&Math.abs(e[4]-t[4])<=i&&Math.abs(e[5]-t[5])<=i&&Math.abs(e[6]-t[6])<=i&&Math.abs(e[7]-t[7])<=i&&Math.abs(e[8]-t[8])<=i},U.IDENTITY=Object.freeze(new U(1,0,0,0,1,0,0,0,1)),U.ZERO=Object.freeze(new U(0,0,0,0,0,0,0,0,0)),U.COLUMN0ROW0=0,U.COLUMN0ROW1=1,U.COLUMN0ROW2=2,U.COLUMN1ROW0=3,U.COLUMN1ROW1=4,U.COLUMN1ROW2=5,U.COLUMN2ROW0=6,U.COLUMN2ROW1=7,U.COLUMN2ROW2=8,Object.defineProperties(U.prototype,{length:{get:function(){return U.packedLength}}}),U.prototype.clone=function(e){return U.clone(this,e)},U.prototype.equals=function(e){return U.equals(this,e)},U.equalsArray=function(e,t,i){return e[0]===t[i]&&e[1]===t[i+1]&&e[2]===t[i+2]&&e[3]===t[i+3]&&e[4]===t[i+4]&&e[5]===t[i+5]&&e[6]===t[i+6]&&e[7]===t[i+7]&&e[8]===t[i+8]},U.prototype.equalsEpsilon=function(e,t){return U.equalsEpsilon(this,e,t)},U.prototype.toString=function(){return"("+this[0]+", "+this[3]+", "+this[6]+")\n("+this[1]+", "+this[4]+", "+this[7]+")\n("+this[2]+", "+this[5]+", "+this[8]+")"},M(Object.create)&&((Q.prototype=Object.create(Error.prototype)).constructor=Q),Q.prototype.toString=function(){var e=this.name+": "+this.message;return M(this.stack)&&(e+="\n"+this.stack.toString()),e},J.packedLength=16,J.computeReflection=function(e,t,i,n,r){return M(r)||(r=new J),r[0]=1-2*e*e,r[1]=-2*e*t,r[2]=-2*e*i,r[3]=0,r[4]=-2*t*e,r[5]=1-2*t*t,r[6]=-2*t*i,r[7]=0,r[8]=-2*i*e,r[9]=-2*i*t,r[10]=1-2*i*i,r[11]=0,r[12]=-2*n*e,r[13]=-2*n*t,r[14]=-2*n*i,r[15]=1,r},J.computeObliquePerspective=function(e,t,i){var n=J.inverse(i,new J),r=J.inverseTranspose(t,new J),o=J.multiplyByVector(r,e,new K),s=new K(E(o.x),E(o.y),1,1),a=J.multiplyByVector(n,s,new K),u=2/K.dot(o,a),l=[o.x*u,o.y*u,o.z*u+1,o.w*u];return new J(i[0],i[4],i[8],i[12],i[1],i[5],i[9],i[13],l[0],l[1],l[2],l[3],i[3],i[7],i[11],i[15])},J.inverseTranspose=function(e,t){return J.inverse(J.transpose(e,new J),t)},J.pack=function(e,t,i){return i=C(i,0),t[i++]=e[0],t[i++]=e[1],t[i++]=e[2],t[i++]=e[3],t[i++]=e[4],t[i++]=e[5],t[i++]=e[6],t[i++]=e[7],t[i++]=e[8],t[i++]=e[9],t[i++]=e[10],t[i++]=e[11],t[i++]=e[12],t[i++]=e[13],t[i++]=e[14],t[i]=e[15],t},J.unpack=function(e,t,i){return t=C(t,0),M(i)||(i=new J),i[0]=e[t++],i[1]=e[t++],i[2]=e[t++],i[3]=e[t++],i[4]=e[t++],i[5]=e[t++],i[6]=e[t++],i[7]=e[t++],i[8]=e[t++],i[9]=e[t++],i[10]=e[t++],i[11]=e[t++],i[12]=e[t++],i[13]=e[t++],i[14]=e[t++],i[15]=e[t],i},J.clone=function(e,t){if(M(e))return M(t)?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t):new J(e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15])},J.fromArray=J.unpack,J.fromColumnMajorArray=function(e,t){return J.clone(e,t)},J.fromRowMajorArray=function(e,t){return M(t)?(t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t):new J(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])},J.fromRotationTranslation=function(e,t,i){return t=C(t,_.ZERO),M(i)?(i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=0,i[4]=e[3],i[5]=e[4],i[6]=e[5],i[7]=0,i[8]=e[6],i[9]=e[7],i[10]=e[8],i[11]=0,i[12]=t.x,i[13]=t.y,i[14]=t.z,i[15]=1,i):new J(e[0],e[3],e[6],t.x,e[1],e[4],e[7],t.y,e[2],e[5],e[8],t.z,0,0,0,1)},J.fromTranslationQuaternionRotationScale=function(e,t,i,n){M(n)||(n=new J);var r=i.x,o=i.y,s=i.z,a=t.x*t.x,u=t.x*t.y,l=t.x*t.z,d=t.x*t.w,h=t.y*t.y,c=t.y*t.z,m=t.y*t.w,p=t.z*t.z,f=t.z*t.w,C=t.w*t.w,v=a-h-p+C,g=2*(u-f),y=2*(l+m),_=2*(u+f),w=h-a-p+C,b=2*(c-d),I=2*(l-m),V=2*(c+d),x=-a-h+p+C;return n[0]=v*r,n[1]=_*r,n[2]=I*r,n[3]=0,n[4]=g*o,n[5]=w*o,n[6]=V*o,n[7]=0,n[8]=y*s,n[9]=b*s,n[10]=x*s,n[11]=0,n[12]=e.x,n[13]=e.y,n[14]=e.z,n[15]=1,n},J.fromTranslationRotationScale=function(e,t){return J.fromTranslationQuaternionRotationScale(e.translation,e.rotation,e.scale,t)},J.fromTranslation=function(e,t){return J.fromRotationTranslation(U.IDENTITY,e,t)},J.fromScale=function(e,t){return M(t)?(t[0]=e.x,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e.y,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e.z,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t):new J(e.x,0,0,0,0,e.y,0,0,0,0,e.z,0,0,0,0,1)},J.fromUniformScale=function(e,t){return M(t)?(t[0]=e,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t):new J(e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1)};var G=new _,L=new _,W=new _;J.fromCamera=function(e,t){var i=e.position,n=e.direction,r=e.up;_.normalize(n,G),_.normalize(_.cross(G,r,L),L),_.normalize(_.cross(L,G,W),W);var o=L.x,s=L.y,a=L.z,u=G.x,l=G.y,d=G.z,h=W.x,c=W.y,m=W.z,p=i.x,f=i.y,C=i.z,v=o*-p+s*-f+a*-C,g=h*-p+c*-f+m*-C,y=u*p+l*f+d*C;return M(t)?(t[0]=o,t[1]=h,t[2]=-u,t[3]=0,t[4]=s,t[5]=c,t[6]=-l,t[7]=0,t[8]=a,t[9]=m,t[10]=-d,t[11]=0,t[12]=v,t[13]=g,t[14]=y,t[15]=1,t):new J(o,s,a,v,h,c,m,g,-u,-l,-d,y,0,0,0,1)},J.computePerspectiveFieldOfView=function(e,t,i,n,r){var o=1/Math.tan(.5*e),s=o/t,a=(n+i)/(i-n),u=2*n*i/(i-n);return r[0]=s,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=o,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=a,r[11]=-1,r[12]=0,r[13]=0,r[14]=u,r[15]=0,r},J.computeOrthographicOffCenter=function(e,t,i,n,r,o,s){var a=1/(t-e),u=1/(n-i),l=1/(o-r),d=-(t+e)*a,h=-(n+i)*u,c=-(o+r)*l;return a*=2,u*=2,l*=-2,s[0]=a,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=u,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=l,s[11]=0,s[12]=d,s[13]=h,s[14]=c,s[15]=1,s},J.computePerspectiveOffCenter=function(e,t,i,n,r,o,s){var a=2*r/(t-e),u=2*r/(n-i),l=(t+e)/(t-e),d=(n+i)/(n-i),h=-(o+r)/(o-r),c=-2*o*r/(o-r);return s[0]=a,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=u,s[6]=0,s[7]=0,s[8]=l,s[9]=d,s[10]=h,s[11]=-1,s[12]=0,s[13]=0,s[14]=c,s[15]=0,s},J.computeInfinitePerspectiveOffCenter=function(e,t,i,n,r,o){var s=2*r/(t-e),a=2*r/(n-i),u=(t+e)/(t-e),l=(n+i)/(n-i),d=-2*r;return o[0]=s,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=a,o[6]=0,o[7]=0,o[8]=u,o[9]=l,o[10]=-1,o[11]=-1,o[12]=0,o[13]=0,o[14]=d,o[15]=0,o},J.computeViewportTransformation=function(e,t,i,n){e=C(e,C.EMPTY_OBJECT);var r=C(e.x,0),o=C(e.y,0),s=C(e.width,0),a=C(e.height,0);t=C(t,0);var u=.5*s,l=.5*a,d=.5*((i=C(i,1))-t),h=l,c=d,m=r+u,p=o+l,f=t+d;return n[0]=u,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=h,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=c,n[11]=0,n[12]=m,n[13]=p,n[14]=f,n[15]=1,n},J.computeView=function(e,t,i,n,r){return r[0]=n.x,r[1]=i.x,r[2]=-t.x,r[3]=0,r[4]=n.y,r[5]=i.y,r[6]=-t.y,r[7]=0,r[8]=n.z,r[9]=i.z,r[10]=-t.z,r[11]=0,r[12]=-_.dot(n,e),r[13]=-_.dot(i,e),r[14]=_.dot(t,e),r[15]=1,r},J.toArray=function(e,t){return M(t)?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t):[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]]},J.getElementIndex=function(e,t){return 4*e+t},J.getColumn=function(e,t,i){var n=4*t,r=e[n],o=e[1+n],s=e[2+n],a=e[3+n];return i.x=r,i.y=o,i.z=s,i.w=a,i},J.setColumn=function(e,t,i,n){var r=4*t;return(n=J.clone(e,n))[r]=i.x,n[1+r]=i.y,n[2+r]=i.z,n[3+r]=i.w,n},J.setTranslation=function(e,t,i){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=t.x,i[13]=t.y,i[14]=t.z,i[15]=e[15],i};var B=new _;J.setScale=function(e,t,i){var n=J.getScale(e,B),r=_.divideComponents(t,n,B);return J.multiplyByScale(e,r,i)},J.getRow=function(e,t,i){var n=e[t],r=e[t+4],o=e[t+8],s=e[t+12];return i.x=n,i.y=r,i.z=o,i.w=s,i},J.setRow=function(e,t,i,n){return(n=J.clone(e,n))[t]=i.x,n[t+4]=i.y,n[t+8]=i.z,n[t+12]=i.w,n};var z=new _;J.getScale=function(e,t){return t.x=_.magnitude(_.fromElements(e[0],e[1],e[2],z)),t.y=_.magnitude(_.fromElements(e[4],e[5],e[6],z)),t.z=_.magnitude(_.fromElements(e[8],e[9],e[10],z)),t};var N=new _;J.getMaximumScale=function(e){return J.getScale(e,N),_.maximumComponent(N)},J.multiply=function(e,t,i){var n=e[0],r=e[1],o=e[2],s=e[3],a=e[4],u=e[5],l=e[6],d=e[7],h=e[8],c=e[9],m=e[10],p=e[11],f=e[12],C=e[13],v=e[14],g=e[15],y=t[0],_=t[1],w=t[2],b=t[3],I=t[4],V=t[5],x=t[6],M=t[7],A=t[8],S=t[9],R=t[10],Z=t[11],P=t[12],T=t[13],E=t[14],G=t[15],L=n*y+a*_+h*w+f*b,W=r*y+u*_+c*w+C*b,B=o*y+l*_+m*w+v*b,z=s*y+d*_+p*w+g*b,N=n*I+a*V+h*x+f*M,O=r*I+u*V+c*x+C*M,j=o*I+l*V+m*x+v*M,D=s*I+d*V+p*x+g*M,H=n*A+a*S+h*R+f*Z,F=r*A+u*S+c*R+C*Z,k=o*A+l*S+m*R+v*Z,Y=s*A+d*S+p*R+g*Z,X=n*P+a*T+h*E+f*G,K=r*P+u*T+c*E+C*G,U=o*P+l*T+m*E+v*G,Q=s*P+d*T+p*E+g*G;return i[0]=L,i[1]=W,i[2]=B,i[3]=z,i[4]=N,i[5]=O,i[6]=j,i[7]=D,i[8]=H,i[9]=F,i[10]=k,i[11]=Y,i[12]=X,i[13]=K,i[14]=U,i[15]=Q,i},J.add=function(e,t,i){return i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i[4]=e[4]+t[4],i[5]=e[5]+t[5],i[6]=e[6]+t[6],i[7]=e[7]+t[7],i[8]=e[8]+t[8],i[9]=e[9]+t[9],i[10]=e[10]+t[10],i[11]=e[11]+t[11],i[12]=e[12]+t[12],i[13]=e[13]+t[13],i[14]=e[14]+t[14],i[15]=e[15]+t[15],i},J.subtract=function(e,t,i){return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i[3]=e[3]-t[3],i[4]=e[4]-t[4],i[5]=e[5]-t[5],i[6]=e[6]-t[6],i[7]=e[7]-t[7],i[8]=e[8]-t[8],i[9]=e[9]-t[9],i[10]=e[10]-t[10],i[11]=e[11]-t[11],i[12]=e[12]-t[12],i[13]=e[13]-t[13],i[14]=e[14]-t[14],i[15]=e[15]-t[15],i},J.multiplyTransformation=function(e,t,i){var n=e[0],r=e[1],o=e[2],s=e[4],a=e[5],u=e[6],l=e[8],d=e[9],h=e[10],c=e[12],m=e[13],p=e[14],f=t[0],C=t[1],v=t[2],g=t[4],y=t[5],_=t[6],w=t[8],b=t[9],I=t[10],V=t[12],x=t[13],M=t[14],A=n*f+s*C+l*v,S=r*f+a*C+d*v,R=o*f+u*C+h*v,Z=n*g+s*y+l*_,P=r*g+a*y+d*_,T=o*g+u*y+h*_,E=n*w+s*b+l*I,G=r*w+a*b+d*I,L=o*w+u*b+h*I,W=n*V+s*x+l*M+c,B=r*V+a*x+d*M+m,z=o*V+u*x+h*M+p;return i[0]=A,i[1]=S,i[2]=R,i[3]=0,i[4]=Z,i[5]=P,i[6]=T,i[7]=0,i[8]=E,i[9]=G,i[10]=L,i[11]=0,i[12]=W,i[13]=B,i[14]=z,i[15]=1,i},J.multiplyByMatrix3=function(e,t,i){var n=e[0],r=e[1],o=e[2],s=e[4],a=e[5],u=e[6],l=e[8],d=e[9],h=e[10],c=t[0],m=t[1],p=t[2],f=t[3],C=t[4],v=t[5],g=t[6],y=t[7],_=t[8],w=n*c+s*m+l*p,b=r*c+a*m+d*p,I=o*c+u*m+h*p,V=n*f+s*C+l*v,x=r*f+a*C+d*v,M=o*f+u*C+h*v,A=n*g+s*y+l*_,S=r*g+a*y+d*_,R=o*g+u*y+h*_;return i[0]=w,i[1]=b,i[2]=I,i[3]=0,i[4]=V,i[5]=x,i[6]=M,i[7]=0,i[8]=A,i[9]=S,i[10]=R,i[11]=0,i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i},J.multiplyByTranslation=function(e,t,i){var n=t.x,r=t.y,o=t.z,s=n*e[0]+r*e[4]+o*e[8]+e[12],a=n*e[1]+r*e[5]+o*e[9]+e[13],u=n*e[2]+r*e[6]+o*e[10]+e[14];return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=s,i[13]=a,i[14]=u,i[15]=e[15],i};var O=new _;J.multiplyByUniformScale=function(e,t,i){return O.x=t,O.y=t,O.z=t,J.multiplyByScale(e,O,i)},J.multiplyByScale=function(e,t,i){var n=t.x,r=t.y,o=t.z;return 1===n&&1===r&&1===o?J.clone(e,i):(i[0]=n*e[0],i[1]=n*e[1],i[2]=n*e[2],i[3]=0,i[4]=r*e[4],i[5]=r*e[5],i[6]=r*e[6],i[7]=0,i[8]=o*e[8],i[9]=o*e[9],i[10]=o*e[10],i[11]=0,i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=1,i)},J.multiplyByVector=function(e,t,i){var n=t.x,r=t.y,o=t.z,s=t.w,a=e[0]*n+e[4]*r+e[8]*o+e[12]*s,u=e[1]*n+e[5]*r+e[9]*o+e[13]*s,l=e[2]*n+e[6]*r+e[10]*o+e[14]*s,d=e[3]*n+e[7]*r+e[11]*o+e[15]*s;return i.x=a,i.y=u,i.z=l,i.w=d,i},J.multiplyByPointAsVector=function(e,t,i){var n=t.x,r=t.y,o=t.z,s=e[0]*n+e[4]*r+e[8]*o,a=e[1]*n+e[5]*r+e[9]*o,u=e[2]*n+e[6]*r+e[10]*o;return i.x=s,i.y=a,i.z=u,i},J.multiplyByPoint=function(e,t,i){var n=t.x,r=t.y,o=t.z,s=e[0]*n+e[4]*r+e[8]*o+e[12],a=e[1]*n+e[5]*r+e[9]*o+e[13],u=e[2]*n+e[6]*r+e[10]*o+e[14];return i.x=s,i.y=a,i.z=u,i},J.multiplyByScalar=function(e,t,i){return i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i[4]=e[4]*t,i[5]=e[5]*t,i[6]=e[6]*t,i[7]=e[7]*t,i[8]=e[8]*t,i[9]=e[9]*t,i[10]=e[10]*t,i[11]=e[11]*t,i[12]=e[12]*t,i[13]=e[13]*t,i[14]=e[14]*t,i[15]=e[15]*t,i},J.negate=function(e,t){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=-e[7],t[8]=-e[8],t[9]=-e[9],t[10]=-e[10],t[11]=-e[11],t[12]=-e[12],t[13]=-e[13],t[14]=-e[14],t[15]=-e[15],t},J.transpose=function(e,t){var i=e[1],n=e[2],r=e[3],o=e[6],s=e[7],a=e[11];return t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=i,t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=n,t[9]=o,t[10]=e[10],t[11]=e[14],t[12]=r,t[13]=s,t[14]=a,t[15]=e[15],t},J.abs=function(e,t){return t[0]=Math.abs(e[0]),t[1]=Math.abs(e[1]),t[2]=Math.abs(e[2]),t[3]=Math.abs(e[3]),t[4]=Math.abs(e[4]),t[5]=Math.abs(e[5]),t[6]=Math.abs(e[6]),t[7]=Math.abs(e[7]),t[8]=Math.abs(e[8]),t[9]=Math.abs(e[9]),t[10]=Math.abs(e[10]),t[11]=Math.abs(e[11]),t[12]=Math.abs(e[12]),t[13]=Math.abs(e[13]),t[14]=Math.abs(e[14]),t[15]=Math.abs(e[15]),t},J.equals=function(e,t){return e===t||M(e)&&M(t)&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[3]===t[3]&&e[7]===t[7]&&e[11]===t[11]&&e[15]===t[15]},J.equalsEpsilon=function(e,t,i){return e===t||M(e)&&M(t)&&Math.abs(e[0]-t[0])<=i&&Math.abs(e[1]-t[1])<=i&&Math.abs(e[2]-t[2])<=i&&Math.abs(e[3]-t[3])<=i&&Math.abs(e[4]-t[4])<=i&&Math.abs(e[5]-t[5])<=i&&Math.abs(e[6]-t[6])<=i&&Math.abs(e[7]-t[7])<=i&&Math.abs(e[8]-t[8])<=i&&Math.abs(e[9]-t[9])<=i&&Math.abs(e[10]-t[10])<=i&&Math.abs(e[11]-t[11])<=i&&Math.abs(e[12]-t[12])<=i&&Math.abs(e[13]-t[13])<=i&&Math.abs(e[14]-t[14])<=i&&Math.abs(e[15]-t[15])<=i},J.getTranslation=function(e,t){return t.x=e[12],t.y=e[13],t.z=e[14],t},J.getMatrix3=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t};var j,D,H,q=new U,$=new U,ee=new K,te=new K(0,0,0,1);function F(e,t,i,n){return k(e).then(t,i,n)}function k(e){var t,i,n=e instanceof Y?e:re(e)?(t=ne(),e.then(function(e){t.resolve(e)},function(e){t.reject(e)},function(e){t.progress(e)}),t.promise):(i=e,new Y(function(e){try{return k(e?e(i):i)}catch(e){return ie(e)}}));return n}function Y(e){this.then=e}function ie(i){return new Y(function(e,t){try{return t?k(t(i)):ie(i)}catch(e){return ie(e)}})}function ne(){var e=new Y(r),s=[],a=[],n=function(t,i,n){var r=ne(),o="function"==typeof n?function(e){try{r.progress(n(e))}catch(e){r.progress(e)}}:function(e){r.progress(e)};return s.push(function(e){e.then(t,i).then(r.resolve,r.reject,o)}),a.push(o),r.promise},t=function(e){return ue(a,e),e},i=function(e){return e=k(e),n=e.then,i=k,t=de,ue(s,e),a=s=H,e};return{then:r,resolve:o,reject:u,progress:l,promise:e,resolver:{resolve:o,reject:u,progress:l}};function r(e,t,i){return n(e,t,i)}function o(e){return i(e)}function u(e){return i(ie(e))}function l(e){return t(e)}}function re(e){return e&&"function"==typeof e.then}function oe(e,m,p,f,C){return le(2,arguments),F(e,function(e){var t,i,n,r,o=e.length>>>0,s=Math.max(0,Math.min(m,o)),a=[],u=o-s+1,l=[],d=ne();if(s)for(n=d.progress,i=function(e){l.push(e),--u||(t=i=de,d.reject(l))},t=function(e){a.push(e),--s||(t=i=de,d.resolve(a))},r=0;r<o;++r)r in e&&F(e[r],c,h,n);else d.resolve(a);return d.then(p,f,C);function h(e){i(e)}function c(e){t(e)}})}function se(e,t,i,n){return le(1,arguments),ae(e,he).then(t,i,n)}function ae(e,a){return F(e,function(e){var t,i,n,r=t=e.length>>>0,o=[],s=ne();if(r)for(i=function(e,t){F(e,a).then(function(e){o[t]=e,--r||s.resolve(o)},s.reject)},n=0;n<t;n++)n in e?i(e[n],n):--r;else s.resolve(o);return s.promise})}function ue(e,t){for(var i,n=0;i=e[n++];)i(t)}function le(e,t){for(var i,n=t.length;e<n;)if(null!=(i=t[--n])&&"function"!=typeof i)throw new Error("arg "+n+" must be a function")}function de(){}function he(e){return e}function ce(e){e=Cesium.defaultValue(e,Cesium.defaultValue.EMPTY_OBJECT),this._clock=void 0,this._element=void 0,this._clockSubscription=void 0,this._seekFunction=void 0,this._lastPlaybackRate=void 0,this.clock=e.clock,this.element=e.element,this.epoch=Cesium.defaultValue(e.epoch,Cesium.Iso8601.MINIMUM_VALUE),this.tolerance=Cesium.defaultValue(e.tolerance,1),this._seeking=!1,this._seekFunction=void 0,this._firstTickAfterSeek=!1}function me(e){if(!M(e))throw new o("参数options不能为空。");if(!M(e.viewer))throw new o("Viewer对象options.viewer不能为空。");if(!M(e.videoElementID))throw new o("前端video容器的ID不能为空。");if(!M(e.originLon))throw new o("观察点经度不能为空。");if(!M(e.originLat))throw new o("观察点纬度不能为空。");if(!M(e.originHeight))throw new o("观察点高度不能为空。");if(!M(e.projection))throw new o("投影平面不能为空。");if(this._videoElement=document.getElementById(e.videoElementID),!this._videoElement||!(this._videoElement instanceof HTMLVideoElement||this._videoElement instanceof HTMLCanvasElement||this._videoElement instanceof HTMLImageElement))throw new o("ID为"+e.videoElementID+"元素并不是视频容器。");if(this._videoReadyPromise=F.defer(),this._show=Cesium.defaultValue(e.show,!0),this._alpha=Cesium.defaultValue(e.alpha,1),this._cameraDirty=!0,this._viewer=e.viewer,this._originLon=e.originLon,this._originLat=e.originLat,this._originHeight=e.originHeight,this._wsplayer=e.wsplayer,this._projection=new n(e.projection),this._pitch=Cesium.defaultValue(e.pitch,0),this._heading=Cesium.defaultValue(e.heading,0),this._roll=Cesium.defaultValue(e.roll,0),this._fov=Cesium.defaultValue(e.fov,60),this._slice=100,this._lineEnabled=Cesium.defaultValue(e.lineEnabled,!1),this._name=e.name,this._layer=e.layer,this._aspectRatio=void 0,this._projectionMode=0,this._lines=[],this._projectionCamera=void 0,this._adjustModeEnabled=!1,this._oldCameraPosition=void 0,this._oldHeading=void 0,this._oldPitch=void 0,this._oldRoll=void 0,this._oldFov=void 0,this._oldAspectRatio=void 0,this._scene=this._viewer.scene,this._hdr=this._scene._hdr,this._scene._hdr=!1,this._hsvParam=Cesium.defaultValue(e.hsvParam,new Cesium.Cartesian3(0,0,0)),this._distortion=Cesium.defaultValue(e.distortion,new Cesium.Cartesian2(0,0)),this._textureSize=Cesium.defaultValue(e.textureSize,new Cesium.Cartesian3(0,0,0)),this._lInfo=void 0,this._visibleDistance=-1,this._v=void 0,this._f=void 0,this._renderState=void 0,this._planeCommands=[],this._planeVisibility=[],this._projection._planes)for(var t=0;t<this._projection._planes.length;t++)this._planeCommands.push(new Cesium.DrawCommand({owner:this,pass:Cesium.Pass.OPAQUE})),this._planeVisibility.push(!0);this._videoElement instanceof HTMLVideoElement&&(this.incompatibleConsole(),this._viewer.clock.shouldAnimate=!0,this._synchronizer=new ce({clock:this._viewer.clock,element:this._videoElement}));this._viewer.scene.primitives.add(this)}function pe(e){this.wsserverurl=e.wsserver,this.mRtspurl=e.rtspurl,this.layer=e.layer,this.queue=[],this.mMediaplayer=e.mediaplayer,this.websocket=void 0,this.openws=this.openws.bind(this),this.stop=this.stop.bind(this),this.loadvideo=this.loadvideo.bind(this),this.onUpdateEnd=this.onUpdateEnd.bind(this),this.onCanPlay=this.onCanPlay.bind(this),this.onMediaSourceOpen=this.onMediaSourceOpen.bind(this),this.ByteArray(),this.needRecv=!0,this.mimestr=null,this.streamReady=!1,this.wsConnected=!1,this.playMode="",this.mCurrentTime=0,this.elementPaused=!1,this.dtTime=0,this.mInterval="",this.useCanvasValue=!1,this.mCanvas=void 0,this.faultTime=1,console.log("weplayer init")}J.inverse=function(e,t){var i=e[0],n=e[4],r=e[8],o=e[12],s=e[1],a=e[5],u=e[9],l=e[13],d=e[2],h=e[6],c=e[10],m=e[14],p=e[3],f=e[7],C=e[11],v=e[15],g=c*v,y=m*C,_=h*v,w=m*f,b=h*C,I=c*f,V=d*v,x=m*p,M=d*C,A=c*p,S=d*f,R=h*p,Z=g*a+w*u+b*l-(y*a+_*u+I*l),P=y*s+V*u+A*l-(g*s+x*u+M*l),T=_*s+x*a+S*l-(w*s+V*a+R*l),E=I*s+M*a+R*u-(b*s+A*a+S*u),G=y*n+_*r+I*o-(g*n+w*r+b*o),L=g*i+x*r+M*o-(y*i+V*r+A*o),W=w*i+V*n+R*o-(_*i+x*n+S*o),B=b*i+A*n+S*r-(I*i+M*n+R*r),z=(g=r*l)*f+(w=o*a)*C+(b=n*u)*v-((y=o*u)*f+(_=n*l)*C+(I=r*a)*v),N=y*p+(V=i*l)*C+(A=r*s)*v-(g*p+(x=o*s)*C+(M=i*u)*v),O=_*p+x*f+(S=i*a)*v-(w*p+V*f+(R=n*s)*v),j=I*p+M*f+R*C-(b*p+A*f+S*C),D=_*c+I*m+y*h-(b*m+g*h+w*c),H=M*m+g*d+x*c-(V*c+A*m+y*d),F=V*h+R*m+w*d-(S*m+_*d+x*h),k=S*c+b*d+A*h-(M*h+R*c+I*d),Y=i*Z+n*P+r*T+o*E;if(Math.abs(Y)<X.EPSILON21){if(U.equalsEpsilon(J.getMatrix3(e,q),$,X.EPSILON7)&&K.equals(J.getRow(e,3,ee),te))return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=0,t[11]=0,t[12]=-e[12],t[13]=-e[13],t[14]=-e[14],t[15]=1,t;throw new Q("matrix is not invertible because its determinate is zero.")}return Y=1/Y,t[0]=Z*Y,t[1]=P*Y,t[2]=T*Y,t[3]=E*Y,t[4]=G*Y,t[5]=L*Y,t[6]=W*Y,t[7]=B*Y,t[8]=z*Y,t[9]=N*Y,t[10]=O*Y,t[11]=j*Y,t[12]=D*Y,t[13]=H*Y,t[14]=F*Y,t[15]=k*Y,t},J.inverseTransformation=function(e,t){var i=e[0],n=e[1],r=e[2],o=e[4],s=e[5],a=e[6],u=e[8],l=e[9],d=e[10],h=e[12],c=e[13],m=e[14],p=-i*h-n*c-r*m,f=-o*h-s*c-a*m,C=-u*h-l*c-d*m;return t[0]=i,t[1]=o,t[2]=u,t[3]=0,t[4]=n,t[5]=s,t[6]=l,t[7]=0,t[8]=r,t[9]=a,t[10]=d,t[11]=0,t[12]=p,t[13]=f,t[14]=C,t[15]=1,t},J.IDENTITY=Object.freeze(new J(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)),J.ZERO=Object.freeze(new J(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)),J.COLUMN0ROW0=0,J.COLUMN0ROW1=1,J.COLUMN0ROW2=2,J.COLUMN0ROW3=3,J.COLUMN1ROW0=4,J.COLUMN1ROW1=5,J.COLUMN1ROW2=6,J.COLUMN1ROW3=7,J.COLUMN2ROW0=8,J.COLUMN2ROW1=9,J.COLUMN2ROW2=10,J.COLUMN2ROW3=11,J.COLUMN3ROW0=12,J.COLUMN3ROW1=13,J.COLUMN3ROW2=14,J.COLUMN3ROW3=15,Object.defineProperties(J.prototype,{length:{get:function(){return J.packedLength}}}),J.prototype.clone=function(e){return J.clone(this,e)},J.prototype.equals=function(e){return J.equals(this,e)},J.equalsArray=function(e,t,i){return e[0]===t[i]&&e[1]===t[i+1]&&e[2]===t[i+2]&&e[3]===t[i+3]&&e[4]===t[i+4]&&e[5]===t[i+5]&&e[6]===t[i+6]&&e[7]===t[i+7]&&e[8]===t[i+8]&&e[9]===t[i+9]&&e[10]===t[i+10]&&e[11]===t[i+11]&&e[12]===t[i+12]&&e[13]===t[i+13]&&e[14]===t[i+14]&&e[15]===t[i+15]},J.prototype.equalsEpsilon=function(e,t){return J.equalsEpsilon(this,e,t)},J.prototype.toString=function(){return"("+this[0]+", "+this[4]+", "+this[8]+", "+this[12]+")\n("+this[1]+", "+this[5]+", "+this[9]+", "+this[13]+")\n("+this[2]+", "+this[6]+", "+this[10]+", "+this[14]+")\n("+this[3]+", "+this[7]+", "+this[11]+", "+this[15]+")"},F.defer=ne,F.resolve=k,F.reject=function(e){return F(e,ie)},F.join=function(){return ae(arguments,he)},F.all=se,F.map=ae,F.reduce=function(e,o){var t=D.call(arguments,1);return F(e,function(e){var r=e.length;return t[0]=function(e,i,n){return F(e,function(t){return F(i,function(e){return o(t,e,n,r)})})},j.apply(e,t)})},F.any=function(e,t,i,n){return oe(e,1,function(e){return t?t(e[0]):e[0]},i,n)},F.some=oe,F.chain=function(e,t,i){var n=2<arguments.length;return F(e,function(e){return e=n?i:e,t.resolve(e),e},function(e){return t.reject(e),ie(e)},t.progress)},F.isPromise=re,Y.prototype={always:function(e,t){return this.then(e,e,t)},otherwise:function(e){return this.then(H,e)},yield:function(e){return this.then(function(){return e})},spread:function(t){return this.then(function(e){return se(e,function(e){return t.apply(H,e)})})}},D=[].slice,j=[].reduce||function(e){var t,i=0,n=Object(this),r=n.length>>>0,o=arguments;if(o.length<=1)for(;;){if(i in n){t=n[i++];break}if(++i>=r)throw new TypeError}else t=o[1];for(;i<r;++i)i in n&&(t=e(t,n[i],i,n));return t},Object.defineProperties(ce.prototype,{clock:{get:function(){return this._clock},set:function(e){var t=this._clock;t!==e&&(Cesium.defined(t)&&(this._clockSubscription(),this._clockSubscription=void 0),Cesium.defined(e)&&(this._clockSubscription=e.onTick.addEventListener(ce.prototype._onTick,this)),this._clock=e)}},element:{get:function(){return this._element},set:function(e){var t,i=this._element;i!==e&&(Cesium.defined(i)&&i.removeEventListener("seeked",this._seekFunction,!1),Cesium.defined(e)&&(this._seeking=!1,this._seekFunction=(t=this,function(){t._seeking=!1,t._firstTickAfterSeek=!0}),e.addEventListener("seeked",this._seekFunction,!1)),this._element=e,this._seeking=!1,this._firstTickAfterSeek=!1)}}}),ce.prototype.destroy=function(){return this.element=void 0,this.clock=void 0,Cesium.destroyObject(this)},ce.prototype.isDestroyed=function(){return!1},ce.prototype._trySetPlaybackRate=function(e){if(this._lastPlaybackRate!==e.multiplier){var t=this._element;try{t.playbackRate=e.multiplier}catch(e){t.playbackRate=0}this._lastPlaybackRate=e.multiplier}},ce.prototype._onTick=function(e){var t,i,n,r,o,s,a,u=this._element;!Cesium.defined(u)||u.readyState<2||(t=u.paused,(i=e.shouldAnimate)===t&&(i?u.play():u.pause()),this._seeking||this._firstTickAfterSeek?this._firstTickAfterSeek=!1:(this._trySetPlaybackRate(e),n=(new Date).getTime()/1e3,r=u.duration,o=u.currentTime,s=u.loop?((n%=r)<0&&(n=r-n),n):r<n?r:n<0?0:n,a=i?Cesium.defaultValue(this.tolerance,1):.001,Math.abs(s-o)>a&&(this._seeking=!0,u.currentTime=s)))},me.prototype.update=function(e){var i=this;if(this._show&&e.mode===Cesium.SceneMode.SCENE3D&&e.passes.render){var t=-1;if(this._layer&&0<this._layer.visibleDistance&&(t=this._layer.visibleDistance),0<this._visibleDistance&&(t=this._visibleDistance),0<t&&0<this._planeCommands.length)for(var n,r,o,s=0;s<this._planeCommands.length;s++){(m=this._planeCommands[s]).boundingVolume&&(n=m.boundingVolume.center,r=this._scene.camera.positionWC,o=Cesium.Cartesian3.distance(n,r),this._planeVisibility[s]=!(t<o))}var a=0;if(0<this._planeVisibility.length)for(s=0;s<this._planeVisibility.length;s++)this._planeVisibility[s]||a++;if(a!==this._planeVisibility.length){var u=e.context;this._context=u;var l,d,h=e.commandList;if(this._videoElement instanceof HTMLVideoElement&&!(2<=this._videoElement.readyState)||(M(this._texture)?this._videoElement instanceof HTMLVideoElement||this._texture._height===this._videoElement.height&&this._texture._width===this._videoElement.width?this._texture.copyFrom(this._videoElement):(this._texture.destroy(),this._texture=new Cesium.Texture({context:u,source:this._videoElement,sampler:new Cesium.Sampler({wrapS:Cesium.TextureWrap.CLAMP_TO_EDGE,wrapT:Cesium.TextureWrap.CLAMP_TO_EDGE,minificationFilter:Cesium.TextureMinificationFilter.LINEAR,magnificationFilter:Cesium.TextureMagnificationFilter.LINEAR})}),this._cameraDirty=!0):(this._texture=new Cesium.Texture({context:u,source:this._videoElement,sampler:new Cesium.Sampler({wrapS:Cesium.TextureWrap.CLAMP_TO_EDGE,wrapT:Cesium.TextureWrap.CLAMP_TO_EDGE,minificationFilter:Cesium.TextureMinificationFilter.LINEAR,magnificationFilter:Cesium.TextureMagnificationFilter.LINEAR})}),this._videoReadyPromise.resolve(this))),M(this._texture)){this._textureSize=new Cesium.Cartesian3(this._texture._width,this._texture._height,0),M(this._v)&&M(this._f)||(l=atob("YXR0cmlidXRlIHZlYzMgcG9zaXRpb247CnZhcnlpbmcgdmVjMyB2X3Bvc2l0aW9uRUM7CnZvaWQgbWFpbigpCnsKICAgIGdsX1Bvc2l0aW9uID0gY3ptX21vZGVsVmlld1Byb2plY3Rpb24gKiB2ZWM0KHBvc2l0aW9uLCAxLjApOwogICAgdl9wb3NpdGlvbkVDID0gKGN6bV9tb2RlbFZpZXcgKiB2ZWM0KHBvc2l0aW9uLCAxLjApKS54eXo7Cn0K"),this._v=new Cesium.ShaderSource({sources:[l]}),d=atob("dW5pZm9ybSBmbG9hdCB1X2xlZnRDbGlwOwp1bmlmb3JtIGZsb2F0IHVfcmlnaHRDbGlwOwp1bmlmb3JtIHZlYzQgdV90b3BDbGlwTGluZTE7CnVuaWZvcm0gdmVjNCB1X3RvcENsaXBMaW5lMjsKdW5pZm9ybSB2ZWM0IHVfdG9wQ2xpcExpbmUzOwp1bmlmb3JtIHZlYzQgdV90b3BDbGlwTGluZTQ7CnVuaWZvcm0gdmVjNCB1X2JvdHRvbUNsaXBMaW5lMTsKdW5pZm9ybSB2ZWM0IHVfYm90dG9tQ2xpcExpbmUyOwp1bmlmb3JtIHZlYzQgdV9ib3R0b21DbGlwTGluZTM7CnVuaWZvcm0gdmVjNCB1X2JvdHRvbUNsaXBMaW5lNDsKdW5pZm9ybSBmbG9hdCB1X2FscGhhOwp1bmlmb3JtIHZlYzMgdV9oc3ZQYXJhbTsKdW5pZm9ybSBtYXQ0IHVfcHJvamVjdGlvbkNhbWVyYVZpZXdNYXRyaXg7CnVuaWZvcm0gbWF0NCB1X3Byb2plY3Rpb25DYW1lcmFQcm9qZWN0aW9uTWF0cml4Owp1bmlmb3JtIHNhbXBsZXIyRCB1X3RleHR1cmU7CnVuaWZvcm0gZmxvYXQgazE7CnVuaWZvcm0gZmxvYXQgazI7CnVuaWZvcm0gdmVjMyB0ZXh0dXJlU2l6ZTsKdmFyeWluZyB2ZWMzIHZfcG9zaXRpb25FQzsKCnZlYzMgcmdiMmhzdih2ZWMzIGMpCnsKICAgIHZlYzQgSyA9IHZlYzQoMC4wLCAtMS4wLzMuMCwgMi4wLzMuMCwgLTEuMCk7CiAgICB2ZWM0IHAgPSBtaXgodmVjNChjLmJnLCBLLnd6KSwgdmVjNChjLmdiLCBLLnh5KSwgc3RlcChjLmIsIGMuZykpOwogICAgdmVjNCBxID0gbWl4KHZlYzQocC54eXcsIGMuciksIHZlYzQoYy5yLCBwLnl6eCksIHN0ZXAocC54LCBjLnIpKTsKICAgIGZsb2F0IGQgPSBxLnggLSBtaW4ocS53LCBxLnkpOwogICAgZmxvYXQgZSA9IDEuMGUtMTA7CiAgICByZXR1cm4gdmVjMyhhYnMocS56ICsgKHEudyAtIHEueSkvKDYuMCpkK2UpKSwgZC8ocS54ICsgZSksIHEueCk7Cn0KCnZlYzMgaHN2MnJnYih2ZWMzIGMpCnsKICAgIHZlYzQgSyA9IHZlYzQoMS4wLCAyLjAvMy4wLCAxLjAvMy4wLCAzLjApOwogICAgdmVjMyBwID0gYWJzKGZyYWN0KGMueHh4ICsgSy54eXopICogNi4wIC0gSy53d3cpOwogICAgcmV0dXJuIGMueiAqIG1peChLLnh4eCwgY2xhbXAocCAtIEsueHh4LCAwLjAsIDEuMCksIGMueSk7Cn0KCnZvaWQgbWFpbigpCnsKICAgIHZlYzQgcGl4ZWxDb29yZCA9IHVfcHJvamVjdGlvbkNhbWVyYVByb2plY3Rpb25NYXRyaXggKiB1X3Byb2plY3Rpb25DYW1lcmFWaWV3TWF0cml4ICogdmVjNCh2X3Bvc2l0aW9uRUMsIDEuMCk7CiAgICBwaXhlbENvb3JkID0gcGl4ZWxDb29yZCAvIHBpeGVsQ29vcmQudzsKICAgIHZlYzIgdGV4Q29vcmQgPSB2ZWMyKDAuNSwgMC41KSArIHBpeGVsQ29vcmQueHkgKiAwLjU7CiAgICBmbG9hdCBtYXhXaWR0aEhlaWdodCA9IHRleHR1cmVTaXplLng7CiAgICBmbG9hdCBwZXJjZW50ID0gdGV4dHVyZVNpemUueSAvIHRleHR1cmVTaXplLng7CiAgICB2ZWMyIGNlbnRlclVWID0gdmVjMigodGV4dHVyZVNpemUueCAvIDIuMCkgLyBtYXhXaWR0aEhlaWdodCwgKHRleHR1cmVTaXplLnkgLyAyLjApIC8gbWF4V2lkdGhIZWlnaHQpOwogICAgdmVjMiBjdXJyZW50VVYgPSB2ZWMyKHRleENvb3JkLngsIHRleENvb3JkLnkgKiBwZXJjZW50KTsKICAgIGZsb2F0IGxlbmd0aF8yID0gKGN1cnJlbnRVVi54IC0gY2VudGVyVVYueCkgKiAoY3VycmVudFVWLnggLSBjZW50ZXJVVi54KSArIChjdXJyZW50VVYueSAtIGNlbnRlclVWLnkpICogKGN1cnJlbnRVVi55IC0gY2VudGVyVVYueSk7CiAgICBmbG9hdCBsZW5ndGhfNCA9IGxlbmd0aF8yICogbGVuZ3RoXzI7CiAgICB0ZXhDb29yZC54ID0gKGN1cnJlbnRVVi54IC0gY2VudGVyVVYueCkgLyAoazEgKiBsZW5ndGhfMiArIGsyICogbGVuZ3RoXzQgKyAxLjApICsgY2VudGVyVVYueDsKICAgIHRleENvb3JkLnkgPSAoY3VycmVudFVWLnkgLSBjZW50ZXJVVi55KSAvIChrMSAqIGxlbmd0aF8yICsgazIgKiBsZW5ndGhfNCArIDEuMCkgKyBjZW50ZXJVVi55OwogICAgdGV4Q29vcmQueSA9IHRleENvb3JkLnkgLyBwZXJjZW50OwogICAgaWYodGV4Q29vcmQueCA8IHVfbGVmdENsaXApCiAgICB7CiAgICBkaXNjYXJkOwogICAgfQogICAgaWYodGV4Q29vcmQueCA+IHVfcmlnaHRDbGlwKQogICAgewogICAgZGlzY2FyZDsKICAgIH0KICAgIGZsb2F0IGtUb3AxID0gKHVfdG9wQ2xpcExpbmUxLncgLSB1X3RvcENsaXBMaW5lMS55KSAvICh1X3RvcENsaXBMaW5lMS56IC0gdV90b3BDbGlwTGluZTEueCk7CiAgICBmbG9hdCBhVG9wMSA9IC0xLjAgKiBrVG9wMTsKICAgIGZsb2F0IGJUb3AxID0gMS4wOwogICAgZmxvYXQgY1RvcDEgPSBrVG9wMSAqIHVfdG9wQ2xpcExpbmUxLnggLSB1X3RvcENsaXBMaW5lMS55OwogICAgZmxvYXQgclRvcDEgPSBkb3QodmVjMyhhVG9wMSwgYlRvcDEsIGNUb3AxKSwgdmVjMyh0ZXhDb29yZCwgMS4wKSk7CiAgICBpZihyVG9wMSA+IDAuMCkKICAgIHsKICAgIGRpc2NhcmQ7CiAgICB9CiAgICBmbG9hdCBrVG9wMiA9ICh1X3RvcENsaXBMaW5lMi53IC0gdV90b3BDbGlwTGluZTIueSkgLyAodV90b3BDbGlwTGluZTIueiAtIHVfdG9wQ2xpcExpbmUyLngpOwogICAgZmxvYXQgYVRvcDIgPSAtMS4wICoga1RvcDI7CiAgICBmbG9hdCBiVG9wMiA9IDEuMDsKICAgIGZsb2F0IGNUb3AyID0ga1RvcDIgKiB1X3RvcENsaXBMaW5lMi54IC0gdV90b3BDbGlwTGluZTIueTsKICAgIGZsb2F0IHJUb3AyID0gZG90KHZlYzMoYVRvcDIsIGJUb3AyLCBjVG9wMiksIHZlYzModGV4Q29vcmQsIDEuMCkpOwogICAgaWYoclRvcDIgPiAwLjApCiAgICB7CiAgICBkaXNjYXJkOwogICAgfQogICAgZmxvYXQga1RvcDMgPSAodV90b3BDbGlwTGluZTMudyAtIHVfdG9wQ2xpcExpbmUzLnkpIC8gKHVfdG9wQ2xpcExpbmUzLnogLSB1X3RvcENsaXBMaW5lMy54KTsKICAgIGZsb2F0IGFUb3AzID0gLTEuMCAqIGtUb3AzOwogICAgZmxvYXQgYlRvcDMgPSAxLjA7CiAgICBmbG9hdCBjVG9wMyA9IGtUb3AzICogdV90b3BDbGlwTGluZTMueCAtIHVfdG9wQ2xpcExpbmUzLnk7CiAgICBmbG9hdCByVG9wMyA9IGRvdCh2ZWMzKGFUb3AzLCBiVG9wMywgY1RvcDMpLCB2ZWMzKHRleENvb3JkLCAxLjApKTsKICAgIGlmKHJUb3AzID4gMC4wKQogICAgewogICAgZGlzY2FyZDsKICAgIH0KICAgIGZsb2F0IGtUb3A0ID0gKHVfdG9wQ2xpcExpbmU0LncgLSB1X3RvcENsaXBMaW5lNC55KSAvICh1X3RvcENsaXBMaW5lNC56IC0gdV90b3BDbGlwTGluZTQueCk7CiAgICBmbG9hdCBhVG9wNCA9IC0xLjAgKiBrVG9wNDsKICAgIGZsb2F0IGJUb3A0ID0gMS4wOwogICAgZmxvYXQgY1RvcDQgPSBrVG9wNCAqIHVfdG9wQ2xpcExpbmU0LnggLSB1X3RvcENsaXBMaW5lNC55OwogICAgZmxvYXQgclRvcDQgPSBkb3QodmVjMyhhVG9wNCwgYlRvcDQsIGNUb3A0KSwgdmVjMyh0ZXhDb29yZCwgMS4wKSk7CiAgICBpZihyVG9wNCA+IDAuMCkKICAgIHsKICAgIGRpc2NhcmQ7CiAgICB9CiAgICBmbG9hdCBrQm90dG9tMSA9ICh1X2JvdHRvbUNsaXBMaW5lMS53IC0gdV9ib3R0b21DbGlwTGluZTEueSkgLyAodV9ib3R0b21DbGlwTGluZTEueiAtIHVfYm90dG9tQ2xpcExpbmUxLngpOwogICAgZmxvYXQgYUJvdHRvbTEgPSAtMS4wICoga0JvdHRvbTE7CiAgICBmbG9hdCBiQm90dG9tMSA9IDEuMDsKICAgIGZsb2F0IGNCb3R0b20xID0ga0JvdHRvbTEgKiB1X2JvdHRvbUNsaXBMaW5lMS54IC0gdV9ib3R0b21DbGlwTGluZTEueTsKICAgIGZsb2F0IHJCb3R0b20xID0gZG90KHZlYzMoYUJvdHRvbTEsIGJCb3R0b20xLCBjQm90dG9tMSksIHZlYzModGV4Q29vcmQsIDEuMCkpOwogICAgaWYockJvdHRvbTEgPCAwLjApCiAgICB7CiAgICBkaXNjYXJkOwogICAgfQogICAgZmxvYXQga0JvdHRvbTIgPSAodV9ib3R0b21DbGlwTGluZTIudyAtIHVfYm90dG9tQ2xpcExpbmUyLnkpIC8gKHVfYm90dG9tQ2xpcExpbmUyLnogLSB1X2JvdHRvbUNsaXBMaW5lMi54KTsKICAgIGZsb2F0IGFCb3R0b20yID0gLTEuMCAqIGtCb3R0b20yOwogICAgZmxvYXQgYkJvdHRvbTIgPSAxLjA7CiAgICBmbG9hdCBjQm90dG9tMiA9IGtCb3R0b20yICogdV9ib3R0b21DbGlwTGluZTIueCAtIHVfYm90dG9tQ2xpcExpbmUyLnk7CiAgICBmbG9hdCByQm90dG9tMiA9IGRvdCh2ZWMzKGFCb3R0b20yLCBiQm90dG9tMiwgY0JvdHRvbTIpLCB2ZWMzKHRleENvb3JkLCAxLjApKTsKICAgIGlmKHJCb3R0b20yIDwgMC4wKQogICAgewogICAgZGlzY2FyZDsKICAgIH0KICAgIGZsb2F0IGtCb3R0b20zID0gKHVfYm90dG9tQ2xpcExpbmUzLncgLSB1X2JvdHRvbUNsaXBMaW5lMy55KSAvICh1X2JvdHRvbUNsaXBMaW5lMy56IC0gdV9ib3R0b21DbGlwTGluZTMueCk7CiAgICBmbG9hdCBhQm90dG9tMyA9IC0xLjAgKiBrQm90dG9tMzsKICAgIGZsb2F0IGJCb3R0b20zID0gMS4wOwogICAgZmxvYXQgY0JvdHRvbTMgPSBrQm90dG9tMyAqIHVfYm90dG9tQ2xpcExpbmUzLnggLSB1X2JvdHRvbUNsaXBMaW5lMy55OwogICAgZmxvYXQgckJvdHRvbTMgPSBkb3QodmVjMyhhQm90dG9tMywgYkJvdHRvbTMsIGNCb3R0b20zKSwgdmVjMyh0ZXhDb29yZCwgMS4wKSk7CiAgICBpZihyQm90dG9tMyA8IDAuMCkKICAgIHsKICAgIGRpc2NhcmQ7CiAgICB9CiAgICBmbG9hdCBrQm90dG9tNCA9ICh1X2JvdHRvbUNsaXBMaW5lNC53IC0gdV9ib3R0b21DbGlwTGluZTQueSkgLyAodV9ib3R0b21DbGlwTGluZTQueiAtIHVfYm90dG9tQ2xpcExpbmU0LngpOwogICAgZmxvYXQgYUJvdHRvbTQgPSAtMS4wICoga0JvdHRvbTQ7CiAgICBmbG9hdCBiQm90dG9tNCA9IDEuMDsKICAgIGZsb2F0IGNCb3R0b200ID0ga0JvdHRvbTQgKiB1X2JvdHRvbUNsaXBMaW5lNC54IC0gdV9ib3R0b21DbGlwTGluZTQueTsKICAgIGZsb2F0IHJCb3R0b200ID0gZG90KHZlYzMoYUJvdHRvbTQsIGJCb3R0b200LCBjQm90dG9tNCksIHZlYzModGV4Q29vcmQsIDEuMCkpOwogICAgaWYockJvdHRvbTQgPCAwLjApCiAgICB7CiAgICBkaXNjYXJkOwogICAgfQogICAgdmVjNCBjb2xvciA9IHRleHR1cmUyRCh1X3RleHR1cmUsIHRleENvb3JkKTsKICAgIHZlYzMgcmdiID0gY29sb3IueHl6OwogICAgdmVjMyBoc3YgPSByZ2IyaHN2KHJnYik7CiAgICBoc3YgKz0gdV9oc3ZQYXJhbTsKICAgIHJnYiA9IGhzdjJyZ2IoaHN2KTsKICAgIHJnYiA9IGNsYW1wKHJnYiwgMC4wLCAxLjApOwogICAgY29sb3IueHl6ID0gcmdiOwogICAgY29sb3IuYSA9IHVfYWxwaGE7CiAgICBnbF9GcmFnQ29sb3IgPSBjb2xvcjsKfQo="),this._f=new Cesium.ShaderSource({sources:[d]})),this._renderState||(this._renderState=Cesium.RenderState.fromCache({blending:Cesium.BlendingState.ALPHA_BLEND,cull:{enabled:!0,face:Cesium.CullFace.BACK},depthTest:{enabled:!0}}));var c=[];if(this._cameraDirty){0<this._projection._planes.length&&this.computePlaneEndPoint(),this.removeLines();for(s=0;s<this._projection._planes.length;s++)this.addLines(this._projection._planes[s]._initialPointsList);this.updatePlaneVertex(),this._cameraDirty=!1}for(s=0;s<this._planeCommands.length;s++){c.length=0;var m=this._planeCommands[s],p=s;if(m&&!M(m.vertexArray)){m.uniformMap={u_texture:function(){return i._texture},u_hsvParam:function(){return i._hsvParam},k1:function(){return i._distortion.x},k2:function(){return i._distortion.y},textureSize:function(){return i._textureSize},u_alpha:function(){return i._alpha},u_projectionCameraViewMatrix:function(){var e=i._viewer.scene.camera.inverseViewMatrix,t=new Cesium.Matrix4;return J.multiply(i._projectionCamera.viewMatrix,e,t),t},u_projectionCameraProjectionMatrix:function(){return i._projectionCamera.frustum.projectionMatrix},u_leftClip:function(){return i._projection._planes[p]._leftClip},u_rightClip:function(){return i._projection._planes[p]._rightClip},u_topClipLine1:function(){return i._projection._planes[p]._topClipLine1},u_topClipLine2:function(){return i._projection._planes[p]._topClipLine2},u_topClipLine3:function(){return i._projection._planes[p]._topClipLine3},u_topClipLine4:function(){return i._projection._planes[p]._topClipLine4},u_bottomClipLine1:function(){return i._projection._planes[p]._bottomClipLine1},u_bottomClipLine2:function(){return i._projection._planes[p]._bottomClipLine2},u_bottomClipLine3:function(){return i._projection._planes[p]._bottomClipLine3},u_bottomClipLine4:function(){return i._projection._planes[p]._bottomClipLine4}};for(var f=0;f<i._projection._planes[p]._pointsList.length;f++){var C=i._projection._planes[p]._pointsList[f];c.push(C.x),c.push(C.y),c.push(C.z)}var v,g,y=this._createGeometry(c,i._projection._planes[p]._centerPostion,i._projection._planes[p]._indicesList);y&&(v=Cesium.GeometryPipeline.createAttributeLocations(y),m.vertexArray=Cesium.VertexArray.fromGeometry({context:u,geometry:y,attributeLocations:v,bufferUsage:Cesium.BufferUsage.STATIC_DRAW}),m.renderState=this._renderState,g=Cesium.Cartesian3.fromDegrees(this._projection._planes[p]._centerPostion.x,this._projection._planes[p]._centerPostion.y,this._projection._planes[p]._centerPostion.z),m.modelMatrix=Cesium.Matrix4.fromTranslation(g),m.boundingVolume=Cesium.BoundingSphere.transform(y.boundingSphere,m.modelMatrix,m.boundingVolume),M(m.shaderProgram)||(m.shaderProgram=Cesium.ShaderProgram.fromCache({context:u,vertexShaderSource:this._v,fragmentShaderSource:this._f,attributeLocations:v})))}this._planeVisibility[s]&&m&&m.vertexArray&&e.passes.render&&h.push(m)}}}}},me.prototype._createGeometry=function(e,t,i){if(0!=e.length&&0!=i.length){t=Cesium.Cartesian3.fromDegrees(t.x,t.y,t.z);for(var n=(this._slice+1)*(this._slice+1),r=new Float64Array(3*n),o=6*this._slice*this._slice,s=Cesium.IndexDatatype.createTypedArray(n,o),a=0,u=0;u<e.length/3;u++){var l=new Cesium.Cartesian3,d=Cesium.Cartesian3.fromDegrees(e[3*u+0],e[3*u+1],e[3*u+2]);Cesium.Cartesian3.subtract(d,t,l),r[a++]=l.x,r[a++]=l.y,r[a++]=l.z}for(var h=0,u=0;u<i.length;u++)s[h++]=i[u];var c=new Cesium.GeometryAttributes;c.position=new Cesium.GeometryAttribute({componentDatatype:Cesium.ComponentDatatype.DOUBLE,componentsPerAttribute:3,values:r});var m=Cesium.BoundingSphere.fromVertices(r);return new Cesium.Geometry({attributes:c,indices:s,primitiveType:Cesium.PrimitiveType.TRIANGLES,boundingSphere:m})}},me.prototype.updateParameter=function(e){M(e.originLon)&&(this._originLon=e.originLon),M(e.originLat)&&(this._originLat=e.originLat),M(e.originHeight)&&(this._originHeight=e.originHeight),M(e.pitch)&&(this._pitch=e.pitch),M(e.heading)&&(this._heading=e.heading),M(e.roll)&&(this._roll=e.roll),M(e.fov)&&(this._fov=e.fov),M(e.hsvParam)&&(this._hsvParam=e.hsvParam),M(e.distortion)&&(this._distortion=e.distortion),M(e.alpha)&&(this._alpha=e.alpha),M(e.lineEnabled)&&(this._lineEnabled=e.lineEnabled),this._cameraDirty=!0},me.prototype.computePlaneEndPoint=function(){var e,t;this._texture&&(this._aspectRatio=this._texture._width/this._texture._height,e=Cesium.Cartesian3.fromDegrees(this._originLon,this._originLat,this._originHeight),this._projectionCamera||(this._projectionCamera=new Cesium.Camera(this._viewer.scene)),(t=this._projectionCamera.frustum).fov=X.toRadians(this._fov),t.aspectRatio=this._aspectRatio,t.near=.1,t.far=1e3,this._projectionCamera.setView({destination:e,orientation:{heading:X.toRadians(this._heading),pitch:X.toRadians(this._pitch),roll:X.toRadians(this._roll)}}),this._adjustModeEnabled&&(this._viewer.scene.camera.setView({destination:e,orientation:{heading:X.toRadians(this._heading),pitch:X.toRadians(this._pitch),roll:X.toRadians(this._roll)}}),this._viewer.scene.camera.frustum.fov=X.toRadians(this._fov),this._viewer.scene.camera.frustum.aspectRatio=this._aspectRatio),t._fovy=t.aspectRatio<=1?t.fov:2*Math.atan(Math.tan(.5*t.fov)/t.aspectRatio),t.top=t.near*Math.tan(.5*t._fovy),t.bottom=-t.top,t.right=t.aspectRatio*t.top,t.left=-t.right)},me.prototype.enterAdjustMode=function(){var e;this._adjustModeEnabled||(this._adjustModeEnabled=!0,e=this._viewer.scene.camera,this._oldHeading=e.heading,this._oldPitch=e.pitch,this._oldRoll=e.roll,this._oldFov=e.frustum.fov,this._oldAspectRatio=e.frustum.aspectRatio,this._oldCameraPosition=e.positionWC.clone(),this.updateParameter({}))},me.prototype.exitAdjustMode=function(){var e;this._adjustModeEnabled&&(this._adjustModeEnabled=!1,(e=this._viewer.scene.camera).setView({destination:this._oldCameraPosition,orientation:{heading:this._oldHeading,pitch:this._oldPitch,roll:this._oldRoll}}),e.frustum.fov=this._oldFov,e.frustum.aspectRatio=this._oldAspectRatio)},me.videoStatus=void 0,me.prototype.removeLines=function(){if(this._lineEnabled){for(var e=0;e<this._lines.length;e++)this._viewer.entities.remove(this._lines[e]);this._lines.length=0}},me.prototype.addLines=function(e){if(this._lineEnabled&&0!==e.length){for(var t,i=new Cesium.Cartesian3,n=0;n<e.length;n++)i.x=i.x+e[n].x,i.y=i.y+e[n].y,i.z=i.z+e[n].z,t=n!==e.length-1?this._viewer.entities.add({polyline:{positions:Cesium.Cartesian3.fromDegreesArrayHeights([e[n].x,e[n].y,e[n].z,e[n+1].x,e[n+1].y,e[n+1].z]),width:1,material:Cesium.Color.BLUE,arcType:Cesium.ArcType.NONE}}):this._viewer.entities.add({polyline:{positions:Cesium.Cartesian3.fromDegreesArrayHeights([e[n].x,e[n].y,e[n].z,e[0].x,e[0].y,e[0].z]),width:1,material:Cesium.Color.BLUE,arcType:Cesium.ArcType.NONE}}),this._lines.push(t);i.x=i.x/e.length,i.y=i.y/e.length,i.z=i.z/e.length,t=this._viewer.entities.add({polyline:{positions:Cesium.Cartesian3.fromDegreesArrayHeights([i.x,i.y,i.z,this._originLon,this._originLat,this._originHeight]),width:1,material:Cesium.Color.RED,arcType:Cesium.ArcType.NONE}}),this._lines.push(t)}},me.prototype.updatePlaneVertex=function(){for(var e=[],t=this._planeCommands,i=0;i<t.length;i++){e.length=0;var n=t[i];if(n&&n.vertexArray){n.vertexArray.destroy(),n.vertexArray=void 0;for(var r=0;r<this._projection._planes[i]._pointsList;r++){var o=this._projection._planes[i]._pointsList[r];e.push(o.x),e.push(o.y),e.push(o.z)}var s,a=this._createGeometry(e,this._projection._planes[i]._centerPostion,this._projection._planes[i]._indicesList);a&&(s=Cesium.GeometryPipeline.createAttributeLocations(a),n.vertexArray=Cesium.VertexArray.fromGeometry({context:this._context,geometry:a,attributeLocations:s,bufferUsage:Cesium.BufferUsage.STATIC_DRAW}),n.modelMatrix=Cesium.Matrix4.fromTranslation(this._projection._planes[i]._centerPostion),n.boundingVolume=Cesium.BoundingSphere.transform(a.boundingSphere,n.modelMatrix,n.boundingVolume),n.shaderProgram=Cesium.ShaderProgram.fromCache({context:this._context,vertexShaderSource:this._v,fragmentShaderSource:this._f,attributeLocations:s}))}}},me.prototype.destroy=function(){var e;this._scene._hdr=this._hdr,this.removeLines(),!this._viewer.scene.primitives.contains(this)||-1!==(e=this._viewer.scene.primitives._primitives.indexOf(this))&&(this._viewer.scene.primitives._primitives.splice(e,1),delete this._external._composites[this._viewer.scene.primitives._guid]);for(var t=0;t<this._planeCommands.length;t++){var i=this._planeCommands[t];i.vertexArray=i.vertexArray&&i.vertexArray.destroy(),i.shaderProgram=i.shaderProgram&&i.shaderProgram.destroy()}this._planeCommands.length=0,this._texture&&(this._texture.destroy(),this._texture=void 0),this._synchronizer&&(this._synchronizer.destroy(),this._synchronizer=void 0)},me.prototype.incompatibleConsole=function(){var e=this;this._viewer.scene.renderError.addEventListener(function(){e._videoElement.paused||e._videoElement.pause(),e._viewer.cesiumWidget._showRenderLoopErrors&&e._viewer.cesiumWidget.showErrorPanel("This browser does not support cross-origin WebGL video textures.","","")})},pe.prototype.useCanvas=function(e){this.useCanvasValue=e},pe.prototype.setCanvas=function(e){this.mCanvas=e},pe.prototype.updateCanvas=function(){this.useCanvasValue&&null!=this.mCanvas&&this.mCanvas.drawImage(this.mMediaplayer,0,0)},pe.prototype.openws=function(){if(""!=this.mRtspurl&&-1==this.mRtspurl.indexOf("rtsp"))return this.mMediaplayer.src=this.mRtspurl,void(this.mMediaplayer.type="video/mp4");this.websocket=new WebSocket(this.wsserverurl),this.websocket.onopen=this.onOpen.bind(this),this.websocket.onclose=this.onClose.bind(this),this.websocket.onmessage=this.onMessage.bind(this),this.websocket.onerror=this.onError.bind(this),document.addEventListener("webkitvisibilitychange",function(e){e.target.webkitHidden||this.onCanPlay()}.bind(this),!1),mTraceInterval=window.setInterval(this.updateCanvas.bind(this),10)},pe.prototype.onError=function(e){this.wsConnected=!1,console.log("socket error"),this.stop()},pe.prototype.doSend=function(e){this.wsConnected&&null!=this.websocket?(this.websocket.binaryType="arraybuffer",this.websocket.send(e)):console.log("socket is not  connected!")},pe.prototype.onHistoryTracks=function(e){},pe.prototype.onLastestTracks=function(e){},pe.prototype.onIdentify=function(e){},pe.prototype.onServerMessage=function(e){},pe.prototype.onMessage=function(e){var t,i,n;this.mCurrentTime=e.timeStamp,"string"==typeof e.data?(t=e.data,"AVC_INFO"===(i=JSON.parse(t)).messageType?(this.mimestr=i.data,this.initMediaSource(this.mimestr)):"SERVER_INFO"===i.messageType?"success"===i.data?this.needRecv=!0:this.onServerMessage(i.data):"PTZ"===i.messageType?this.layer&&this.layer.ev_VideoProjectionManager&&this.layer.ev_VideoProjectionManager.updateVideoCamera(this.mMediaplayer.id,i.pan,i.tilt,i.zoom):"HISTORY_TRACKS"===i.messageType?this.onHistoryTracks(i.data):"LASTEST_TRACKS"===i.messageType?this.onLastestTracks(i.data):"INDENTIFY"===i.messageType?this.onIdentify(i.data):i.messageType,t=null):this.needRecv?(n=new Uint8Array(e.data),this.push(n),n=null,this.loadvideo()):console.log("refuse video data"),e=null},pe.prototype.onOpen=function(e){this.wsConnected=!0,this.retry()},pe.prototype.play=function(){var e;this.playMode="PLAY_REAL",""!==this.mRtspurl&&null!==this.mRtspurl?(e='{"messageType": "CONNECT_TYPE","connect_type":"VIDEO"}',this.doSend(e),console.log("try to open url: "+this.mRtspurl),e='{"messageType": "ADDRESS","url": "'+this.mRtspurl+'"}',this.doSend(e),e=null):console.log("mRtspurl: "+this.mRtspurl+"  is illegal!")},pe.prototype.playGlobe=function(){this.playMode="GLOBE_FUSION";var e='{"messageType": "CONNECT_TYPE","connect_type":"GLOBE","client":"WEB"}';this.doSend(e),e=null},pe.prototype.playGB=function(){this.playMode="GB";var e='{"messageType": "CONNECT_TYPE","connect_type":"GB","client":"WEB"}';this.doSend(e),e=null},pe.prototype.getGBDeviceList=function(){var e='{"messageType": "GET_GB_DEVICE_LIST"}';this.doSend(e),e=null},pe.prototype.playGBDevice=function(e){var t='{"messageType": "PLAY_GB_VIDEO","sipID": "'+e+'"}';this.doSend(t),t=null},pe.prototype.stopPlayGBDevice=function(e){sendurl='{"messageType": "STOP_PLAY_GB_VIDEO","sipID": "'+e+'"}',this.doSend(sendurl),sendurl=null},pe.prototype.redirctUrl=function(e){this.mRtspurl=e,this.play()},pe.prototype.onClose=function(e){console.log("DISCONNECTED"),this.stop()},pe.prototype.initMediaSource=function(e){this.mimestr=e,this.supportstr='video/mp4; codecs="'+this.mimestr+'"',MediaSource.isTypeSupported(this.supportstr)?(this.mediaSource=new MediaSource,this.mediaSource.addEventListener("sourceopen",this.onMediaSourceOpen,!1),this.mediaSource.addEventListener("sourceclose",this.onSourceClose,!1),this.mediaSource.addEventListener("sourceended",this.onSourceEnded,!1),this.mMediaplayer.src=URL.createObjectURL(this.mediaSource),this.mMediaplayer.addEventListener("canplay",this.onCanPlay.bind(this)),this.mMediaplayer.addEventListener("pause",this.onPause.bind(this)),this.mMediaplayer.addEventListener("error",this.onPlayError.bind(this))):(this.needRecv=!1,console.log("Unsupported MIME type or codec: ",+this.supportstr))},pe.prototype.onSourceClose=function(e){console.log("onSourceClose"),console.error(e)},pe.prototype.onSourceEnded=function(e){console.log("onSourceEnded")},pe.prototype.onPlayError=function(e){console.error(e),this.retry()},pe.prototype.retry=function(){this.needRecv&&(console.log("retry open the stream"),null!=this.mimestr&&(this.needRecv=!1,this.ByteArray(),this.streamReady=!1,URL.revokeObjectURL(this.mMediaplayer.src),this.initMediaSource(this.mimestr)),"PLAY_REAL"===this.playMode?this.playReal():"START_PLAYBACK"===this.playMode||"START_PLAYBACK_RETRY"===this.playMode?this.startPlayBackRetry():"GLOBE_FUSION"===this.playMode?this.playGlobe():"GB"===this.playMode?(this.playGB(),this.getGBDeviceList()):""===this.playMode?this.play():this.stopPlay())},pe.prototype.onCanPlay=function(){this.elementPaused&&(this.recoverWS(),this.elementPaused=!1)},pe.prototype.onSeeked=function(){console.log("onSeeked")},pe.prototype.onPause=function(){this.elementPaused=!0,this.pauseWS()},pe.prototype.onMediaSourceOpen=function(e){this.mediaSource.removeEventListener("sourceopen",this.onMediaSourceOpen),this.sourceBuffer=this.mediaSource.addSourceBuffer(this.supportstr),this.sourceBuffer.addEventListener("updateend",this.onUpdateEnd,!1),this.sourceBuffer.addEventListener("abort",this.onAbort,!1),this.sourceBuffer.addEventListener("error",this.onError,!1),this.sourceReady=!0,this.streamReady=!1;var t='{"messageType": "SOURCE_READY"}';console.log("source ready order:"+t),this.doSend(t)},pe.prototype.onError=function(e){console.log("onError")},pe.prototype.onAbort=function(e){console.log("onAbort")},pe.prototype.onUpdateEnd=function(e){this.sourceReady=!0,this.loadvideo(),4!==this.mMediaplayer.readyState||this.sourceBuffer.updating||this.streamReady||(console.log("connect newwork resource success"),this.mediaSource.endOfStream(),this.mMediaplayer.play(),this.streamReady=!0,this.dtTime=this.mCurrentTime/1e3-this.mMediaplayer.currentTime+this.faultTime),this.mCurrentTime/1e3-this.mMediaplayer.currentTime>this.dtTime&&this.streamReady&&(this.mMediaplayer.currentTime=this.mMediaplayer.duration-.1)},pe.prototype.stop=function(){console.log("stop"),this.websocket&&(this.stopPlay(),this.websocket.close(),this.websocket=void 0),this.mediaSource&&(this.mediaSource.removeSourceBuffer(this.sourceBuffer),this.mediaSource.endOfStream(),this.mediaSource=void 0),this.sourceBuffer&&(this.sourceBuffer=void 0),this.mMediaplayer&&(this.mMediaplayer.src="",URL.revokeObjectURL(this.mMediaplayer.src),this.mMediaplayer=void 0),this.needRecv=!1,this.ByteArray(),this.streamReady=!1},pe.prototype.loadvideo=function(){if(0===this.length||!this.sourceReady)return!1;if(this.sourceBuffer.updating)return!1;if(this.sourceBuffer.buffered.length&&20<this.sourceBuffer.buffered.end(0)-this.sourceBuffer.buffered.start(0))return this.sourceBuffer.remove(0,this.sourceBuffer.buffered.end(0)-10),!1;var e=new Uint8Array(this.length);return this.readBytes(e),this.sourceBuffer.appendBuffer(e),e=null,this.ByteArray(),!0},pe.prototype.ByteArray=function(){this.list=[],this.length=0},pe.prototype.push=function(e){this.list.push(e),this.length+=e.length},pe.prototype.readBytes=function(e){var t=e.length;if(!(e.length<=0)){for(var i=0;i<t;){if(this.list.length<=0){e=e.subarray(0,i);break}var n=this.list.shift(),r=n.length,o=t-i;if(o<=r){var s,a=n.subarray(0,o);e.set(a,i),i+=a.length,o<r&&(s=n.subarray(o,r),this.list.unshift(s)),n=a=null;break}e.set(n,i),i+=r,n=null}this.length-=e.length}},pe.prototype.startIdentify=function(e){var t='{"messageType": "VIDEO_IDENTIFY","action": "START","indentifyTarget": '+e+"}";this.doSend(t),t=null},pe.prototype.stopIdentify=function(){var e='{"messageType": "VIDEO_IDENTIFY","action": "STOP"}';this.doSend(e),e=null},pe.prototype.showTracks=function(e){var t='{"messageType": "IDENTIFY_TRACKS","value": "'+e+'"}';this.doSend(t),t=null},pe.prototype.globeGoto=function(e,t){var i='{"messageType": "GOTO","longitude": "'+e+'","latitude": "'+t+'"}';this.doSend(i),i=null},pe.prototype.globeGotoCameras=function(e){var t='{"messageType": "GOTO","cameraNames": "'+e+'"}';this.doSend(t),t=null},pe.prototype.playReal=function(){this.playMode="PLAY_REAL";var e='{"messageType": "PLAY_REAL"}';this.doSend(e),e=null},pe.prototype.findfile=function(e,t){this.playMode="FIND_FILE";var i='{"messageType": "FIND_FILE","startTime": "'+e+'","startTime": "'+t+'"}';console.log("find file:"+i),this.doSend(i),i=null},pe.prototype.startPlayBackByTime=function(e,t){this.playMode="START_PLAYBACK";var i='{"messageType": "START_PLAYBACK","startTime": "'+e+'","stopTime": "'+t+'"}';console.log("startPlayByTime:"+i),this.doSend(i),i=null},pe.prototype.startPlayBackRetry=function(){this.playMode="START_PLAYBACK_RETRY";var e='{"messageType": "START_PLAYBACK_RETRY"}';console.log("retry playback:"+e),this.doSend(e),e=null},pe.prototype.playBackFast=function(){var e='{"messageType": "PLAYBACK_FAST"}';console.log("play back fast:"+e),this.doSend(e),e=null},pe.prototype.playBackSlow=function(){var e='{"messageType": "PLAYBACK_SLOW"}';console.log("play back slow:"+e),this.doSend(e),e=null},pe.prototype.playBackNormal=function(){var e='{"messageType": "PLAYBACK_NORMAL"}';console.log("play back NORMAL:"+e),this.doSend(e),e=null},pe.prototype.playBackPause=function(){var e='{"messageType": "PLAYBACK_PAUSE"}';console.log("play back pause:"+e),this.doSend(e),e=null},pe.prototype.playBackReStart=function(){var e='{"messageType": "PLAYBACK_RESTART"}';console.log("play back RESTART:"+e),this.doSend(e),e=null},pe.prototype.pauseWS=function(){var e='{"messageType": "PAUSE_SOCKET"}';this.doSend(e),e=null},pe.prototype.recoverWS=function(){var e='{"messageType": "RECOVER_SOCKET"}';this.doSend(e),e=null},pe.prototype.stopPlay=function(){this.playMode="STOP";var e='{"messageType": "STOP"}';this.doSend(e),e=null,this.needRecv=!1},pe.prototype.controlPTZ=function(e,t,i){var n='{"messageType": "PTZ_CONTROL","command": '+e+',"bStop": '+t+',"speed": '+i+"}";console.log("send controlPTZ message:"+n),this.doSend(n),n=null},pe.prototype.setPTZPosition=function(e,t,i){var n='{"messageType": "SET_PTZ_POSITION","pan": '+e+',"tilt": '+t+',"zoom": '+i+"}";console.log("send set_ptz_position message:"+n),this.doSend(n),n=null},pe.prototype.getGBDeivceList=function(){var e='{"messageType": "","pan": '+pan+',"tilt": '+tilt+',"zoom": '+zoom+"}";console.log("send set_ptz_position message:"+e),this.doSend(e),e=null},pe.prototype.bindMouse=function(e){e?(this.mMediaplayer.onmousemove=this.mouseMove.bind(this),this.mMediaplayer.onmousedown=this.mouseDown.bind(this),this.mMediaplayer.onmouseup=this.mouseUp.bind(this),this.mMediaplayer.onmousewheel=this.mouseWheel.bind(this)):(this.mMediaplayer.onmousemove=null,this.mMediaplayer.onmousedown=null,this.mMediaplayer.onmouseup=null,this.mMediaplayer.onmousewheel=null)},pe.prototype.calculatePosition=function(e){if(null==this.mMediaplayer)return null;var t=this.mMediaplayer.offsetHeight/this.mMediaplayer.videoHeight,i=this.mMediaplayer.offsetWidth/this.mMediaplayer.videoWidth,n=t<i?t:i,r=this.mMediaplayer.offsetWidth/2-this.mMediaplayer.videoWidth*n/2,o=this.mMediaplayer.offsetWidth/2+this.mMediaplayer.videoWidth*n/2,s=this.mMediaplayer.offsetHeight/2-this.mMediaplayer.videoHeight*n/2,a=this.mMediaplayer.offsetHeight/2+this.mMediaplayer.videoHeight*n/2,u=this.mMediaplayer.getBoundingClientRect(),l=e.clientX-u.left,d=e.clientY-u.top;if(l<r||o<l||d<s||a<d)return null;var h=new Array;h[0]=(l-r)*this.mMediaplayer.videoWidth/(o-r),h[1]=(d-s)*this.mMediaplayer.videoHeight/(a-s);var c=e.button;return 0==c?c=1:1==c&&(c=4),h[2]=c,h},pe.prototype.mouseMove=function(e){var t=this.calculatePosition(e);if(null==t)return!1;var i='{"messageType": "MOUSE_EVENT","mouseAction": "MOUSE_MOVE","mouseX":'+t[0]+',"mouseY": '+t[1]+"}";this.doSend(i),i=null},pe.prototype.mouseDown=function(e){var t=this.calculatePosition(e);if(null==t)return!1;var i='{"messageType": "MOUSE_EVENT","mouseAction": "MOUSE_PRESS","mouseButton":'+t[2]+',"mouseX":'+t[0]+',"mouseY":'+t[1]+"}";return this.doSend(i),i=null,!1},pe.prototype.mouseUp=function(e){var t=this.calculatePosition(e);if(null==t)return!1;var i='{"messageType": "MOUSE_EVENT","mouseAction": "MOUSE_RELEASE","mouseButton":'+t[2]+',"mouseX":'+t[0]+',"mouseY":'+t[1]+"}";return this.doSend(i),!1},pe.prototype.mouseWheel=function(e){if(null==this.calculatePosition(e))return!1;var t='{"messageType": "MOUSE_EVENT","mouseAction": "MOUSE_WHEEL","orientation":2,"delta":'+e.wheelDelta+"}";return this.doSend(t),!1};function fe(e){this._leftClip=Cesium.defaultValue(0,0),this._rightClip=Cesium.defaultValue(1,1),this._topClipLine1=new Cesium.Cartesian4(0,1,1,1),this._topClipLine2=new Cesium.Cartesian4(0,1,1,1),this._topClipLine3=new Cesium.Cartesian4(0,1,1,1),this._topClipLine4=new Cesium.Cartesian4(0,1,1,1),this._bottomClipLine1=new Cesium.Cartesian4(0,0,1,0),this._bottomClipLine2=new Cesium.Cartesian4(0,0,1,0),this._bottomClipLine3=new Cesium.Cartesian4(0,0,1,0),this._bottomClipLine4=new Cesium.Cartesian4(0,0,1,0),this._pointsList=[],this._initialPointsList=[],this._indicesList=[],this._centerPostion=new Cesium.Cartesian3;for(var t=0;t<e.length;t++)try{var i=e[t];if(t==e.length-1)for(var n=0;n<i.length;n++)this._indicesList.push(i[n]);else if(this._centerPostion.x=this._centerPostion.x+i[0],this._centerPostion.y=this._centerPostion.y+i[1],this._centerPostion.z=this._centerPostion.z+i[2],this._pointsList.push(new Cesium.Cartesian3(i[0],i[1],i[2])),0<=i[3])for(var r=this._initialPointsList.length,o=0;o<e.length-1;o++)if(e[o][3]===r){this._initialPointsList.push(new Cesium.Cartesian3(e[o][0],e[o][1],e[o][2]));break}}catch(e){console.error(e.message)}this._centerPostion.x=this._centerPostion.x/(e.length-1),this._centerPostion.y=this._centerPostion.y/(e.length-1),this._centerPostion.z=this._centerPostion.z/(e.length-1)}function Ce(e){if(!Cesium.defined(e))throw new Cesium.DeveloperError("参数options不能为空。");if(!Cesium.defined(e.viewer))throw new Cesium.DeveloperError("Viewer对象options.viewer不能为空。");if(!Cesium.defined(e.framebuffer))throw new Cesium.DeveloperError("Viewer对象options.framebuffer不能为空。");if(!Cesium.defined(e.coordinates))throw new Cesium.DeveloperError("Viewer对象options.projection不能为空。");this.ev_CommonProjectionPlane=new fe(e.coordinates),this._show=Cesium.defaultValue(e.show,!0),this._planeColor=Cesium.defaultValue(e.planeColor,new Cesium.Color),this._viewer=e.viewer,this.framebuffer=e.framebuffer;this._vsSource=new Cesium.ShaderSource({sources:["attribute vec3 position;\nvoid main()\n{\n    gl_Position = czm_modelViewProjection * vec4(position, 1.0);\n}\n"]}),this._fsSource=new Cesium.ShaderSource({sources:["uniform vec4 u_color;\nvoid main()\n{\n    gl_FragColor = u_color;\n}\n"]});var t=Cesium.RenderState.fromCache({blending:Cesium.BlendingState.ALPHA_BLEND,cull:{enabled:!0,face:Cesium.CullFace.BACK},depthTest:{enabled:!1}}),i=this;i._drawCommand=new Cesium.DrawCommand({owner:i,pass:Cesium.Pass.OPAQUE,renderState:t,framebuffer:e.framebuffer,uniformMap:{u_color:function(){return i._planeColor}}}),this._viewer.scene.primitives.add(this)}function ve(e){if(!Cesium.defined(e))throw new Cesium.DeveloperError("参数options不能为空。");if(!Cesium.defined(e.viewer))throw new Cesium.DeveloperError("Viewer对象options.viewer不能为空。");if(!Cesium.defined(e.videoElementID))throw new Cesium.DeveloperError("前端video容器的ID不能为空。");if(!Cesium.defined(e.originLon))throw new Cesium.DeveloperError("观察点经度不能为空。");if(!Cesium.defined(e.originLat))throw new Cesium.DeveloperError("观察点纬度不能为空。");if(!Cesium.defined(e.originHeight))throw new Cesium.DeveloperError("观察点高度不能为空。");if(!Cesium.defined(e.clipPlaneFramebuffer))throw new Cesium.DeveloperError("裁剪面帧缓存不能为空。");if(!Cesium.defined(e.width)||!Cesium.defined(e.height))throw new Cesium.DeveloperError("视频宽度或高度没有定义。");if(this._videoElement=document.getElementById(e.videoElementID),!this._videoElement||!(this._videoElement instanceof HTMLVideoElement||this._videoElement instanceof HTMLCanvasElement||this._videoElement instanceof HTMLImageElement))throw new Cesium.DeveloperError("ID为"+e.videoElementID+"元素并不是视频容器。");this._projectMode=Cesium.defaultValue(e.projectMode,1),this._depthType=Cesium.defaultValue(e.depthType,0),this._show=Cesium.defaultValue(e.show,!0),this._name=Cesium.defaultValue(e.name,Cesium.createGuid()),this._wsplayer=e.wsplayer,this._ptzReverse=Cesium.defaultValue(e.ptzReverse,new Cesium.Cartesian2(0,0)),this._ptzDelay=Cesium.defaultValue(e.ptzDelay,300),this._follow=!1,this._pureColor=Cesium.defaultValue(e.pureColor,new Cesium.Color(1,1,1,1)),this._viewer=e.viewer,this._scene=this._viewer.scene,this._mainCamera=this._scene.camera,this._delayTimerArray=[],this._wsClosed=!1,this._readyState=0,this._projectionMode=1,this._videoElement instanceof HTMLVideoElement&&(this.incompatibleConsole(),this._synchronizer=new ce({clock:this._viewer.clock,element:this._videoElement}));var t=this._viewer.canvas,i=this._scene._frameState.context;if(!Cesium.defined(i))throw new Cesium.DeveloperError("_scene._frameState.context不能为空。");if(this.clipPlaneColor=Cesium.defaultValue(e.clipPlaneColor,new Cesium.Color(1,0,0,1)),this.clipPlaneFramebuffer=e.clipPlaneFramebuffer,this.clipPlaneTexture=e.clipPlaneTexture,this.projectionPlanes=[],Cesium.defined(e.projection))for(var n=0;n<e.projection.length;n++)this.projectionPlanes.push(new Ce({viewer:this._viewer,framebuffer:this.clipPlaneFramebuffer,coordinates:e.projection[n],planeColor:this.clipPlaneColor,canvas:t}));else this.projectionPlanes.push(i.defaultTexture);this._filterPrimitives=Cesium.defaultValue(e.filterPrimitives,void 0),this._cachedFilterFeatures=Cesium.defaultValue(e.cachedFilterFeatures,void 0),this._width=e.width,this._height=e.height,this._originLon=e.originLon,this._originLat=e.originLat,this._originHeight=e.originHeight,this._pitch=Cesium.defaultValue(e.pitch,0),this._heading=Cesium.defaultValue(e.heading,0),this._roll=Cesium.defaultValue(e.roll,0),this._fov=Cesium.defaultValue(e.fov,60),this.videoAlpha=Cesium.defaultValue(e.videoAlpha,1),this.videoHsv=Cesium.defaultValue(e.hsvParam,new Cesium.Cartesian3(0,0,0)),this.videoCamera=void 0,this.videoViewport=new Cesium.BoundingRectangle(0,0,t.width,t.height),this.videoView=void 0,this.videoUniform={videoInverseViewRelative:new Cesium.Matrix4,log2FarDepthFromNearPlusOneInVideo:0,videoFrustum:new Cesium.Cartesian2,videoViewport:new Cesium.Cartesian4,videoViewportTransformation:new Cesium.Matrix4,videoInverseProjection:new Cesium.Matrix4,videoFrustumPlanes:new Cesium.Cartesian4},this._videoTexture=void 0,this._videoStage=void 0,this._panPos=Cesium.defaultValue(e.pan,0),this._tiltPos=Cesium.defaultValue(e.tilt,0),this._zoomPos=Cesium.defaultValue(e.zoom,0),this._panCurrent=0,this._tiltCurrent=0,this._zoomCurrent=0,this._nearClip=Cesium.defaultValue(e.nearClip,.01),this._farClip=Cesium.defaultValue(e.farClip,100),this._k1=Cesium.defaultValue(e.distortion.x,0),this._k2=Cesium.defaultValue(e.distortion.y,0),this._layer=e.layer,this.delayPan="",this.delayTilt="",this.delayZoom="",this.targetPosition=new Cesium.Cartesian3,this.targetOrientation=new Cesium.Cartesian3,this.targetZoom=1}function ge(e){var t=e._scene._frameState;if(Cesium.defined(t)&&(!(e._videoElement instanceof HTMLVideoElement)||2<=e._videoElement.readyState))return new Cesium.Texture({context:t.context,source:e._videoElement,sampler:new Cesium.Sampler({wrapS:Cesium.TextureWrap.CLAMP_TO_EDGE,wrapT:Cesium.TextureWrap.CLAMP_TO_EDGE,minificationFilter:Cesium.TextureMinificationFilter.LINEAR,magnificationFilter:Cesium.TextureMagnificationFilter.LINEAR})})}function ye(e,t,i){var n=i.viewport,r=n.width,o=n.height;e.videoView=Cesium.defined(e.videoView)&&e.videoView.destroy(),e.videoViewport=new Cesium.BoundingRectangle(0,0,r,o),e.videoView=new Cesium.View(t,e.videoCamera,e.videoViewport),e.videoView._name="videoview",e._width=r,e._height=o,t.view=e.videoView,(l=e.videoView.passState).viewport=Cesium.BoundingRectangle.clone(e.videoViewport,l.viewport);var s,a,u,l=t.view.passState;t.jobScheduler.disableThisFrame(),a=(s=t).frameState,u=s.camera,a.camera=u,a.cullingVolume=u.frustum.computeCullingVolume(u.positionWC,u.directionWC,u.upWC),a.useLogDepth=s._logDepthBuffer&&!(u.frustum instanceof Cesium.OrthographicFrustum||u.frustum instanceof Cesium.OrthographicOffCenterFrustum);var d=t.frameState,h=d.context.uniformState;d.invertClassification=!1,d.passes.pick=!1,h.update(d),t.updateAndExecuteRttCommands(l,new Cesium.Color(0,0,0,1))}function _e(e,t){var i,n,r,o,s;!function(e,t){if(e._videoStage.selected=[],0===e._filterPrimitives.cesium3DTileNames.length&&0===e._filterPrimitives.cesium3DTileIds.length&&0===e._filterPrimitives.entityIds.length)return e._cachedFilterFeatures._features=[];{if(Cesium.defined(e._cachedFilterFeatures)&&e._cachedFilterFeatures._frameNumber===t.frameNumber)return e._videoStage.selected=e._cachedFilterFeatures._features;Cesium.defined(e._cachedFilterFeatures)&&(e._cachedFilterFeatures._frameNumber=t.frameNumber,e._cachedFilterFeatures._features=[])}for(var i=e._scene._primitives,n=0;n<i.length;n++){var r=i.get(n);if(r instanceof Cesium.Cesium3DTileset){if(!r.ready)continue;if(-1<r.asset.tilesetVersion.indexOf("lodmodel"))for(var o=r._selectedTiles,s=0;s<o.length;s++){var a=o[s].content;if(a instanceof Cesium.Batched3DModel3DTileContent||a instanceof Cesium.Instanced3DModel3DTileContent){0<a.featuresLength&&a.getFeature(0);for(var u=a.batchTable,l=a._features,d=0;d<a.featuresLength;d++)(-1<e._filterPrimitives.cesium3DTileIds.indexOf(u._properties.id[d])||-1<e._filterPrimitives.cesium3DTileNames.indexOf(u._properties.name[d]))&&(e._videoStage.selected.push(l[d]),Cesium.defined(e._cachedFilterFeatures)&&e._cachedFilterFeatures._features.push(l[d]));for(var h=a._model.ev_E3MInternalInstance.modelInstanceCollections,c=0;c<h.length;c++){a._model.ev_E3MInternalInstance.getFeature(h[c],0);for(var m=h[c].batchTable,p=h[c]._features,d=0;d<h[c].featuresLength;d++)(-1<e._filterPrimitives.cesium3DTileIds.indexOf(m._properties.id[d])||-1<e._filterPrimitives.cesium3DTileNames.indexOf(m._properties.name[d]))&&(e._videoStage.selected.push(p[d]),Cesium.defined(e._cachedFilterFeatures)&&e._cachedFilterFeatures._features.push(p[d]))}}else if(a instanceof Cesium.Composite3DTileContent)for(var f=a.innerContents,c=0;c<f.length;c++)if(f[c]instanceof Cesium.Batched3DModel3DTileContent||f[c]instanceof Cesium.Instanced3DModel3DTileContent){0<f[c].featuresLength&&f[c].getFeature(0);for(u=f[c].batchTable,l=f[c]._features,d=0;d<f[c].featuresLength;d++)(-1<e._filterPrimitives.cesium3DTileIds.indexOf(u._properties.id[d])||-1<e._filterPrimitives.cesium3DTileNames.indexOf(u._properties.name[d]))&&(e._videoStage.selected.push(l[d]),Cesium.defined(e._cachedFilterFeatures)&&e._cachedFilterFeatures._features.push(l[d]));for(var h=f[c]._model.ev_E3MInternalInstance.modelInstanceCollections,C=0;C<h.length;C++){f[c]._model.ev_E3MInternalInstance.getFeature(h[C],0);for(m=h[C].batchTable,p=h[C]._features,d=0;d<h[C].featuresLength;d++)(-1<e._filterPrimitives.cesium3DTileIds.indexOf(m._properties.id[d])||-1<e._filterPrimitives.cesium3DTileNames.indexOf(m._properties.name[d]))&&(e._videoStage.selected.push(p[d]),Cesium.defined(e._cachedFilterFeatures)&&e._cachedFilterFeatures._features.push(p[d]))}}}}else if(r instanceof Cesium.Model)Cesium.defined(r.id)&&r.id instanceof Cesium.Entity&&-1<e._filterPrimitives.entityIds.indexOf(r.id.id)&&(e._videoStage.selected.push(r),Cesium.defined(e._cachedFilterFeatures)&&e._cachedFilterFeatures._features.push(r));else if(r instanceof Cesium.PrimitiveCollection)for(C=0;C<r.length;C++){var v=r.get(C);if(v instanceof Cesium.PrimitiveCollection)for(d=0;d<v.length;d++){var g=v.get(d);if(Cesium.defined(g._instanceIds))for(var y=0;y<g._instanceIds.length;y++){var _=g._instanceIds[y];-1<e._filterPrimitives.entityIds.indexOf(_.id)&&(e._videoStage.selected.push(g),Cesium.defined(e._cachedFilterFeatures)&&e._cachedFilterFeatures._features.push(g))}}}}}(e,t),2.5<e._depthType&&e._depthType<3.5&&((i=new Cesium.PostProcessStageCollection).fxaa.enabled=!1,r=(n=e._scene).postProcessStages,o=n.view,n.postProcessStages=i,ye(e,n,o),Cesium.defined(e.videoView)&&Cesium.defined(e.videoView.passState.context.uniformState)&&(s=e.videoView.passState.context.uniformState,e.videoUniform.videoInverseViewRelative=Cesium.Matrix4.setTranslation(s.inverseView,new Cesium.Cartesian3,new Cesium.Matrix4),e.videoUniform.log2FarDepthFromNearPlusOneInVideo=s.log2FarDepthFromNearPlusOne,e.videoUniform.videoFrustum=Cesium.Cartesian2.clone(s.currentFrustum),e.videoUniform.videoViewport=new Cesium.Cartesian4(s.viewport.x,s.viewport.y,s.viewport.width,s.viewport.height),e.videoUniform.videoViewportTransformation=Cesium.Matrix4.clone(s.viewportTransformation),e.videoUniform.videoInverseProjection=Cesium.Matrix4.clone(s.inverseProjection),e.videoUniform.videoFrustumPlanes=Cesium.Cartesian4.clone(s.frustumPlanes)),e._scene.view=o,e._scene.postProcessStages=r,i=void 0)}function we(){this._frameNumber=-1,this._features=[]}function be(e){if(!Cesium.defined(e))throw new Cesium.DeveloperError("参数options不能为空。");if(!Cesium.defined(e.viewer))throw new Cesium.DeveloperError("Viewer对象options.viewer不能为空。");this._viewer=e.viewer,this._scene=this._viewer.scene,this._sceneCamera=this._scene.camera;var t=this._viewer.canvas,i=this._scene._frameState.context;if(this._width=t.width,this._height=t.height,!Cesium.defined(i))throw new Cesium.DeveloperError("_scene._frameState.context不能为空。");this._videoProjections=[],this.clipPlaneTexture=new Cesium.Texture({context:i,width:this._width,height:this._height,pixelFormat:Cesium.PixelFormat.RGBA,sampler:Cesium.Sampler.NEAREST}),this.framebuffer=new Cesium.Framebuffer({context:i,colorTextures:[this.clipPlaneTexture],destroyAttachments:!1}),this._clearCommand=new Cesium.ClearCommand({color:new Cesium.Color(0,0,0,0),framebuffer:this.framebuffer,depth:1,owner:this}),this._viewer.scene.preRender.addEventListener(this.preRender,this),this._cachedFilterFeatures=new we,this._filterPrimitives={cesium3DTileIds:[],cesium3DTileNames:[],entityIds:[]}}function Ie(m){if(this._readyPromise=F.defer(),this._videoModelArray=[],this._videoPlaneArray=[],this._jsmpegPlayerArray=[],this._visibleDistance=-1,this._show=!0,this._name=m.name,this._boundingSphere=void 0,this._videoProjectionArray=[],m){if(this._name=m.name,m.visibleDistance&&(this._visibleDistance=m.visibleDistance),this.ev_VideoProjectionManager=new be({viewer:m.viewer}),!Cesium.defined(m.videoJsonFile))throw new Cesium.DeveloperError("视频json文件不能为空。");var p=this;Cesium.Resource.createIfNeeded(m.videoJsonFile).fetchJson().then(function(e){var t,i;Cesium.defined(e.layerName)&&(p._name=e.layerName),Cesium.defined(e.boundingSphere)&&(t=e.boundingSphere,i=new Cesium.Cartesian3(t[0],t[1],t[2]),p._boundingSphere=new Cesium.BoundingSphere(i,t[3]));for(var n=e.data,r=0;r<n.length;r++){var o=n[r],s={};s.viewer=m.viewer,s.originLon=o.camera.position[0],s.originLat=o.camera.position[1],s.originHeight=o.camera.position[2],s.heading=o.camera.orientation[0],s.pitch=o.camera.orientation[1],s.roll=o.camera.orientation[2],s.fov=o.camera.fov,s.textureSize=new Cesium.Cartesian3(0,0,0),o.video.hsv&&(s.hsvParam=new Cesium.Cartesian3(o.video.hsv[0],o.video.hsv[1],o.video.hsv[2])),o.video.distortion&&(s.distortion=new Cesium.Cartesian2(o.video.distortion[0],o.video.distortion[1])),o.video.alpha&&(s.videoAlpha=o.video.alpha),o.camera.ptz&&(s.pan=o.camera.ptz[0],s.tilt=o.camera.ptz[1],s.zoom=o.camera.ptz[2]),s.ptzReverse=new Cesium.Cartesian2(0,0),o.camera.ptzReverse&&(s.ptzReverse.x=o.camera.ptzReverse[0],s.ptzReverse.y=o.camera.ptzReverse[1]),s.ptzDelay=300,o.camera.ptzReverse&&(s.ptzDelay=o.camera.ptzDelay),s.wsplayer=void 0;var a,u,l,d,h="";Cesium.defined(o.video.file)?(o.video.file.indexOf("rtsp"),h=o.video.file):Cesium.defined(o.video.url)&&(o.video.url.indexOf("rtsp"),h=o.video.url),o.video.file?((a=document.createElement("video")).id="v"+((new Date).getTime()+Math.floor(1e3*Math.random())),s.videoElementID=a.id,u="",-1!=m.videoJsonFile.lastIndexOf("/")&&(u=m.videoJsonFile.substring(0,m.videoJsonFile.lastIndexOf("/")+1)),u+=h,a.muted="true",a.loop="true",a.crossorigin="true",a.autoplay="true",a.style.display="none",o.video.codecsStr?new EV_LocalVideoPlayer(a,u,o.video.codecsStr):a.src=u,document.body.appendChild(a)):((l=document.createElement("video")).id="v"+((new Date).getTime()+Math.floor(1e3*Math.random())),s.videoElementID=l.id,l.muted="true",l.autoplay="true",l.style.display="none",document.body.appendChild(l),(d=new pe({wsserver:e.wsserver,rtspurl:h,mediaplayer:l,layer:p})).openws(),s.wsplayer=d),o.projection&&(s.projection=o.projection),o.name&&(s.name=o.name),o.video.nearClip&&(s.nearClip=o.video.nearClip),o.video.farClip&&(s.farClip=o.video.farClip),s.layer=p,s.depthType=0,Cesium.defined(o.video)&&Cesium.defined(o.video.depthType)&&(s.depthType=o.video.depthType);var c=0;o.type&&0<o.type?(s.projectMode=o.type,c=p.ev_VideoProjectionManager.createVideoProjection(s),p._videoPlaneArray.push(c)):(c=new me(s),p._videoModelArray.push(c)),p._videoProjectionArray.push(c)}p._readyPromise.resolve(!0)}).otherwise(function(e){console.warn("获取视频json文件失败："+e.message)})}}Ce.prototype.update=function(e){var t,i,n,r=e.context,o=e.commandList;Cesium.defined(this._drawCommand.vertexArray)||(t=function(e,t,i){if(0==e.length||0==i.length)return;t=Cesium.Cartesian3.fromDegrees(t.x,t.y,t.z);for(var n=3*e.length,r=new Float64Array(n),o=i.length,s=Cesium.IndexDatatype.createTypedArray(n,o),a=0,u=0;u<e.length;u++){var l=new Cesium.Cartesian3,d=Cesium.Cartesian3.fromDegrees(e[u].x,e[u].y,e[u].z);Cesium.Cartesian3.subtract(d,t,l),r[a++]=l.x,r[a++]=l.y,r[a++]=l.z}for(var h=0,u=0;u<i.length;u++)s[h++]=i[u];var c=new Cesium.GeometryAttributes;c.position=new Cesium.GeometryAttribute({componentDatatype:Cesium.ComponentDatatype.DOUBLE,componentsPerAttribute:3,values:r});var m=Cesium.BoundingSphere.fromVertices(r);return new Cesium.Geometry({attributes:c,indices:s,primitiveType:Cesium.PrimitiveType.TRIANGLES,boundingSphere:m})}(this.ev_CommonProjectionPlane._pointsList,this.ev_CommonProjectionPlane._centerPostion,this.ev_CommonProjectionPlane._indicesList))&&(i=Cesium.GeometryPipeline.createAttributeLocations(t),this._drawCommand.vertexArray=Cesium.VertexArray.fromGeometry({context:r,geometry:t,attributeLocations:i,bufferUsage:Cesium.BufferUsage.STATIC_DRAW}),n=Cesium.Cartesian3.fromDegrees(this.ev_CommonProjectionPlane._centerPostion.x,this.ev_CommonProjectionPlane._centerPostion.y,this.ev_CommonProjectionPlane._centerPostion.z),this._drawCommand.modelMatrix=Cesium.Matrix4.fromTranslation(n),this._drawCommand.boundingVolume=Cesium.BoundingSphere.transform(t.boundingSphere,this._drawCommand.modelMatrix,this._drawCommand.boundingVolume),Cesium.defined(this._drawCommand.shaderProgram)||(this._drawCommand.shaderProgram=Cesium.ShaderProgram.fromCache({context:r,vertexShaderSource:this._vsSource,fragmentShaderSource:this._fsSource,attributeLocations:i}))),Cesium.defined(this._drawCommand)&&(this._drawCommand.framebuffer=this.framebuffer,o.push(this._drawCommand))},Ce.prototype.destroy=function(){return Cesium.destroyObject(this)},Object.defineProperties(ve.prototype,{videoStage:{get:function(){return this._videoStage}},name:{get:function(){return this._name}},show:{get:function(){return this._show},set:function(e){e?(this._videoStage.enabled=!0,this._wsplayer.needRecv=!0):(this._videoStage.enabled=!1,this._wsplayer.needRecv=!1),this._show=e}}}),ve.prototype.preRender=function(){var e,t=this;if(Cesium.defined(t._videoStage)){if(!t._show)return void(t._videoStage.enabled=!1);t._videoStage.enabled=!0;var i=-1;if(t._layer&&0<t._layer.visibleDistance&&(i=t._layer.visibleDistance),Cesium.defined(t.videoCamera)&&(t.videoCamera.frustum.computeCullingVolume(t.videoCamera.positionWC,t.videoCamera.directionWC,t.videoCamera.upWC),t._mainCamera.frustum.computeCullingVolume(t._mainCamera.positionWC,t._mainCamera.directionWC,t._mainCamera.upWC)),0<i&&t._wsplayer){var n=t._mainCamera.positionWC,r=t.videoCamera.positionWC;if(i<Cesium.Cartesian3.distance(n,r))return t._wsClosed||(t._wsClosed=!0,t._wsplayer.stopPlay()),void(t._videoStage.enabled=!1);t._videoStage.enabled=!0}t._wsClosed&&(t._wsClosed=!1,t._wsplayer.playReal())}2<=t._videoElement.readyState&&Cesium.defined(t._videoTexture)&&(t._videoElement instanceof HTMLVideoElement||t._videoTexture._height==t._videoElement.videoHeight&&t._videoTexture._width==t._videoElement.videoWidth?t._videoTexture.copyFrom(t._videoElement):(t._videoTexture.destroy(),ge(t))),2<=t._videoElement.readyState&&t._readyState<2&&(t._readyState=t._videoElement.readyState,t._videoTexture=ge(t),t.videoCamera=function(e){var t=Cesium.Cartesian3.fromDegrees(e._originLon,e._originLat,e._originHeight),i=new Cesium.Camera(e._viewer.scene);i._name="videocamera",e.videoView=new Cesium.View(e._viewer.scene,i,e.videoViewport),e.videoView._name="videoview",i.setView({destination:t,orientation:{heading:Cesium.Math.toRadians(e._heading),pitch:Cesium.Math.toRadians(e._pitch),roll:Cesium.Math.toRadians(e._roll)}});var n=i.frustum;return n.fov=Cesium.Math.toRadians(e._fov),n.aspectRatio=e._videoTexture._width/e._videoTexture._height,n.near=e._nearClip,n.far=e._farClip,n._fovy=n.aspectRatio<=1?n.fov:2*Math.atan(Math.tan(.5*n.fov)/n.aspectRatio),n.top=n.near*Math.tan(.5*n._fovy),n.bottom=-n.top,n.right=n.aspectRatio*n.top,n.left=-n.right,i}(t),e=Cesium.Matrix4.setTranslation(t.videoCamera.viewMatrix,new Cesium.Cartesian3,new Cesium.Matrix4),t.videoViewProjectionMat4=Cesium.Matrix4.multiply(t.videoCamera.frustum.projectionMatrix,e,new Cesium.Matrix4),t._videoStage=new Cesium.PostProcessStage({name:"VideoP_"+t._name,fragmentShader:atob("dmFyeWluZyB2ZWMyIHZfdGV4dHVyZUNvb3JkaW5hdGVzOwp1bmlmb3JtIHNhbXBsZXIyRCBjb2xvclRleHR1cmU7CnVuaWZvcm0gc2FtcGxlcjJEIGRlcHRoVGV4dHVyZTsKdW5pZm9ybSB2ZWMzIHVfcmVsYXRpdmVQb3M7CnVuaWZvcm0gbWF0NCB1X3NjZW5lSW52ZXJzZVZpZXdSZWxhdGl2ZTsKdW5pZm9ybSBzYW1wbGVyMkQgdV92aWRlb0NvbG9yVGV4dHVyZTsKdW5pZm9ybSBzYW1wbGVyMkQgdV92aWRlb0NhbWVyYURlcHRoVGV4dHVyZTsKdW5pZm9ybSBtYXQ0IHVfdmlkZW9WaWV3UHJvamVjdGlvblJlbGF0aXZlOwp1bmlmb3JtIG1hdDQgdV92aWRlb0ludmVyc2VWaWV3UmVsYXRpdmU7CnVuaWZvcm0gZmxvYXQgdV9sb2cyRmFyRGVwdGhGcm9tTmVhclBsdXNPbmVJblZpZGVvOwp1bmlmb3JtIHZlYzIgdV92aWRlb0ZydXN0dW07CnVuaWZvcm0gdmVjNCB1X3ZpZGVvVmlld3BvcnQ7CnVuaWZvcm0gbWF0NCB1X3ZpZGVvVmlld3BvcnRUcmFuc2Zvcm1hdGlvbjsgCnVuaWZvcm0gbWF0NCB1X3ZpZGVvSW52ZXJzZVByb2plY3Rpb247IAp1bmlmb3JtIHZlYzQgdV92aWRlb0ZydXN0dW1QbGFuZXM7CnVuaWZvcm0gZmxvYXQgdV9kZXB0aFR5cGU7CnVuaWZvcm0gZmxvYXQgdV9hbHBoYTsKdW5pZm9ybSB2ZWMzIHVfaHN2Owp1bmlmb3JtIHNhbXBsZXIyRCB1X2NsaXBQbGFuZUNvbG9yVGV4dHVyZTsKdW5pZm9ybSB2ZWM0IHVfY2xpcFBsYW5lQ29sb3I7CnVuaWZvcm0gZmxvYXQgdV9wcm9qZWN0TW9kZTsKdW5pZm9ybSB2ZWM0IHVfcHVyZUNvbG9yOwp1bmlmb3JtIGZsb2F0IGsxOwp1bmlmb3JtIGZsb2F0IGsyOwp1bmlmb3JtIGZsb2F0IHRleHR1cmVXaWR0aDsKdW5pZm9ybSBmbG9hdCB0ZXh0dXJlSGVpZ2h0Owp2ZWMzIGNsaXBUb1JlbGF0aXZlV29ybGQoZmxvYXQgdSxmbG9hdCB2KQp7CnZlYzIgdXYgPSB2ZWMyKHUsdik7CmZsb2F0IGRlcHRoID0gY3ptX3VucGFja0RlcHRoKHRleHR1cmUyRChkZXB0aFRleHR1cmUsIHV2KSk7CnZlYzQgZXllQ29vcmRpbmF0ZSA9IGN6bV93aW5kb3dUb0V5ZUNvb3JkaW5hdGVzKHV2KmN6bV92aWV3cG9ydC56dywgZGVwdGgpOwp2ZWM0IHdvcmxkQ29vcmRpbmF0ZTQgPSB1X3NjZW5lSW52ZXJzZVZpZXdSZWxhdGl2ZSAqIGV5ZUNvb3JkaW5hdGU7CnZlYzMgd29ybGRQb3NpdGlvbiA9IHdvcmxkQ29vcmRpbmF0ZTQueHl6IC8gd29ybGRDb29yZGluYXRlNC53OwpyZXR1cm4gd29ybGRQb3NpdGlvbjsKfQp2ZWM0IHdpbmRvd1RvRXllQ29vcmRpbmF0ZXNJblZpZGVvMih2ZWM0IGZyYWdtZW50Q29vcmRpbmF0ZSkKewogICAgZmxvYXQgeCA9IDIuMCAqIChmcmFnbWVudENvb3JkaW5hdGUueCAtIHVfdmlkZW9WaWV3cG9ydC54KSAvIHVfdmlkZW9WaWV3cG9ydC56IC0gMS4wOwogICAgZmxvYXQgeSA9IDIuMCAqIChmcmFnbWVudENvb3JkaW5hdGUueSAtIHVfdmlkZW9WaWV3cG9ydC55KSAvIHVfdmlkZW9WaWV3cG9ydC53IC0gMS4wOwogICAgZmxvYXQgeiA9IChmcmFnbWVudENvb3JkaW5hdGUueiAtIHVfdmlkZW9WaWV3cG9ydFRyYW5zZm9ybWF0aW9uWzNdWzJdKSAvIHVfdmlkZW9WaWV3cG9ydFRyYW5zZm9ybWF0aW9uWzJdWzJdOwogICAgdmVjNCBxID0gdmVjNCh4LCB5LCB6LCAxLjApOwogICAgcSA9IHEvZnJhZ21lbnRDb29yZGluYXRlLnc7CiAgICBpZiAoISh1X3ZpZGVvSW52ZXJzZVByb2plY3Rpb24gPT0gbWF0NCgwLjApKSkgCiAgICB7CiAgICAgICAgcSA9IHVfdmlkZW9JbnZlcnNlUHJvamVjdGlvbiAqIHE7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgZmxvYXQgdG9wID0gdV92aWRlb0ZydXN0dW1QbGFuZXMueDsKICAgICAgICBmbG9hdCBib3R0b20gPSB1X3ZpZGVvRnJ1c3R1bVBsYW5lcy55OwogICAgICAgIGZsb2F0IGxlZnQgPSB1X3ZpZGVvRnJ1c3R1bVBsYW5lcy56OwogICAgICAgIGZsb2F0IHJpZ2h0ID0gdV92aWRlb0ZydXN0dW1QbGFuZXMudzsKICAgICAgICBmbG9hdCBuZWFyID0gdV92aWRlb0ZydXN0dW0ueDsKICAgICAgICBmbG9hdCBmYXIgPSB1X3ZpZGVvRnJ1c3R1bS55OwogICAgICAgIHEueCA9IChxLnggKiAocmlnaHQgLSBsZWZ0KSArIGxlZnQgKyByaWdodCkgKiAwLjU7CiAgICAgICAgcS55ID0gKHEueSAqICh0b3AgLSBib3R0b20pICsgYm90dG9tICsgdG9wKSAqIDAuNTsKICAgICAgICBxLnogPSAocS56ICogKG5lYXIgLSBmYXIpIC0gbmVhciAtIGZhcikgKiAwLjU7CiAgICAgICAgcS53ID0gMS4wOwogICAgfQogICAgcmV0dXJuIHE7Cn0KdmVjNCB3aW5kb3dUb0V5ZUNvb3JkaW5hdGVzSW5WaWRlbyh2ZWMyIGZyYWdtZW50Q29vcmRpbmF0ZVhZLCBmbG9hdCBkZXB0aE9yTG9nRGVwdGgpIAp7CiAgI2lmZGVmIExPR19ERVBUSAogIGZsb2F0IG5lYXIgPSB1X3ZpZGVvRnJ1c3R1bS54OwogIGZsb2F0IGZhciA9IHVfdmlkZW9GcnVzdHVtLnk7CiAgZmxvYXQgbG9nMkRlcHRoID0gZGVwdGhPckxvZ0RlcHRoICogdV9sb2cyRmFyRGVwdGhGcm9tTmVhclBsdXNPbmVJblZpZGVvOwogIGZsb2F0IGRlcHRoRnJvbU5lYXIgPSBwb3coMi4wLCBsb2cyRGVwdGgpIC0gMS4wOwogIGZsb2F0IGRlcHRoRnJvbUNhbWVyYSA9IGRlcHRoRnJvbU5lYXIgKyBuZWFyOwogIHZlYzQgd2luZG93Q29vcmQgPSB2ZWM0KGZyYWdtZW50Q29vcmRpbmF0ZVhZLCBmYXIgKiBmbG9hdCgxLjAgLSBuZWFyIC8gZGVwdGhGcm9tQ2FtZXJhKSAvIGZsb2F0KGZhciAtIG5lYXIpLCAxLjApOwogIHZlYzQgZXllQ29vcmRpbmF0ZSA9IHdpbmRvd1RvRXllQ29vcmRpbmF0ZXNJblZpZGVvMih3aW5kb3dDb29yZCk7CiAgZXllQ29vcmRpbmF0ZS53ID0gMS4wIC8gZGVwdGhGcm9tQ2FtZXJhOyAKICByZXR1cm4gZXllQ29vcmRpbmF0ZTsKICAjZWxzZQogIHZlYzQgd2luZG93Q29vcmQgPSB2ZWM0KGZyYWdtZW50Q29vcmRpbmF0ZVhZLCBkZXB0aE9yTG9nRGVwdGgsIDEuMCk7CiAgdmVjNCBleWVDb29yZGluYXRlID0gd2luZG93VG9FeWVDb29yZGluYXRlc0luVmlkZW8yKHdpbmRvd0Nvb3JkKTsKICAjZW5kaWYKICByZXR1cm4gZXllQ29vcmRpbmF0ZTsKfQp2ZWMzIHZpZGVvQ2FtZXJhQ2xpcFRvUmVsYXRpdmVXb3JsZChmbG9hdCB1LGZsb2F0IHYpIAp7CiAgdmVjMiB1diA9IHZlYzIodSx2KTsKICBmbG9hdCBkZXB0aCA9IGN6bV91bnBhY2tEZXB0aCh0ZXh0dXJlMkQodV92aWRlb0NhbWVyYURlcHRoVGV4dHVyZSwgdXYpKTsKICB2ZWM0IGV5ZUNvb3JkaW5hdGUgPSB3aW5kb3dUb0V5ZUNvb3JkaW5hdGVzSW5WaWRlbyh1dip1X3ZpZGVvVmlld3BvcnQuencsIGRlcHRoKTsKICB2ZWM0IHdvcmxkQ29vcmRpbmF0ZTQgPSB1X3ZpZGVvSW52ZXJzZVZpZXdSZWxhdGl2ZSAqIGV5ZUNvb3JkaW5hdGU7CiAgdmVjMyB3b3JsZFBvc2l0aW9uID0gd29ybGRDb29yZGluYXRlNC54eXogLyB3b3JsZENvb3JkaW5hdGU0Lnc7CiAgcmV0dXJuIHdvcmxkUG9zaXRpb247Cn0KdmVjMyByZ2IyaHN2KHZlYzMgYykKewp2ZWM0IEsgPSB2ZWM0KDAuMCwgLTEuMC8zLjAsIDIuMC8zLjAsIC0xLjApOwp2ZWM0IHAgPSBtaXgodmVjNChjLmJnLCBLLnd6KSwgdmVjNChjLmdiLCBLLnh5KSwgc3RlcChjLmIsIGMuZykpOwp2ZWM0IHEgPSBtaXgodmVjNChwLnh5dywgYy5yKSwgdmVjNChjLnIsIHAueXp4KSwgc3RlcChwLngsIGMucikpOwpmbG9hdCBkID0gcS54IC0gbWluKHEudywgcS55KTsKZmxvYXQgZSA9IDEuMGUtMTA7CnJldHVybiB2ZWMzKGFicyhxLnogKyAocS53IC0gcS55KS8oNi4wKmQrZSkpLCBkLyhxLnggKyBlKSwgcS54KTsKfQp2ZWMzIGhzdjJyZ2IodmVjMyBjKQp7CnZlYzQgSyA9IHZlYzQoMS4wLCAyLjAvMy4wLCAxLjAvMy4wLCAzLjApOwp2ZWMzIHAgPSBhYnMoZnJhY3QoYy54eHggKyBLLnh5eikgKiA2LjAgLSBLLnd3dyk7CnJldHVybiBjLnogKiBtaXgoSy54eHgsIGNsYW1wKHAgLSBLLnh4eCwgMC4wLCAxLjApLCBjLnkpOwp9CnZvaWQgbWFpbih2b2lkKXsKZmxvYXQgZGVwdGggPSBjem1fdW5wYWNrRGVwdGgodGV4dHVyZTJEKGRlcHRoVGV4dHVyZSwgdl90ZXh0dXJlQ29vcmRpbmF0ZXMpKTsKZ2xfRnJhZ0NvbG9yID0gdGV4dHVyZTJEKGNvbG9yVGV4dHVyZSwgdl90ZXh0dXJlQ29vcmRpbmF0ZXMpOwp2ZWM0IGNsaXBDb2xvciA9IHRleHR1cmUyRCh1X2NsaXBQbGFuZUNvbG9yVGV4dHVyZSwgdl90ZXh0dXJlQ29vcmRpbmF0ZXMpOwojaWZkZWYgQ1pNX1NFTEVDVEVEX0ZFQVRVUkUKZmxvYXQgcGFkeCA9IGN6bV9waXhlbFJhdGlvIC8gY3ptX3ZpZXdwb3J0Lno7CmZsb2F0IHBhZHkgPSBjem1fcGl4ZWxSYXRpbyAvIGN6bV92aWV3cG9ydC53OwppZihjem1fc2VsZWN0ZWQodmVjMihwYWR4LCBwYWR5KSkpewpyZXR1cm47Cn0KI2VuZGlmCmlmKGRlcHRoPjAuMCl7CnZlYzMgd29ybGRQb3MgPSBjbGlwVG9SZWxhdGl2ZVdvcmxkKHZfdGV4dHVyZUNvb3JkaW5hdGVzLngsIHZfdGV4dHVyZUNvb3JkaW5hdGVzLnkpOwp2ZWM0IHJlYWxXb3JsZFBvcyA9IHZlYzQod29ybGRQb3MueCArIHVfcmVsYXRpdmVQb3MueCwgd29ybGRQb3MueSArIHVfcmVsYXRpdmVQb3MueSwgd29ybGRQb3MueiArIHVfcmVsYXRpdmVQb3MueiwgMS4wKTsKdmVjNCBwcm9qZWN0UHRJblZpZGVvID0gdV92aWRlb1ZpZXdQcm9qZWN0aW9uUmVsYXRpdmUgKiByZWFsV29ybGRQb3M7CnByb2plY3RQdEluVmlkZW8gPSBwcm9qZWN0UHRJblZpZGVvL3Byb2plY3RQdEluVmlkZW8udzsKaWYocHJvamVjdFB0SW5WaWRlby54ID49LTEuMCAmJiBwcm9qZWN0UHRJblZpZGVvLnggPD0gMS4wCiYmIHByb2plY3RQdEluVmlkZW8ueSA+PS0xLjAgJiYgcHJvamVjdFB0SW5WaWRlby55IDw9IDEuMAomJiBwcm9qZWN0UHRJblZpZGVvLnogPj0wLjAgJiYgcHJvamVjdFB0SW5WaWRlby56IDw9IDEuMCl7CnZlYzIgdGV4Q29vcmQgPSB2ZWMyKDAuNSwgMC41KSArIHByb2plY3RQdEluVmlkZW8ueHkgKiAwLjU7Ci8vSW52ZXJzZSBjYWxjdWxhdGlvbiBvZiB3b3JsZCBjb29yZGluYXRlcyByZWxhdGl2ZSB0byB0aGUgdmlkZW8gY2FtZXJhLiBhZGRlZCBieSB6YWsgMjAyMS4yLjE5IAppZih1X2RlcHRoVHlwZT4yLjUgJiYgdV9kZXB0aFR5cGU8My41KXsKICAgdmVjMyB3b3JsZFB0SW5WaWRlb0NhbWVyYSA9IHZpZGVvQ2FtZXJhQ2xpcFRvUmVsYXRpdmVXb3JsZCh0ZXhDb29yZC54LCB0ZXhDb29yZC55KTsgICAKICAgZmxvYXQgZGlzID0gZGlzdGFuY2UocmVhbFdvcmxkUG9zLnh5eiwgd29ybGRQdEluVmlkZW9DYW1lcmEpOwogICBpZihkaXMgPiAxLjApewogIAkgIHJldHVybjsKICAgfQp9CmZsb2F0IG1heFdpZHRoSGVpZ2h0ID0gdGV4dHVyZVdpZHRoOwpmbG9hdCBwZXJjZW50ID0gdGV4dHVyZUhlaWdodCAvIHRleHR1cmVXaWR0aDsKdmVjMiBjZW50ZXJVViA9IHZlYzIoKHRleHR1cmVXaWR0aCAvIDIuMCkgLyBtYXhXaWR0aEhlaWdodCwgKHRleHR1cmVIZWlnaHQgLyAyLjApIC8gbWF4V2lkdGhIZWlnaHQpOwp2ZWMyIGN1cnJlbnRVViA9IHZlYzIodGV4Q29vcmQueCwgdGV4Q29vcmQueSAqIHBlcmNlbnQpOwpmbG9hdCBsZW5ndGhfMiA9IChjdXJyZW50VVYueCAtIGNlbnRlclVWLngpICogKGN1cnJlbnRVVi54IC0gY2VudGVyVVYueCkgKyAoY3VycmVudFVWLnkgLSBjZW50ZXJVVi55KSAqIChjdXJyZW50VVYueSAtIGNlbnRlclVWLnkpOwpmbG9hdCBsZW5ndGhfNCA9IGxlbmd0aF8yICogbGVuZ3RoXzI7CnRleENvb3JkLnggPSAoY3VycmVudFVWLnggLSBjZW50ZXJVVi54KSAvIChrMSAqIGxlbmd0aF8yICsgazIgKiBsZW5ndGhfNCArIDEuMCkgKyBjZW50ZXJVVi54Owp0ZXhDb29yZC55ID0gKGN1cnJlbnRVVi55IC0gY2VudGVyVVYueSkgLyAoazEgKiBsZW5ndGhfMiArIGsyICogbGVuZ3RoXzQgKyAxLjApICsgY2VudGVyVVYueTsKdGV4Q29vcmQueSA9IHRleENvb3JkLnkgLyBwZXJjZW50Owp2ZWM0IHZpZGVvQ29sb3IgPSB0ZXh0dXJlMkQodV92aWRlb0NvbG9yVGV4dHVyZSwgdGV4Q29vcmQpOwp2ZWMzIHJnYiA9IHZpZGVvQ29sb3IueHl6Owp2ZWMzIGhzdiA9IHJnYjJoc3YocmdiKTsKaHN2ICs9IHVfaHN2OwpyZ2IgPSBoc3YycmdiKGhzdik7CnJnYiA9IGNsYW1wKHJnYiwgMC4wLCAxLjApOwp2aWRlb0NvbG9yLnh5eiA9IHJnYjsKaWYodV9wcm9qZWN0TW9kZT4wLjUgJiYgdV9wcm9qZWN0TW9kZTwxLjUpewpnbF9GcmFnQ29sb3IgPSAoMS4wIC0gdV9hbHBoYSkgKiBnbF9GcmFnQ29sb3IgKyB1X2FscGhhICogdmlkZW9Db2xvcjsKfWVsc2UgaWYodV9wcm9qZWN0TW9kZT4xLjUgJiYgdV9wcm9qZWN0TW9kZTwyLjUpewppZihjem1fZXF1YWxzRXBzaWxvbih1X2NsaXBQbGFuZUNvbG9yLnIsIGNsaXBDb2xvci5yLCAwLjAwMSkgJiYgY3ptX2VxdWFsc0Vwc2lsb24odV9jbGlwUGxhbmVDb2xvci5nLCBjbGlwQ29sb3IuZywgMC4wMDEpICYmCmN6bV9lcXVhbHNFcHNpbG9uKHVfY2xpcFBsYW5lQ29sb3IuYiwgY2xpcENvbG9yLmIsIDAuMDAxKSl7CmdsX0ZyYWdDb2xvciA9ICgxLjAgLSB1X2FscGhhKSAqIGdsX0ZyYWdDb2xvciArIHVfYWxwaGEgKiB2aWRlb0NvbG9yOwogIH0KfWVsc2UgaWYodV9wcm9qZWN0TW9kZT4yLjUgJiYgdV9wcm9qZWN0TW9kZTwzLjUpewpnbF9GcmFnQ29sb3IgPSAoMS4wIC0gdV9hbHBoYSkgKiBnbF9GcmFnQ29sb3IgKyB1X2FscGhhICogdmlkZW9Db2xvcjsKfQogIH0KfQp9Cg=="),uniforms:{u_videoColorTexture:function(){return t._videoTexture},u_depthType:function(){return t._depthType},u_videoCameraDepthTexture:function(){return Cesium.defined(t.videoView.globeDepth._depthStencilTexture)?t.videoView.globeDepth._depthStencilTexture:t._scene.view.globeDepth._depthStencilTexture},u_videoViewProjectionRelative:function(){var e=Cesium.Matrix4.setTranslation(t.videoCamera.viewMatrix,new Cesium.Cartesian3,new Cesium.Matrix4);return t.videoViewProjectionMat4=Cesium.Matrix4.multiply(t.videoCamera.frustum.projectionMatrix,e,new Cesium.Matrix4),t.videoViewProjectionMat4},u_videoInverseViewRelative:function(){return t.videoUniform.videoInverseViewRelative},u_log2FarDepthFromNearPlusOneInVideo:function(){return t.videoUniform.log2FarDepthFromNearPlusOneInVideo},u_videoFrustum:function(){return t.videoUniform.videoFrustum},u_videoViewport:function(){return t.videoUniform.videoViewport},u_videoViewportTransformation:function(){return t.videoUniform.videoViewportTransformation},u_videoInverseProjection:function(){return t.videoUniform.videoInverseProjection},u_videoFrustumPlanes:function(){return t.videoUniform.videoFrustumPlanes},u_relativePos:function(){return Cesium.defined(t._mainCamera)&&Cesium.defined(t.videoCamera)?Cesium.Cartesian3.subtract(t._mainCamera.positionWC,t.videoCamera.positionWC,new Cesium.Cartesian3):new Cesium.Cartesian3},u_sceneInverseViewRelative:function(){var e=Cesium.Matrix4.setTranslation(t._mainCamera.viewMatrix,new Cesium.Cartesian3,new Cesium.Matrix4);return Cesium.Matrix4.inverse(e,new Cesium.Matrix4)},u_alpha:function(){return t.videoAlpha},u_hsv:function(){return t.videoHsv},u_clipPlaneColorTexture:function(){return t.clipPlaneTexture},u_clipPlaneColor:function(){return t.clipPlaneColor},u_projectMode:function(){return t._projectMode},u_pureColor:function(){return t._pureColor},k1:function(){return t._k1},k2:function(){return t._k2},textureWidth:function(){return Cesium.defined(t._videoTexture)?t._videoTexture.width:0},textureHeight:function(){return Cesium.defined(t._videoTexture)?t._videoTexture.height:0}},type:t,preUpdateFunction:_e}),t._viewer.scene.postProcessStages.add(t._videoStage),t._videoStage.enabled=!1)},ve.prototype.updateClipPlaneFramebuffer=function(e,t){this.clipPlaneFramebuffer=e,this.clipPlaneTexture=t;for(var i=0;i<this.projectionPlanes.length;i++)this.projectionPlanes[i].framebuffer=e},ve.prototype.delayAdjustVideoCamera=function(d,h,c,e){var m,t;!this.videoCamera||this.delayPan===d&&this.delayTilt===h&&this.delayZoom===c||(this.delayPan=d,this.delayTilt=h,this.delayZoom=c,m=this,t=setTimeout(function(){var e,t,i,n,r,o,s,a,u,l;t=d,i=h,n=c,0!==(e=m)._delayTimerArray.length&&(clearTimeout(e._delayTimerArray[0]),e._delayTimerArray.shift()),e.videoCamera&&(r=parseFloat(t),o=parseFloat(i),s=parseFloat(n),Math.abs(r-e.panCurrent)<1e-5&&Math.abs(o-e.tiltCurrent)<1e-5&&Math.abs(s-e.zoomCurrent)<1e-5||(e.panCurrent=r,e.tiltCurrent=o,e.zoomCurrent=s,a=e._heading+(r-e._panPos),u=e._pitch-(o-e._tiltPos),e.videoCamera.setView({orientation:{heading:Cesium.Math.toRadians(a),pitch:Cesium.Math.toRadians(u),roll:Cesium.Math.toRadians(e._roll)}}),(l=e.videoCamera.frustum).fov=Cesium.Math.toRadians(e._fov*Math.sqrt(e._zoomPos/e.zoomCurrent)),l.aspectRatio=e._videoTexture._width/e._videoTexture._height,l.near=e._nearClip,l.far=e._farClip,l._fovy=l.aspectRatio<=1?l.fov:2*Math.atan(Math.tan(.5*l.fov)/l.aspectRatio),l._fovy=l._fovy*Math.sqrt(e._zoomPos/e.zoomCurrent),l.top=l.near*Math.tan(.5*l._fovy),l.bottom=-l.top,l.right=l.aspectRatio*l.top,l.left=-l.right,e.followCamera()))},e),this._delayTimerArray.push(t))},ve.prototype.setPTZViewPoint=function(e){var t,i,n,r,o;this.videoCamera&&this._wsplayer&&(t=new Cesium.Cartesian4(e.x,e.y,e.z,1),Cesium.Matrix4.multiplyByVector(this.videoCamera.viewMatrix,t,t),Cesium.Cartesian3.normalize(t,t),i=Math.asin(t.y),n=Math.asin(t.x/Math.cos(i)),r=this.panCurrent+180*n/Math.PI,o=this.tiltCurrent-180*i/Math.PI,360<r?r-=360:r<0&&(r+=360),this._wsplayer.setPTZPosition(r,o,this.zoomCurrent))},ve.prototype.followCamera=function(){var e,t,i,n,r,o,s,a,u,l=this;l.videoCamera&&l._follow&&l._wsplayer&&(e=l.videoCamera.position,t=l.videoCamera.heading,i=l.videoCamera.pitch,n=l.videoCamera.roll,r=1e-8,Math.abs(e.x-this.targetPosition.x)<r&&Math.abs(e.y-this.targetPosition.y)<r&&Math.abs(e.z-this.targetPosition.z)<r&&Math.abs(t-this.targetOrientation.x)<r&&Math.abs(this.targetOrientation.y-i)<r&&Math.abs(this.targetOrientation.z-n)<r&&Math.abs(targetZoom-l.zoomCurrent)<r||(o=new Cesium.Ray(l.videoCamera.position,l.videoCamera.direction),a=e,(s=l._viewer.scene.pickFromRay(o))&&s.position&&(u=Cesium.Cartesian3.distance(l.videoCamera.position,s.position),this.targetZoom=l.zoomCurrent,u*=1-1/l.zoomCurrent,a=Cesium.Ray.getPoint(o,u,new Cesium.Cartesian3)),this.targetPosition=a,this.targetOrientation.x=t,this.targetOrientation.y=i,this.targetOrientation.z=n,l._viewer.camera.setView({destination:a,orientation:{heading:this.targetOrientation.x,pitch:this.targetOrientation.y,roll:this.targetOrientation.z}})))},ve.prototype.incompatibleConsole=function(){var e=this;this._viewer.scene.renderError.addEventListener(function(){e._videoElement.paused||e._videoElement.pause(),e._viewer.cesiumWidget.showErrorPanel("This browser does not support cross-origin WebGL video textures.","","")})},ve.prototype.destroy=function(){this._scene.postProcessStages.remove(this._videoStage);for(var e=0;e<this.projectionPlanes.length;e++)this.projectionPlanes[e]!==this._scene._frameState.context.defaultTexture&&this.projectionPlanes[e].destroy();return this._videoTexture.destroy(),this._videoTexture=void 0,this.projectionPlanes=[],Cesium.destroyObject(this)},Object.defineProperties(be.prototype,{filterPrimitives:{get:function(){return this._filterPrimitives}}}),be.prototype.createVideoProjection=function(e){var t=this._videoProjections.length+1;e.clipPlaneFramebuffer=this.framebuffer,e.clipPlaneColor=Cesium.Color.fromRgba(t),e.clipPlaneColor.alpha=1,e.clipPlaneTexture=this.clipPlaneTexture,e.pureColor=new Cesium.Color(0,1,0,1),e.filterPrimitives=this.filterPrimitives,e.cachedFilterFeatures=this._cachedFilterFeatures,e.width=this._width,e.height=this._height;var i=new ve(e);return this._videoProjections.push(i),i},be.prototype.updateVideoCamera=function(e,t,i,n){for(var r=0;r<this._videoProjections.length;r++){var o=this._videoProjections[r];if(o._videoElement.id===e)return void o.delayAdjustVideoCamera(t,i,n,o._ptzDelay)}},be.prototype.preRender=function(e){var t=e.frameState.context,i=(e.frameState.commandList,t.canvas);if(i.width!==this._width||i.height!==this._height){this._width=i.width,this._height=i.height,this.framebuffer=this.framebuffer&&this.framebuffer.destroy(),this.clipPlaneTexture=new Cesium.Texture({context:t,width:this._width,height:this._height,pixelFormat:Cesium.PixelFormat.RGBA,sampler:Cesium.Sampler.NEAREST}),this.framebuffer=new Cesium.Framebuffer({context:t,colorTextures:[this.clipPlaneTexture],destroyAttachments:!1}),this._clearCommand.framebuffer=this.framebuffer;for(var n=0;n<this._videoProjections.length;n++)this._videoProjections[n].updateClipPlaneFramebuffer(this.framebuffer,this.clipPlaneTexture)}for(n=0;n<this._videoProjections.length;n++)this._videoProjections[n].preRender();this._clearCommand.execute(t)},be.prototype.addFilter3DTileId=function(e){-1==this.filterPrimitives.cesium3DTileIds.indexOf(e)&&this.filterPrimitives.cesium3DTileIds.push(e)},be.prototype.removeFilter3DTileId=function(e){this.filterPrimitives.cesium3DTileIds.splice(this.filterPrimitives.cesium3DTileIds.indexOf(e),1)},be.prototype.addFilter3DTileName=function(e){-1==this.filterPrimitives.cesium3DTileNames.indexOf(e)&&this.filterPrimitives.cesium3DTileNames.push(e)},be.prototype.removeFilter3DTileName=function(e){this.filterPrimitives.cesium3DTileNames.splice(this.filterPrimitives.cesium3DTileNames.indexOf(e),1)},be.prototype.addFilterEntity=function(e){Cesium.defined(e)&&-1==this.filterPrimitives.entityIds.indexOf(e.id)&&this.filterPrimitives.entityIds.push(e.id)},be.prototype.removeFilterEntity=function(e){Cesium.defined(e)&&this.filterPrimitives.entityIds.splice(this.filterPrimitives.entityIds.indexOf(e.id),1)},be.prototype.getComponentsInVideoCamera=function(e,t){for(var i=void 0,n=this._videoProjections.length,r=0;r<n;r++)if(e==this._videoProjections[r].name){i=this._videoProjections[r];break}var o,s,a=[];return Cesium.defined(i)&&(s=(o=i.videoCamera).frustum.computeCullingVolume(o.positionWC,o.directionWC,o.upWC),a=t.getComponentsInCullingVolume(s)),a},be.prototype.destroy=function(){this._scene.preRender.removeEventListener(this.preRender,this);for(var e=this._videoProjections.length,t=0;t<e;t++)this._videoProjections[t].destroy();this.framebuffer=this.framebuffer&&this.framebuffer.destroy(),this.clipPlaneTexture=this.clipPlaneTexture&&this.clipPlaneTexture.destroy(),this.framebuffer=void 0,this.clipPlaneTexture=void 0,this._videoProjections=[]},Ie.prototype.getProjections=function(){return this._videoProjectionArray},Ie.prototype.getPlaneProjections=function(){return this._videoPlaneArray},Ie.prototype.getModelProjections=function(){return this._videoModelArray},Object.defineProperties(Ie.prototype,{readyPromise:{get:function(){return this._readyPromise.promise}},videoFusionArray:{get:function(){return this._videoProjectionArray}},visibleDistance:{get:function(){return this._visibleDistance},set:function(e){this._visibleDistance=e}},name:{get:function(){return this._name},set:function(e){this._name=e}},show:{get:function(){return this._show},set:function(e){this._show=e;for(var t=0;t<this._videoProjectionArray.length;t++)this._videoProjectionArray[t]._show=e}},boundingSphere:{get:function(){return this._boundingSphere}}}),Ie.prototype.destroy=function(){for(var e=0;e<this._videoProjectionArray.length;e++)document.body.removeChild(this._videoProjectionArray[e]._videoElement),this._videoProjectionArray[e].destroy();this.ev_VideoProjectionManager.destroy()};e.EV_ProjectionPlane=n,e.EV_VideoFusion=me,e.EV_VideoLayer=Ie,e.EV_VideoProjection=ve,e.EV_VideoProjectionFS="varying vec2 v_textureCoordinates;\nuniform sampler2D colorTexture;\nuniform sampler2D depthTexture;\nuniform vec3 u_relativePos;\nuniform mat4 u_sceneInverseViewRelative;\nuniform sampler2D u_videoColorTexture;\nuniform sampler2D u_videoCameraDepthTexture;\nuniform mat4 u_videoViewProjectionRelative;\nuniform mat4 u_videoInverseViewRelative;\nuniform float u_log2FarDepthFromNearPlusOneInVideo;\nuniform vec2 u_videoFrustum;\nuniform vec4 u_videoViewport;\nuniform mat4 u_videoViewportTransformation; \nuniform mat4 u_videoInverseProjection; \nuniform vec4 u_videoFrustumPlanes;\nuniform float u_depthType;\nuniform float u_alpha;\nuniform vec3 u_hsv;\nuniform sampler2D u_clipPlaneColorTexture;\nuniform vec4 u_clipPlaneColor;\nuniform float u_projectMode;\nuniform vec4 u_pureColor;\nuniform float k1;\nuniform float k2;\nuniform float textureWidth;\nuniform float textureHeight;\nvec3 clipToRelativeWorld(float u,float v)\n{\nvec2 uv = vec2(u,v);\nfloat depth = czm_unpackDepth(texture2D(depthTexture, uv));\nvec4 eyeCoordinate = czm_windowToEyeCoordinates(uv*czm_viewport.zw, depth);\nvec4 worldCoordinate4 = u_sceneInverseViewRelative * eyeCoordinate;\nvec3 worldPosition = worldCoordinate4.xyz / worldCoordinate4.w;\nreturn worldPosition;\n}\nvec4 windowToEyeCoordinatesInVideo2(vec4 fragmentCoordinate)\n{\n    float x = 2.0 * (fragmentCoordinate.x - u_videoViewport.x) / u_videoViewport.z - 1.0;\n    float y = 2.0 * (fragmentCoordinate.y - u_videoViewport.y) / u_videoViewport.w - 1.0;\n    float z = (fragmentCoordinate.z - u_videoViewportTransformation[3][2]) / u_videoViewportTransformation[2][2];\n    vec4 q = vec4(x, y, z, 1.0);\n    q = q/fragmentCoordinate.w;\n    if (!(u_videoInverseProjection == mat4(0.0))) \n    {\n        q = u_videoInverseProjection * q;\n    }\n    else\n    {\n        float top = u_videoFrustumPlanes.x;\n        float bottom = u_videoFrustumPlanes.y;\n        float left = u_videoFrustumPlanes.z;\n        float right = u_videoFrustumPlanes.w;\n        float near = u_videoFrustum.x;\n        float far = u_videoFrustum.y;\n        q.x = (q.x * (right - left) + left + right) * 0.5;\n        q.y = (q.y * (top - bottom) + bottom + top) * 0.5;\n        q.z = (q.z * (near - far) - near - far) * 0.5;\n        q.w = 1.0;\n    }\n    return q;\n}\nvec4 windowToEyeCoordinatesInVideo(vec2 fragmentCoordinateXY, float depthOrLogDepth) \n{\n  #ifdef LOG_DEPTH\n  float near = u_videoFrustum.x;\n  float far = u_videoFrustum.y;\n  float log2Depth = depthOrLogDepth * u_log2FarDepthFromNearPlusOneInVideo;\n  float depthFromNear = pow(2.0, log2Depth) - 1.0;\n  float depthFromCamera = depthFromNear + near;\n  vec4 windowCoord = vec4(fragmentCoordinateXY, far * float(1.0 - near / depthFromCamera) / float(far - near), 1.0);\n  vec4 eyeCoordinate = windowToEyeCoordinatesInVideo2(windowCoord);\n  eyeCoordinate.w = 1.0 / depthFromCamera; \n  return eyeCoordinate;\n  #else\n  vec4 windowCoord = vec4(fragmentCoordinateXY, depthOrLogDepth, 1.0);\n  vec4 eyeCoordinate = windowToEyeCoordinatesInVideo2(windowCoord);\n  #endif\n  return eyeCoordinate;\n}\nvec3 videoCameraClipToRelativeWorld(float u,float v) \n{\n  vec2 uv = vec2(u,v);\n  float depth = czm_unpackDepth(texture2D(u_videoCameraDepthTexture, uv));\n  vec4 eyeCoordinate = windowToEyeCoordinatesInVideo(uv*u_videoViewport.zw, depth);\n  vec4 worldCoordinate4 = u_videoInverseViewRelative * eyeCoordinate;\n  vec3 worldPosition = worldCoordinate4.xyz / worldCoordinate4.w;\n  return worldPosition;\n}\nvec3 rgb2hsv(vec3 c)\n{\nvec4 K = vec4(0.0, -1.0/3.0, 2.0/3.0, -1.0);\nvec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\nvec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));\nfloat d = q.x - min(q.w, q.y);\nfloat e = 1.0e-10;\nreturn vec3(abs(q.z + (q.w - q.y)/(6.0*d+e)), d/(q.x + e), q.x);\n}\nvec3 hsv2rgb(vec3 c)\n{\nvec4 K = vec4(1.0, 2.0/3.0, 1.0/3.0, 3.0);\nvec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\nreturn c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\n}\nvoid main(void){\nfloat depth = czm_unpackDepth(texture2D(depthTexture, v_textureCoordinates));\ngl_FragColor = texture2D(colorTexture, v_textureCoordinates);\nvec4 clipColor = texture2D(u_clipPlaneColorTexture, v_textureCoordinates);\n#ifdef CZM_SELECTED_FEATURE\nfloat padx = czm_pixelRatio / czm_viewport.z;\nfloat pady = czm_pixelRatio / czm_viewport.w;\nif(czm_selected(vec2(padx, pady))){\nreturn;\n}\n#endif\nif(depth>0.0){\nvec3 worldPos = clipToRelativeWorld(v_textureCoordinates.x, v_textureCoordinates.y);\nvec4 realWorldPos = vec4(worldPos.x + u_relativePos.x, worldPos.y + u_relativePos.y, worldPos.z + u_relativePos.z, 1.0);\nvec4 projectPtInVideo = u_videoViewProjectionRelative * realWorldPos;\nprojectPtInVideo = projectPtInVideo/projectPtInVideo.w;\nif(projectPtInVideo.x >=-1.0 && projectPtInVideo.x <= 1.0\n&& projectPtInVideo.y >=-1.0 && projectPtInVideo.y <= 1.0\n&& projectPtInVideo.z >=0.0 && projectPtInVideo.z <= 1.0){\nvec2 texCoord = vec2(0.5, 0.5) + projectPtInVideo.xy * 0.5;\n//Inverse calculation of world coordinates relative to the video camera. added by zak 2021.2.19 \nif(u_depthType>2.5 && u_depthType<3.5){\n   vec3 worldPtInVideoCamera = videoCameraClipToRelativeWorld(texCoord.x, texCoord.y);   \n   float dis = distance(realWorldPos.xyz, worldPtInVideoCamera);\n   if(dis > 1.0){\n  \t  return;\n   }\n}\nfloat maxWidthHeight = textureWidth;\nfloat percent = textureHeight / textureWidth;\nvec2 centerUV = vec2((textureWidth / 2.0) / maxWidthHeight, (textureHeight / 2.0) / maxWidthHeight);\nvec2 currentUV = vec2(texCoord.x, texCoord.y * percent);\nfloat length_2 = (currentUV.x - centerUV.x) * (currentUV.x - centerUV.x) + (currentUV.y - centerUV.y) * (currentUV.y - centerUV.y);\nfloat length_4 = length_2 * length_2;\ntexCoord.x = (currentUV.x - centerUV.x) / (k1 * length_2 + k2 * length_4 + 1.0) + centerUV.x;\ntexCoord.y = (currentUV.y - centerUV.y) / (k1 * length_2 + k2 * length_4 + 1.0) + centerUV.y;\ntexCoord.y = texCoord.y / percent;\nvec4 videoColor = texture2D(u_videoColorTexture, texCoord);\nvec3 rgb = videoColor.xyz;\nvec3 hsv = rgb2hsv(rgb);\nhsv += u_hsv;\nrgb = hsv2rgb(hsv);\nrgb = clamp(rgb, 0.0, 1.0);\nvideoColor.xyz = rgb;\nif(u_projectMode>0.5 && u_projectMode<1.5){\ngl_FragColor = (1.0 - u_alpha) * gl_FragColor + u_alpha * videoColor;\n}else if(u_projectMode>1.5 && u_projectMode<2.5){\nif(czm_equalsEpsilon(u_clipPlaneColor.r, clipColor.r, 0.001) && czm_equalsEpsilon(u_clipPlaneColor.g, clipColor.g, 0.001) &&\nczm_equalsEpsilon(u_clipPlaneColor.b, clipColor.b, 0.001)){\ngl_FragColor = (1.0 - u_alpha) * gl_FragColor + u_alpha * videoColor;\n  }\n}else if(u_projectMode>2.5 && u_projectMode<3.5){\ngl_FragColor = (1.0 - u_alpha) * gl_FragColor + u_alpha * videoColor;\n}\n  }\n}\n}\n",e.EV_VideoProjectionManager=be,e.EV_VideoProjectionPlane=Ce,e.EV_VideoSynchronizerEx=ce,e.EV_WSPlayer=pe,e.VERSION="1.69",Object.defineProperty(e,"__esModule",{value:!0})});
