define(["./when-b43ff45e","./Check-d404a0fe","./Math-336da716","./Cartesian3-2b5b9afe","./Cartesian2-577f67dc","./Transforms-18f02e2b","./RuntimeError-bf10f3d5","./WebGLConstants-56de22c0","./JulianDate-53cdb307","./RequestType-beb1291d","./AttributeCompression-c335d1ea","./IndexDatatype-c5295474","./IntersectionTests-8ff35218","./Plane-5b30f0ff","./createTaskProcessorWorker","./EllipsoidTangentPlane-51ba1d6b","./OrientedBoundingBox-c229c76c","./Color-b5533cf2"],function(Be,e,Le,Oe,Ue,a,r,n,t,i,Pe,Fe,o,s,f,d,Re,Se){"use strict";var De=new Oe.Cartesian3,Me=new Ue.Ellipsoid,_e=new Ue.Rectangle,Ge={min:void 0,max:void 0,indexBytesPerElement:void 0};function Ye(e,a,r){var n=a.length,t=2+n*Re.OrientedBoundingBox.packedLength+1+function(e){for(var a=e.length,r=0,n=0;n<a;++n)r+=Se.Color.packedLength+3+e[n].batchIds.length;return r}(r),i=new Float64Array(t),o=0;i[o++]=e,i[o++]=n;for(var s=0;s<n;++s)Re.OrientedBoundingBox.pack(a[s],i,o),o+=Re.OrientedBoundingBox.packedLength;var f=r.length;i[o++]=f;for(var d=0;d<f;++d){var c=r[d];Se.Color.pack(c.color,i,o),o+=Se.Color.packedLength,i[o++]=c.offset,i[o++]=c.count;var u=c.batchIds,h=u.length;i[o++]=h;for(var l=0;l<h;++l)i[o++]=u[l]}return i}var Ve=new Oe.Cartesian3,He=new Oe.Cartesian3,We=new Oe.Cartesian3,qe=new Oe.Cartesian3,ze=new Oe.Cartesian3,Je=new Ue.Cartographic,Ze=new Ue.Rectangle;return f(function(e,a){var r,n,t;r=e.packedBuffer,n=new Float64Array(r),t=0,Ge.indexBytesPerElement=n[t++],Ge.min=n[t++],Ge.max=n[t++],Oe.Cartesian3.unpack(n,t,De),t+=Oe.Cartesian3.packedLength,Ue.Ellipsoid.unpack(n,t,Me),t+=Ue.Ellipsoid.packedLength,Ue.Rectangle.unpack(n,t,_e);var i,o=new(2===Ge.indexBytesPerElement?Uint16Array:Uint32Array)(e.indices),s=new Uint16Array(e.positions),f=new Uint32Array(e.counts),d=new Uint32Array(e.indexCounts),c=new Uint32Array(e.batchIds),u=new Uint32Array(e.batchTableColors),h=new Array(f.length),l=De,g=Me,p=_e,b=Ge.min,C=Ge.max,y=e.minimumHeights,I=e.maximumHeights;Be.defined(y)&&Be.defined(I)&&(y=new Float32Array(y),I=new Float32Array(I));var m=s.length/2,w=s.subarray(0,m),v=s.subarray(m,2*m);Pe.AttributeCompression.zigZagDeltaDecode(w,v);for(var x=new Float64Array(3*m),A=0;A<m;++A){var T=w[A],E=v[A],N=Le.CesiumMath.lerp(p.west,p.east,T/32767),k=Le.CesiumMath.lerp(p.south,p.north,E/32767),B=Ue.Cartographic.fromRadians(N,k,0,Je),L=g.cartographicToCartesian(B,Ve);Oe.Cartesian3.pack(L,x,3*A)}var O=f.length,U=new Array(O),P=new Array(O),F=0,R=0;for(A=0;A<O;++A)U[A]=F,P[A]=R,F+=f[A],R+=d[A];var S,D=new Float32Array(3*m*2),M=new Uint16Array(2*m),_=new Uint32Array(P.length),G=new Uint32Array(d.length),Y=[],V={};for(A=0;A<O;++A)i=u[A],Be.defined(V[i])?(V[i].positionLength+=f[A],V[i].indexLength+=d[A],V[i].batchIds.push(A)):V[i]={positionLength:f[A],indexLength:d[A],offset:0,indexOffset:0,batchIds:[A]};var H,W=0,q=0;for(i in V){V.hasOwnProperty(i)&&((S=V[i]).offset=W,S.indexOffset=q,W+=2*S.positionLength,q+=H=2*S.indexLength+6*S.positionLength,S.indexLength=H)}var z=[];for(i in V)V.hasOwnProperty(i)&&(S=V[i],z.push({color:Se.Color.fromRgba(parseInt(i)),offset:S.indexOffset,count:S.indexLength,batchIds:S.batchIds}));for(A=0;A<O;++A){var J=(S=V[i=u[A]]).offset,Z=3*J,j=J,K=U[A],Q=f[A],X=c[A],$=b,ee=C;Be.defined(y)&&Be.defined(I)&&($=y[A],ee=I[A]);for(var ae=Number.POSITIVE_INFINITY,re=Number.NEGATIVE_INFINITY,ne=Number.POSITIVE_INFINITY,te=Number.NEGATIVE_INFINITY,ie=0;ie<Q;++ie){var oe=Oe.Cartesian3.unpack(x,3*K+3*ie,Ve);g.scaleToGeodeticSurface(oe,oe);var se=g.cartesianToCartographic(oe,Je),fe=se.latitude,de=se.longitude,ae=Math.min(fe,ae),re=Math.max(fe,re),ne=Math.min(de,ne),te=Math.max(de,te),ce=g.geodeticSurfaceNormal(oe,He),ue=Oe.Cartesian3.multiplyByScalar(ce,$,We),he=Oe.Cartesian3.add(oe,ue,qe),ue=Oe.Cartesian3.multiplyByScalar(ce,ee,ue),le=Oe.Cartesian3.add(oe,ue,ze);Oe.Cartesian3.subtract(le,l,le),Oe.Cartesian3.subtract(he,l,he),Oe.Cartesian3.pack(le,D,Z),Oe.Cartesian3.pack(he,D,Z+3),M[j]=X,M[j+1]=X,Z+=6,j+=2}(p=Ze).west=ne,p.east=te,p.south=ae,p.north=re,h[A]=Re.OrientedBoundingBox.fromRectangle(p,b,C,g);var ge=S.indexOffset,pe=P[A],be=d[A];for(_[A]=ge,ie=0;ie<be;ie+=3){var Ce=o[pe+ie]-K,ye=o[pe+ie+1]-K,Ie=o[pe+ie+2]-K;Y[ge++]=2*Ce+J,Y[ge++]=2*ye+J,Y[ge++]=2*Ie+J,Y[ge++]=2*Ie+1+J,Y[ge++]=2*ye+1+J,Y[ge++]=2*Ce+1+J}for(ie=0;ie<Q;++ie){var me=ie,we=(ie+1)%Q;Y[ge++]=2*me+1+J,Y[ge++]=2*we+J,Y[ge++]=2*me+J,Y[ge++]=2*me+1+J,Y[ge++]=2*we+1+J,Y[ge++]=2*we+J}S.offset+=2*Q,S.indexOffset=ge,G[A]=ge-_[A]}Y=Fe.IndexDatatype.createTypedArray(D.length/3,Y);for(var ve=z.length,xe=0;xe<ve;++xe){for(var Ae=z[xe].batchIds,Te=0,Ee=Ae.length,Ne=0;Ne<Ee;++Ne)Te+=G[Ae[Ne]];z[xe].count=Te}var ke=Ye(2===Y.BYTES_PER_ELEMENT?Fe.IndexDatatype.UNSIGNED_SHORT:Fe.IndexDatatype.UNSIGNED_INT,h,z);return a.push(D.buffer,Y.buffer,_.buffer,G.buffer,M.buffer,ke.buffer),{positions:D.buffer,indices:Y.buffer,indexOffsets:_.buffer,indexCounts:G.buffer,batchIds:M.buffer,packedBuffer:ke.buffer}})});
